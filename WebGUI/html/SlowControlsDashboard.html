<!DOCTYPE HTML>
<html lang="en">
	<head>
		<title>Slow Controls Dashboard</title>

		<link rel="stylesheet" type="text/css" href="/WebPath/css/SlowControlsDashboard.css">

		<script type="text/JavaScript" src="/WebPath/js/Globals.js"></script>
		<script type="text/JavaScript" src="/WebPath/js/Debug.js"></script>
		<script type="text/JavaScript" src="/WebPath/js/DesktopContent.js"></script>
		<script type="text/JavaScript" src="/WebPath/js/widgetLibrary.js"></script>
		<script type="text/JavaScript" src="/WebPath/js/js_lib/ConfigurationAPI.js"></script>
		<script type="text/JavaScript" src="/WebPath/js/js_lib/SlowControlsAPI.js"></script>

		<!-- MultiSelectBox: Must include .css style sheet and .js functionality -->
		<link rel="stylesheet" type="text/css" href="/WebPath/css/MultiSelectBox.css">
		<script type="text/JavaScript" src="/WebPath/js/js_lib/MultiSelectBox.js"></script>

		<script>

			//functions:
			//	init()
			//
			//	handleMouseDown(e)
			//	handleMouseUp(e)
			//	handleMouseMove(e)
			//	handleResize(e)
			//	redrawWindow(event, hover)
			//
			//	indicateUserActivityToServer()
			//
			//	--- BEGIN drawing widgets
			//
			//	drawWidget(widgetId, widgetType, xx, yy, width, height, hideFrame, alreadyInPageObject)
			//	toPageXCoordinate(x)
			//	toPageYCoordinate(y)
			//	toScaledXCoordinate(x)
			//	toScaledYCoordinate(y)
			//
			//	setupForDrawSelectionRectangle(id)
			//	drawSelectionRectangle(event)
			//	stopDragAndDrawRectangle(event)
			//
			//	startWidgetDrag(e,id)
			//	startWidgetResize(e,id)
			//	endWidgetDragAndResize(e,id)
			//
			//	redrawTargetWidget(e)
			//			
			//	--- END drawing widgets
			//
			//	openTabPage(e, id) 
			//	popWidgetOutOfTabBody()
			//	addWidgetToTabBody(id);
			//
			//	checkMailbox()
			//	handleMail(mail)
			//	pagesReqHandler(req)
			//	isUserAdminHandler(req)
			//	pvListReqHandler(req)
			//	loadPageReqHandler(req)
			//	loadPhoebusPageReqHandler(req)
			//	pollServerHandlerFunction(req)
			//	generateUIDHandlerFunction(req)
			//	settingsReqHandler(req, passParams)
			//	pvHistoryReqHandler(req, passParams)
			//	savePageReqHandler(req)
			//	createControlsPageHandler(req)
			//	handlerFunction(req)
			//	lastAlarmsReqHandler(req, passParams)
			//	getLastAlarms(id, parameters)
			//	pollServer()
			//	generateUID()
			//	updateRefreshInterval()
			//	loadPage(page)
			//	loadPhoebusPage(page)
			//	loadPageNewWindow(fullPathToPage)
			//	loadPageNewBrowserTab(fullPathToPage)
			//	createDesktopIcon(fullPathToPage)
			//	savePage()
			//	hidePopupSaveControlsPage()
			//	savePageAs()
			//	savePhoebusPageAs()
			//	setupWidget(id, parameters)
			//	setWidgetToolTip(pvName, pvValue, pvTime, pv_settings_)
			//	getPVHistory(id, parameters)
			//	addPVToWidget(pv, refreshRate, widgetID, fromAddPV)
			//	compareAttributes(id, parameters)
			//	mouseoverEditBlock(e)
			//	mouseoutEditBlock(e)
			//	toggleEditMode()
			//	makeHandlerWithID(id)
			//	toggleContextMenu(e, id)
			//	toggleContextMenuOff(e)
			//	toggleHotkeyMenu()
			//	toggleAddPV()
			//	toggleFileMenu()
			//	editWidgetAttributesOpen()
			//	editWidgetAttributesClose()
			//	editWidgetAttributesSave()
			//	editWidgetAttributesaddRowPVList(keyParam, valueParam, tablebody, list)
			//	checkIfMoreRowsNeeded(inputEl)
			//	setWidgetDisplayName(widget, displayName)
			//	showeditWidgetAttributesPopupBody(body)
			//	toggleGrid(on)
			//	setBackgroundColor(color)
			//	setGridColor(color, on)
			//	setGridSnap(snap)
			//	snapToGrid(value, gridSize)
			//	handleKeys(event)
			//	deleteWidget()
			//	cutWidget(widgetCover)
			//	pasteWidget()
			//	setEditModeWidgetTarget(target)	
			//	evaluateJS(str)
			//	setRefreshRate(keyField,rateField)
			//	isEmpty(obj)


			//top-level scope (global) variables:

			var page_ = page_ || {}; 	//define the page object if needed
										//	page_.widgets = {
										//		<widgetID> : <widget object := x, y, 
										//			w, h, pvList{}, attributes{},
										//			displayName, loaded,
										//			el /*iframe element*/
										//	} 

			//====================== start high-level behavior description
			//
			//	High-level description of page-widget interactions:
			//
			//	- widget's init() is called by 2: 
			//		1. widget's own onload() 
			//		2. top-level addPVToWidget()
			//	- In edit mode, user draws a widget square...		
			//		* immediately onload, widget should call init()
			//		* widget should call setupWidget() like this from init: 
			//				function init() { 	
			//					window.parent.setupWidget(window.frameElement.id, 
			//						getAttributes());   
			//				}
			//		* getAttributes() is defined by user widget and
			//			should describe user-editable fields for widget:
			//			- like { "param1" : "DEFAULT_VAL", "param2" : "" }
			//		* calling setupWidget() propagates parameters to the high-level page object
			//	- parent.setupWidget(): 
			//		* Note: this gets called by widget's init() (e.g. from onload)
			//		* setupWidget gives Top-level parameters that become user-editable
			//		* Then top-level gets PV settings (e.g. alarm thresholds) through server request based on widgets pvList
			//			and then propagates settings back to widget by calling... 
			//				- contentWindow.setupPVs(settings)
			//				- contentWindow.drawWidget(object)
			//	
			//
			//	- contentWindow.setupPVs(settings)
			//		* Pass alarm thresholds, etc associated with pvList to widget content
			//	- contentWindow.setAttributes(attributes)
			//		* Notify widget attributes have been changed
			//	- contentWindow.drawWidget(object, attributes)			
			//		* (re)Draw widget elements, based on attributes.
			//		* Note: called by window resize
			//
			//	Once we go Live, all widgets get PV values as available:
			//	- contentWindow.drawNewValue()
			//		* Update widget drawing based on new value (and append to history if needed)
			//
			//====================== end high-level behavior description

			var windowWidth_, windowHeight_;

			var pvList_ = {};
			var elPointer_ = {};
			var pagesList_ = [];
			var mainBlock_ = {name:"", isHidden:false, el:""}; // = ["mainBlock", false ];

			var PAGE_POSITIONS_ = 1000; //number of allowed integer locations (e.g. x,y,w,h for widgets) 
			var refreshRate_ = 15000; //set default to refresh every 15 seconds (ms)
			var timerVariable_;
			var lastAlarmsTimerVariable_;
			var alarmsLogTimerVariable_;
			var UID_ = 0;
			var timeToPoll_ = false;
			var hiddenWidth_;
			var unhiddenWidth_;
			var mailbox_;
			var ADMIN_PERMISSION_THRESHOLD = 255;
			var userPermission = 10;

			//==== BEGIN file pane:
			var fileBlock_ = {name:"", isHidden:false, el:"", savePopup:""}; // = ["fileBlock", false ];

			var FILE_BLOCK_WIDTH = 300;
			//==== END file pane


			//==== BEGIN edit pane:
			var editBlock_ = {name:"", isHidden:true, el:""}; // = [false ];

			var EDIT_BLOCK_PEEK_HEIGHT = 40;
			var EDIT_BLOCK_HEIGHT = 300;
			//==== END edit pane


			//==== BEGIN Context Menu
			var menuState_ = 0;
			var menu_;
			var menuDiv_;
			var activeMenu_ = "menu--active";
			//==== END Context Menu


			var WIDGET_TYPE_TEXT		= 0;
			var WIDGET_TYPE_TABLE		= 1;
			var WIDGET_TYPE_METER		= 2;
			var WIDGET_TYPE_CHART		= 3;
			var WIDGET_TYPE_XYCHART		= 4;
			var WIDGET_TYPE_THERMO		= 5;
			var WIDGET_TYPE_SIREN		= 6;
			var WIDGET_TYPE_LABEL		= 7;
			var WIDGET_TYPE_LED			= 8;
			var WIDGET_TYPE_PICTURE		= 9;
			var WIDGET_TYPE_2DLIGHTS	= 10;
			var WIDGET_TYPE_ROOT		= 11;
			var WIDGET_TYPE_TAB			= 12;
			var WIDGET_TYPE_NAVTAB		= 13;
			var WIDGET_TYPE_PROGRESS_BAR= 13;
			var WIDGET_TYPE_TANK		= 13;
			

			var nav_;
			var gridColor_;
			var gridSnap_;
			var addPVMenuDiv_;
			var addPVMenu_;
			var isReadOnly_;
			page_.createPage = function(){

				this.name = "MyPage";
				this.widgets = {};
				this.addPV = function(pv){
					console.log("Reached " + pv);
				}
			}

			//==== BEGIN Drag and Resize parameters
			var GRIDSIZE_ = 10;
			var xPos_;
			var yPos_;
			var drawingSelectionRectangle_ = false;
			var dragAndDrawTargetEl_ = undefined;			
			var dragAndDrawWidgetType_ = undefined;

			var resizeLockout_ = false;
			var resizeWidgetId_ = "";
			var resizeFrom_ = "";
			var saveCursorType_;

			var dragLockout_ = false;
			var targetElement_ = undefined;			
			var targetTabBodyId_ = undefined;

			var dragTimeout_ = 0;
			//==== END Drag and Resize

			var copyWidget_;
			var cutWidget_;
			var cutWidgetId_;
			var _tableUploadStr;
			var previousPage_ = "";
			var actualPage_ = "";

			var READ_ONLY_ = false;

			/////////////////////////////////////////////////////////////////////////////////////////
			/////////////////////////////////////////////////////////////////////////////////////////


			//=====================================================================================
			//init called once body has loaded
			function init() 
			{
				Debug.log("init() was called");

				var readOnlyMode = DesktopContent.getParameter(0, "readOnlyMode"); // for &readOnlyMode=1
				if (readOnlyMode !== undefined) //set read mode if parameter
				{
					Debug.log("Launching readonly mode to true!");
					READ_ONLY_ = true; //readOnlyMode | 0;     
				}

				//to make an icon on desktop -- DesktopContent.addDesktopIcon(iconName)


				window.onkeyup = handleKeys;
				window.onkeydown = makeHandlerWithID(true/*isKeyDown*/,handleKeys);
				window.onresize = handleResize;

				var parameterPageName = DesktopContent.getParameter(0,"page_name");				

				Debug.log("Parameter filename: " + parameterPageName);

				fileBlock_.el = document.getElementById('fileBlock');//red
				fileBlock_.savePopup = document.getElementById('popupSaveControlsPage');
				mainBlock_.el = document.getElementById('mainBlock');//yellow
				editBlock_.el = document.getElementById('editBlock');//green
				page_.createPage;
				widgetLibrary.init;

				fileBlock_.name = fileBlock_.el.id;
				mainBlock_.name = mainBlock_.el.id;
				editBlock_.name = editBlock_.el.id;

				var datalist = document.getElementById("pvDatalist");//document.createElement("datalist");
				isReadOnly_ = false;

				elPointer_["addPVMenu"] = document.getElementById("addPVMenu");
				elPointer_["addPVMenuDiv"] = document.getElementById("addPVMenuDiv");
				elPointer_["editWidgetAttributesPopup-body-pvlist"] = document.getElementById("editWidgetAttributesPopup-body-pvlist");
				elPointer_["editWidgetAttributesPopup-body-attributes"] = document.getElementById("editWidgetAttributesPopup-body-attributes");

				menuDiv_ = document.getElementById("contextMenuDiv");
				menu_= document.getElementById("contextMenu");
				mailbox_ = document.getElementById("mailbox");
				var myTimer = setInterval(checkMailbox, 1000);
				dragAndDrawWidgetType_ = undefined;

			 	DesktopContent.XMLHttpRequest(
                                	"Request?RequestType=getPages",
                                         "", 
                                         pagesReqHandler,
                                         0 /*reqParam*/, 
                                         0 /*progressHandler*/, 
                                         0 /*callHandlerOnErr*/, 
                                         true /*doNoShowLoadingOverlay*/);
				pagesList_ = "Loading";
				DesktopContent.XMLHttpRequest(
				                    "Request?RequestType=isUserAdmin",
				                    "",
				                    isUserAdminHandler);

				//get command string if opening a new window
				var cmdStr = DesktopContent.getParameter(2); //from  location.search
				if (cmdStr && cmdStr != "") {
					//do incoming commands!
					Debug.log("cmdStr=" + cmdStr);
					//replace %22 with "
					cmdStr = cmdStr.replace(/%22/g, "\"");
					//evaluateJS(cmdStr);
				}

				//get frame and set some text to loading
				var fileFrame = document.createElement("iframe");
				fileFrame.id = "fileFrame";
				fileFrame.src = "/WebPath/html/SlowControlsDashboardFileTree.html";
				fileFrame.style.height = "inherit";
				fileBlock_.el.style.width = FILE_BLOCK_WIDTH + "px";
				fileFrame.style.width = FILE_BLOCK_WIDTH + "px";
				fileBlock_.el.innerHTML = "";
				fileBlock_.el.style.border = "0";
				fileBlock_.el.appendChild(fileFrame);
				fileBlock_.isHidden = true;

				var editFrame = document.createElement("iframe");
				editFrame.id = "editFrame";
				editFrame.src = "/WebPath/html/SlowControlsDashboardEdit.html";
				editFrame.style.height = "inherit";
				editFrame.style.width = "inherit";
				editBlock_.el.innerHTML = "";
				editBlock_.el.style.border = "0";
				editBlock_.el.appendChild(editFrame);

				editBlock_.el.addEventListener("mouseover", mouseoverEditBlock, true);
				editBlock_.el.addEventListener("mouseleave", mouseoutEditBlock, true);

				//BEGIN JS Style
				mainBlock_.el.style["background-color"] = "rgb(255, 255, 255)";
				gridColor_ = "rgba(128, 128, 128, 0.3)"
				gridSnap_ = true;
				toggleGrid(true);
				console.log(("-" + fileBlock_.el.style.width));
				fileBlock_.el.style.left = "-4000px"; //hack because the file tree page probably didnt load by now
				editBlock_.el.style.bottom = "-4000px"; //hack because the edit page probably didnt load by now

				nav_ = document.getElementById("navigationMenu");
				nav_.classList.add("navigationMenu--active");
				//END JS Style

				Debug.log(parameterPageName);	

				//mainBlock_.el.removeEventListener("mousedown", startDrag, true);
				document.body.addEventListener("mousedown", handleMouseDown); //drawSelectionRectangle(id), false);
				document.body.addEventListener("mouseup", handleMouseUp);
				document.body.addEventListener("mousemove", handleMouseMove);

                handleResize(); //redraw window for first time

				if(parameterPageName == undefined)
			    {
                    toggleEditMode();
                }
                else
                {
                	Debug.log("Loading page from url");
                	//loadPage(parameterPageName);
                	loadPhoebusPage(parameterPageName);
                }
			} //end init()


			//=====================================================================================
			//indicate that login should be kept alive
			//	e.g. user is editing widgets in edit mode
			function indicateUserActivityToServer() 
			{
				Debug.log("indicateUserActivityToServer()");
				DesktopContent.XMLHttpRequest(
						"Request?RequestType=userActivityHeartbeat",
						"", 
						undefined /*returnHandler*/, 
						0 /*reqParam*/, 
						0 /*progressHandler*/, 
						0 /*callHandlerOnErr*/, 
						true /*doNoShowLoadingOverlay*/);	
			} //end indicateUserActivityToServer()


			//=====================================================================================
			function checkMailbox()
			{
				if(mailbox_.innerHTML != "")
				{
					Debug.log("There is new mail: " + mailbox_.innerHTML);
					var msg = mailbox_.innerHTML;
					mailbox_.innerHTML = "";
					handleMail(msg);
				}
			} //end checkMailbox()


			//=====================================================================================
			function handleMail(mail)
			{
                if(mail == "Save") {
                   savePage();
                }
                else
                {
                   Debug.log("Don't know what to do with mail: " + mail);
                }
			} //end  handleMail()


			//=====================================================================================
			function pagesReqHandler(req)
			{

				pagesList_ = []; //overwrite the loading text

				console.log(req.responseText);
				console.log(DesktopContent.getXMLValue(req, "JSON"));
				if(DesktopContent.getXMLValue(req, "JSON") != "[\"None\"]")
				{
					var pagesJSON = JSON.parse(DesktopContent.getXMLValue(req, "JSON"));
					for(var x in pagesJSON)
					{
						//console.log(pagesJSON[x]);
						pagesList_.push(pagesJSON[x]);
					}
				}
				else
				{	
					console.log("No pages found in server!");
				}
			} //end pagesReqHandler()


			//=====================================================================================
			function isUserAdminHandler(req)
			{
				Debug.log("getPermissionHandler() was called. " + req.responseText);//Req: " + req.responseText);

				isAdmin = JSON.parse(decodeURIComponent(DesktopContent.getXMLValue(req, "JSON")))["message"];
				console.log("User Permission: " + isAdmin);
				console.log(isAdmin);

				if(isAdmin == "Yes")
				{
					isReadOnly_ = false;
				}
				else
				{
					isReadOnly_ = true;
				}

				console.log("Interface isReadOnly=" + isReadOnly_);
				redrawWindow();
			} //end isUserAdminHandler()


			//=====================================================================================
			function pvListReqHandler(req)
			{
				console.log("pvListReqHandler: response received!");	
				console.log(req.responseText);
				var datalist = document.getElementById("pvDatalist");
				datalist.innerHTML = "";

				var jsonStr = DesktopContent.getXMLValue(req, "JSON");
				if(!jsonStr || jsonStr == "") return;				
				var pvListJSON;

				//if invalid JSON return
				//jsonStr.replace(/\"/g,"");
				try {pvListJSON = JSON.parse(jsonStr); }
				catch(e){console.log("Invalid JSON!"); return;}

				console.log(pvListJSON);
				for (var x in pvListJSON)
				{
					//pvList_[pvListJSON[x].substring(0,pvListJSON[x].indexOf(":"))] = pvListJSON[x].substring(pvListJSON[x].indexOf(":")+1,pvListJSON[x].length);
					pvList_[pvListJSON[x]] = refreshRate_;
					var option = document.createElement("option");
					//option.value = pvListJSON[x].substring(0,pvListJSON[x].indexOf(":"));
					option.value = pvListJSON[x];
					datalist.appendChild(option);
				}
			} //end pvListReqHandler()

			
			//=====================================================================================
			var PHOEBUS_MAP = {   "textupdate":	WIDGET_TYPE_TEXT
								, "table":		WIDGET_TYPE_TABLE
								, "meter":		WIDGET_TYPE_METER
								, "stripchart":	WIDGET_TYPE_CHART
								, "xyplot":		WIDGET_TYPE_XYCHART
								, "thermometer":WIDGET_TYPE_THERMO
								, "siren":		WIDGET_TYPE_SIREN
								, "label":		WIDGET_TYPE_LABEL
								, "led":		WIDGET_TYPE_LED
								, "picture":	WIDGET_TYPE_PICTURE
								, "2dstoplight":WIDGET_TYPE_2DLIGHTS
								, "root":		WIDGET_TYPE_ROOT
								, "tabs":		WIDGET_TYPE_TAB
								, "navtabs":	WIDGET_TYPE_NAVTAB
								, "progressbar":WIDGET_TYPE_PROGRESS_BAR
								, "tank":		WIDGET_TYPE_TANK};

			function loadPhoebusPageReqHandler(req, targetTabBodyId)
			{
				Debug.log("loadPhoebusPageReqHandler() was called. Req: " + req.responseText);

				Debug.logv({targetTabBodyId});

				//if not targeting a tab widget, reset the page
				if(targetTabBodyId === undefined)
				{
					//=============================
					//delete all widget HTML objects by removing all containers
					// do not do mainBlock_.el.innerHTML = ""; //clear
					//	because there are other objects like PVmenu and ContextMenu
					function localDeleteAllWidgetHTML()
					{
						var widgetContainerEls = document.getElementsByClassName("widgetContainerDiv");
						console.log("Removing widget containers",widgetContainerEls);
						while((widgetContainerEls = 
							document.getElementsByClassName("widgetContainerDiv")) &&
							widgetContainerEls.length)
							widgetContainerEls[0].parentNode.removeChild(widgetContainerEls[0]);
					} //end localDeleteAllWidgetHTML()
					localDeleteAllWidgetHTML();

					page_.widgets = {}; //clear

					if(!fileBlock_.isHidden)
						toggleFileMenu();
				} //end with page reset

				var phoebus = decodeURIComponent(DesktopContent.getXMLValue(req, "PHOEBUS"));
				var xml = ( new window.DOMParser() ).parseFromString(phoebus, "text/xml");
				console.log("loadPhoebusPageReqHandler(): xml document");
				console.log(xml);

				var widgets = xml.getElementsByTagName("widget");
				var groups = {};
				widgetCounter = 0;

				for(var i=0; i<widgets.length; ++i)
				{
					if (widgets[i].parentElement.tagName != "display") continue;
					widgetCounter = makePhoebusWidget(widgets[i], widgetCounter, xml, groups, targetTabBodyId);
					++widgetCounter;
				} //end widget extraction loop

				var time =  xml.getElementsByTagName("time");
				var notes = xml.getElementsByTagName("notes");

				if(notes.innerHTML == "[\"Not Found\"]")
				{
					Debug.log("Page failed to load page(" + decodeURIComponent(page) + ") on server!",
					Debug.HIGH_PRIORITY);
					return;
				}

				console.log("loadPhoebusPageReqHandler(): page_.widgets");
				console.log(page_.widgets);
				console.log("loadPhoebusPageReqHandler(): groups");
				console.log(groups);

				editBlock_.isHidden = false;
				targetTabBodyId_ = undefined;
				//toggleEditMode();
			} //end loadPhoebusPageReqHandler()

			//=====================================================================================
			function makePhoebusWidget(widget, i, xml, groups, targetTabBodyId)
			{
				var widgetObject 		= {};
				widgetObject.pvList 	= {};
				widgetObject.attributes = {};

				var type = PHOEBUS_MAP[ widget.attributes["type"].nodeValue ];
				var group = -1;
				if (widget.attributes["ots_group"] !== undefined) group = widget.attributes["ots_group"].nodeValue;

				var displayName = widget.getElementsByTagName("name")[0];
				var x = widget.getElementsByTagName("x")[0];
				var y = widget.getElementsByTagName("y")[0];
				var w = widget.getElementsByTagName("width")[0];
				var h = widget.getElementsByTagName("height")[0];
				var pv = widget.getElementsByTagName("pv_name")[0];

				if (type !== undefined) widgetObject.type = type; else widgetObject.type = 0;
				if (displayName !== undefined) widgetObject.displayName = displayName.innerHTML; else widgetObject.displayName = "undefined";
				if (x !== undefined) widgetObject.x = parseFloat(x.innerHTML); else widgetObject.x = 10;
				if (y !== undefined) widgetObject.y = parseFloat(y.innerHTML); else widgetObject.y = 10;
				if (w !== undefined) widgetObject.w = parseFloat(w.innerHTML); else widgetObject.w = 50;
				if (h !== undefined) widgetObject.h = parseFloat(h.innerHTML); else widgetObject.h = 50;
				if (pv !== undefined)
				{
					var pv_refresh = pv.attributes["refresh_rate"];
					if (pv_refresh !== undefined) widgetObject.pvList[pv.innerHTML] = pv_refresh.nodeValue; else widgetObject.pvList[pv.innerHTML] = refreshRate_;
				}

				if (type == WIDGET_TYPE_CHART) //smartChart
				{
					var traces = widget.getElementsByTagName("traces")[0];
					if (traces !== undefined)
					{
						var trace = xml.getElementsByTagName("trace");
						for(j=0; j<trace.length; ++j)
						{
							var y_pv = trace[j].getElementsByTagName("y_pv")[0];
							if (y_pv !== undefined)
							{
								var pv_refresh = y_pv.attributes["refresh_rate"];
								if (pv_refresh !== undefined) widgetObject.pvList[y_pv.innerHTML] = pv_refresh.nodeValue; else widgetObject.pvList[y_pv.innerHTML] = refreshRate_;
							}
						}
					}
				}

				//attribute objects
				var label_class = widget.getElementsByTagName("class")[0];
				var border = widget.getElementsByTagName("border")[0];
				var text = widget.getElementsByTagName("text")[0];
				var text_position = widget.getElementsByTagName("text_position")[0];
				var font = widget.getElementsByTagName("font")[0];
				var foreground_color = widget.getElementsByTagName("foreground_color")[0];
				var background_color = widget.getElementsByTagName("background_color")[0];
				var transparent = widget.getElementsByTagName("transparent")[0];
				var wrap_words = widget.getElementsByTagName("wrap_words")[0];
				var upload_image = widget.getElementsByTagName("upload_image")[0];
				var upload_csv_file = widget.getElementsByTagName("upload_csv_file")[0]; //2dstoplight widget
				var table_border = widget.getElementsByTagName("table_border")[0]; //2dstoplight widget
				var table_border_color = widget.getElementsByTagName("table_border_color")[0]; //2dstoplight widget
				var link_to_page = widget.getElementsByTagName("link_to_page")[0]; //2dstoplight widget
				var trace_type = widget.getElementsByTagName("trace_type")[0]; //plotly_bar_chart and xy_chart widgets
				var trace_mode = widget.getElementsByTagName("trace_mode")[0]; //plotly_bar_chart and xy_chart widgets

				//set attributes
				if (label_class !== undefined) widgetObject.attributes["class"] = label_class.innerHTML;
				if (border !== undefined) widgetObject.attributes["border"] = border.innerHTML;
				if (text !== undefined) widgetObject.attributes["text"] = text.innerHTML;
				if (text_position !== undefined) widgetObject.attributes["text_position"] = text_position.innerHTML;
				if (font !== undefined) widgetObject.attributes["font"] = font.innerHTML;
				if (foreground_color !== undefined) widgetObject.attributes["foreground_color"] = foreground_color.innerHTML;
				if (background_color !== undefined) widgetObject.attributes["background_color"] = background_color.innerHTML;
				if (transparent !== undefined) widgetObject.attributes["transparent"] = transparent.innerHTML;
				if (wrap_words !== undefined) widgetObject.attributes["wrap_words"] = wrap_words.innerHTML;
				if (upload_image !== undefined) widgetObject.attributes["upload_image"] = upload_image.innerHTML;
				if (upload_csv_file !== undefined) widgetObject.attributes["upload_csv_file"] = upload_csv_file.innerHTML;
				if (table_border !== undefined) widgetObject.attributes["table_border"] = table_border.innerHTML;
				if (table_border_color !== undefined) widgetObject.attributes["table_border_color"] = table_border_color.innerHTML;
				if (link_to_page !== undefined) widgetObject.attributes["link_to_page"] = link_to_page.innerHTML;
				if (trace_type !== undefined) widgetObject.attributes["trace_type"] = trace_type.innerHTML;
				if (trace_mode !== undefined) widgetObject.attributes["trace_mode"] = trace_mode.innerHTML;

				console.log("Drawing and creating widget",i,widgetObject);

				widgetObject.loaded = true;

				if (group !== -1)
				{
					for (j=0; j<i; ++j)
					{
						if (   page_.widgets[j] !== undefined 
							&& page_.widgets[j].type == widgetObject.type 
						    && page_.widgets[j].displayName == widgetObject.displayName
						    && displayName !== undefined
						    && groups[j] == group)
						{
							if (pv !== undefined) 
								page_.widgets[j].pvList[pv.innerHTML] = refreshRate_;
							groups[i] = group;
						}
					}

					if (groups[i] == undefined)
					{
						groups[i] = group;
					}
					else
					{
						return i;
					}
				}

				if (type == WIDGET_TYPE_TAB) //TABS
				{
					var j;
					for (j=0; j<widget.childElementCount; j++)
						if (widget.children[j].tagName == "tabs")
							break;
					var chlCount = widget.children[j].childElementCount;
					var chl = widget.children[j].children;

					widgetObject.attributes["tabs_num"] = chlCount;

					var id = Object.keys(page_.widgets).length;
					page_.widgets[id] = widgetObject;
					widgetObject.el = undefined;
					widgetObject.tabBodyID = targetTabBodyId;
					targetTabBodyId_ = targetTabBodyId;
					drawWidget(id,type);

					for (var k=0; k<chlCount; k++)
					{
						for (var l=0; l<chl[k].childElementCount; l++)
						{
							if (chl[k].children[l].tagName == "name")
								widgetObject.attributes["tabname_"+ k] = chl[k].children[l].innerHTML;
							if (chl[k].children[l].tagName == "children")
							{
								var widgetCount = chl[k].children[l].childElementCount;
								var wids = chl[k].children[l].children;
								for (var m=0; m<widgetCount; m++)
								{
									targetTabBodyId = "widget-" + id + "-tabBody-" + k;
									makePhoebusWidget(wids[m], ++i, xml, groups, targetTabBodyId);
								}
							}
						}
					}
					return i;
				}

				if (type == WIDGET_TYPE_NAVTAB) //NAVTABS
				{
					var j;
					for (j=0; j<widget.childElementCount; j++)
						if (widget.children[j].tagName == "tabs")
							break;
					var chlCount = widget.children[j].childElementCount;
					var chl = widget.children[j].children;

					widgetObject.attributes["tabs_num"] = chlCount;

					for (var k=0; k<chlCount; k++)
					{
						for (var l=0; l< chl[k].childElementCount; l++)
						{
							if (chl[k].children[l].tagName == "file")
								widgetObject.attributes["file_"+ k] = chl[k].children[l].innerHTML;
							if (chl[k].children[l].tagName == "name")
								widgetObject.attributes["tabname_"+ k] = chl[k].children[l].innerHTML;	
						}
					}
				}

				var id = Object.keys(page_.widgets).length;
				page_.widgets[id] = widgetObject;
				widgetObject.el = undefined;
				widgetObject.tabBodyID = targetTabBodyId;
				targetTabBodyId_ = targetTabBodyId;
				drawWidget(id,type);

				if (type == WIDGET_TYPE_2DLIGHTS) //2dstoplights
				{
					var xSize = widget.getElementsByTagName("table_xSize")[0];
					if (xSize)  widgetObject.el.contentWindow._xSize = parseInt(xSize.innerHTML);
					var ySize = widget.getElementsByTagName("table_ySize")[0];
					if (ySize)  widgetObject.el.contentWindow._ySize = parseInt(ySize.innerHTML);

					var table = widget.getElementsByTagName("tabledata")[0];
					if (table)
					{
						var data = [];
						var cells = table.getElementsByTagName("cell");
						for(j = 0; j < cells.length; ++j)
						{
							var cell = {
										  id: 		cells[j].getElementsByTagName("id")[0].innerHTML
										, x:		cells[j].getElementsByTagName("x")[0].innerHTML
										, y: 		cells[j].getElementsByTagName("y")[0].innerHTML
										, pvName:	cells[j].getElementsByTagName("pvName")[0].innerHTML
									   };
							data.push(cell);
							if (cell.pvName != "-1" &&  cell.pvName != "")
								widgetObject.pvList[cell.pvName] = refreshRate_;
						}
						widgetObject.el.contentWindow.tabledata = data;
					}
				}
				return i;
			} //end makePhoebusWidget()

			//=====================================================================================
			function pollServerHandlerFunction(req)
			{
				Debug.log("pollServerHandlerFunction() was called. Req: " + req.responseText);

				if(!editBlock_.isHidden)
				{
					Debug.log("Ingoring pool response in edit mode");	
					return;
				}

 				var jsonStr = DesktopContent.getXMLValue(req, "JSON");
				jsonStr = jsonStr.replace(/\s/g, ''); //hack for removing whitespace 
    			if(!jsonStr || jsonStr == "") 
					return;

				Debug.log(jsonStr);

				var serverResponse;

				serverResponse = JSON.parse(jsonStr);

				Debug.log(serverResponse);

				if(serverResponse.message == "NOT_FOUND")
				{
					console.log("Have to generate new UID!");
					generateUID();
					timeToPoll_ = true;
				}
				else
				{
					for(var pv in serverResponse)//have to use each pv and then loop through
					{	
						console.log("pollServerHandlerFunction: pv" + pv);						
						for (var widget in page_.widgets)
						{
							console.log("pollServerHandlerFunction: " + page_.widgets[widget]);
							for(var dependendentPV in page_.widgets[widget].pvList)
							{
								console.log("poll: " + dependendentPV);
								if(pv == dependendentPV && page_.widgets[widget].loaded != "false")
								{
									console.log("Widget*************", widget, pv);
									try
									{
										document.getElementById("widget-" + 
											widget).contentWindow.drawNewValue(
												pv, 
												serverResponse[pv].Value, 
												serverResponse[pv].Timestamp, 
												serverResponse[pv].Status, 
												serverResponse[pv].Severity);
									}
									catch(e)
									{
										Debug.log("Error was caught updating new value to widget 'widget-" +
											widget + "': " + e);											
									}
								}
							}
						}
					}
				}

				timerVariable_ = window.setTimeout(pollServer, refreshRate_);
			} //end pollServerHandlerFunction()


			//=====================================================================================
			function generateUIDHandlerFunction(req)
			{
				var uid = JSON.parse(DesktopContent.getXMLValue(req, "JSON"));

				if(uid.message != "-1")
					UID_ = uid.message;
				else
				{
					UID_ = "";
					Debug.log("Unable to generate UID!", Debug.HIGH_PRIORITY);
				}

				if(timeToPoll_)
				{
					pollServer();
				}
			} //end generateUIDHandlerFunction()


			//=====================================================================================
			function settingsReqHandler(req, passParams)
			{
				var settings = JSON.parse(DesktopContent.getXMLValue(req, "JSON"));				
				var id = passParams[0]|0; //force integer
				var attributes = passParams[1];

				console.log("id:",id," attributes:", attributes);

				console.log(req);
				console.log(settings);
				console.log(id);

				page_.widgets[id].el.contentWindow.setupPVs(settings);
				page_.widgets[id].el.contentWindow.drawWidget(page_.widgets[id], attributes);

			} //end settingsReqHandler()


			//=====================================================================================
			function pvHistoryReqHandler(req, passParams) 
			{
				var jsonArr = req.responseXML.getElementsByTagName("JSON");
				console.log("pvHistoryReqHandler()", jsonArr);

				var id = passParams[0];
				var parameters = passParams[1];
				console.log("id: " + id + " parameter: " + parameters);

				for (var i = jsonArr.length - 1; i >= 0; i--){
					var history = JSON.parse(DesktopContent.getXMLValue(jsonArr[i]));				

					for (var pv in history) {
						console.log(pv);
						console.log(history[pv].Timestamp + " " + history[pv].Value);
						page_.widgets[id].el.contentWindow.drawNewValue(pv, history[pv].Value, history[pv].Timestamp, history[pv].Status, history[pv].Severity);
					}
				}
			} //end pvHistoryReqHandler()


			//=====================================================================================
			function savePageReqHandler(req)
			{
				var response = req.responseText;
				Debug.log(response);
			} //end savePageReqHandler()


			//=====================================================================================
			function createControlsPageHandler(req)
			{
				Debug.log("createControlsPageHandler() was called for " + controlsPageName);// Req: " + req.responseText);
				Debug.log("Your page was succesfully saved!",Debug.INFO_PRIORITY);		
			} //end createControlsPageHandler()


			//=====================================================================================
			function handlerFunction(req) 
			{
				var child1data = DesktopContent.getXMLValue(req,"child");
				var child2data = DesktopContent.getXMLValue(req,"child2");
				Debug.log("--child1data:",child1data," --child2data:",child2data);
			} //end handlerFunction()


			//=====================================================================================
			function lastAlarmsReqHandler(req, passParams)
			{
				var jsonArr = req.responseXML.getElementsByTagName("JSON");
				//console.log("lastAlarmsReqHandler()", jsonArr);
				var id = passParams[0];
				console.log("lastAlarmsReqHandler() id", id);

				if (id != undefined)
				{
					page_.widgets[id].el.contentWindow.tabledata = [];
					for (var i = jsonArr.length - 1; i >= 0; i--) {
						var row = JSON.parse(DesktopContent.getXMLValue(jsonArr[i]));
						page_.widgets[id].el.contentWindow.tabledata.push(row);
					}

					console.log("lastAlarmsReqHandler() last alarms", page_.widgets[id].el.contentWindow.tabledata);
					if (passParams[1] != undefined)
						page_.widgets[id].el.contentWindow.newPVTable();
					else
						page_.widgets[id].el.contentWindow.table.setData(
							page_.widgets[id].el.contentWindow.tabledata
						);
				}
				else
				{
					for (var widget in page_.widgets) {
						if (isEmpty(page_.widgets[widget].pvList))
						{
							if (page_.widgets[widget].type == 1)
							{
								if (page_.widgets[widget].attributes["getLastAlarms"] == "true")
								{
									page_.widgets[widget].el.contentWindow.table.setData(
										page_.widgets[widget].el.contentWindow.tabledata
									);
									lastAlarmsTimerVariable_ = window.setTimeout(getLastAlarms, refreshRate_);
								}
							}
						}
					}
				}
			} //end lastAlarmsReqHandler()


			//=====================================================================================
			function getLastAlarms(id, parameters)
			{
				var pvList = "";

				if (id != undefined)
				{
					id = id.split('-')[1];

					if (page_.widgets[id] === undefined) {
						Debug.log("Illegal widget UID (not found in widget list) received from child widget frame: " +
							id, Debug.HIGH_PRIORITY);
						return;
					}

					for (var pv in page_.widgets[id].pvList) {
						pvList += pv + ",";
					}
				}

				var passParams = [id, parameters];
				DesktopContent.XMLHttpRequest("Request?RequestType=getLastAlarmsData",
					//post data 
					"pvList=" + pvList +
					"&id=" + id,
					lastAlarmsReqHandler /*handler*/,
					passParams /*parameter*/);
				console.log("get last alarms for widget! pvList: " + pvList);
			} //end getLastAlarms()


			//=====================================================================================
			function alarmsLogReqHandler(req, passParams)
			{
				var jsonArr = req.responseXML.getElementsByTagName("JSON");
				//console.log("alarmsLogReqHandler()", jsonArr);
				var id = passParams[0];
				console.log("alarmsLogReqHandler() id", id);

				if (id != undefined)
				{
					page_.widgets[id].el.contentWindow.tabledata = [];
					for (var i = jsonArr.length - 1; i >= 0; i--) {
						var row = JSON.parse(DesktopContent.getXMLValue(jsonArr[i]));
						page_.widgets[id].el.contentWindow.tabledata.push(row);
					}

					console.log("alarmsLogReqHandler() alarms log", page_.widgets[id].el.contentWindow.tabledata);
					if (passParams[1] != undefined)
					{
						page_.widgets[id].el.contentWindow.newPVTable();
						page_.widgets[id].el.contentWindow.table.hideColumn("pvDescription");
					}
					else
						page_.widgets[id].el.contentWindow.table.setData(
							page_.widgets[id].el.contentWindow.tabledata
						);
				}
				else
				{
					for (var widget in page_.widgets) {
						if (isEmpty(page_.widgets[widget].pvList)) {
							if (page_.widgets[widget].type == 1) {
								if (page_.widgets[widget].attributes["getAlarmsLog"] == "true")
								{
									page_.widgets[widget].el.contentWindow.table.setData(
										page_.widgets[widget].el.contentWindow.tabledata
									);
									alarmsLogTimerVariable_ = window.setTimeout(getAlarmsLog, refreshRate_);
								}
							}
						}
					}
				}

			} //end alarmsLogReqHandler()


			//=====================================================================================
			function getAlarmsLog(id, parameters)
			{
				var pvList = "";

				if (id != undefined)
				{
					id = id.split('-')[1];

					if (page_.widgets[id] === undefined) {
						Debug.log("Illegal widget UID (not found in widget list) received from child widget frame: " +
							id, Debug.HIGH_PRIORITY);
						return;
					}

					for (var pv in page_.widgets[id].pvList) {
						pvList += pv + ",";
					}
				}

				var passParams = [id, parameters];
				DesktopContent.XMLHttpRequest("Request?RequestType=getAlarmsLogData",
					//post data 
					"pvList=" + pvList +
					"&id=" + id,
					alarmsLogReqHandler /*handler*/,
					passParams /*parameter*/);
				console.log("get alarms log for widget! pvList: " + pvList);
			} //end getAlarmsLog()


			//=====================================================================================
			function pollAlarmsLog()
			{

			} //end pollAlarmsLog()


			//=====================================================================================
			function pollServer()
			{
				timeToPoll_ = false;
				Debug.log("pollServer: polling server!");
				console.log("pollServer(): ",page_.widgets);
				//console.log("UID is ", UID_);
				if(page_.widgets)
				{
					DesktopContent.XMLHttpRequest(
						"Request?RequestType=poll&uid=" + UID_,
						"", 
						pollServerHandlerFunction /*returnHandler*/, 
						0 /*reqParam*/, 
						0 /*progressHandler*/, 
						0 /*callHandlerOnErr*/, 
						true /*doNoShowLoadingOverlay*/);	
				}
			} //end pollServer()


			//=====================================================================================
			function generateUID()
			{
				//BEGIN Put all pvs in a JSON and send to server
				var pvList = "";
				//console.log("page: ", page_);
				for (var widget in page_.widgets)
				{
					console.log("generateUID: " +  page_.widgets[widget] + " " +  page_.widgets[widget].pvList);

					for(var pv in page_.widgets[widget].pvList)
					{
						//pvList += pv + ":"  + page_.widgets[widget].pvList.valueOf()[pv] + ",";
						pvList += pv + ",";
					}
				}

				console.log(pvList);
				timeToPoll_ = true;

				//END Put all pvs in a JSON and send to server
				DesktopContent.XMLHttpRequest(
					"Request?RequestType=generateUID",
					"pvList=" + pvList,
					generateUIDHandlerFunction);//, undefined, undefined, "sequence");
			} //end generateUID()


			//=====================================================================================
			function updateRefreshInterval()
			{
				console.log("updateRefreshInterval.refreshRate_ (ms): " + refreshRate_);
				window.clearInterval(timerVariable_);
				timerVariable_ = setInterval(pollServer, refreshRate_);
			} //end updateRefreshInterval()


			//=====================================================================================
			function loadPage(page)
			{
				DesktopContent.XMLHttpRequest("Request?RequestType=loadPage&Page=" + page, "", loadPageReqHandler);//, undefined, undefined, "sequence");
			} //end loadPage()


			//=====================================================================================
			function loadPhoebusPage(page,targetTabWidgetId)
			{
				DesktopContent.XMLHttpRequest(
					"Request?RequestType=loadPhoebusPage&Page=" + page, 
					"", 
					loadPhoebusPageReqHandler,
					targetTabWidgetId);//, undefined, undefined, "sequence");
				previousPage_ = actualPage_;
				actualPage_ = page;
			} //end loadPhoebusPage()


			//=====================================================================================
			function loadPageNewWindow(fullPathToPage)
			{
				var newWindowStr = location.origin + location.pathname + location.search
				+ "&page_name=" + fullPathToPage;

				DesktopContent.openNewWindow("Controls Dashboard", "", newWindowStr, false /*unique*/);
			} //end loadPageNewWindow()


			//=====================================================================================
			function loadPageNewBrowserTab(fullPathToPage)
			{
				var newWindowStr = location.origin + location.pathname + location.search
				+ "&page_name=" + fullPathToPage;

				DesktopContent.openNewBrowserTab("Controls Dashboard","", newWindowStr ,false /*unique*/);
			} //end loadPageNewBrowserTab()


			//=====================================================================================
			//CreateDesktopIcon page loader~~
			function createDesktopIcon(fullPathToPage)
			{
				DesktopContent.addDesktopIcon(
					fullPathToPage
					,"CTRLS","Slow Control Subsets"
					, false /*unique*/
					, 255 /*permissionsString*/
					, "icon-ControlsDashboard.png" /*imageURL*/
					, location.href.substring(0,location.href.indexOf("html")+4) + "/SlowControlsDashboard.html?urn=" /*windowContentURL*/
					, "ots::SlowControlsDashboardSupervisor" /*linkedApp*/
					, /*parameters*/
					"page_name=" + fullPathToPage
					);
			} //end CreateDesktopIcon


			//=====================================================================================
			function savePage() 
			{
				//Conditions to stop page saving e.g. blank page, using illegal pvs, etc Or overwrite?
				if(false)
					Debug.log("No reason to save a blank page!");
    			else
    			{
					console.log("Showing save popup");
		       		fileBlock_.savePopup.style.display = "block";
		       		fileBlock_.savePopup.style["z-index"] = "9000";
					if (userPermission == ADMIN_PERMISSION_THRESHOLD)
			       		document.getElementById("makeControlsPagePublic").style.display = "block";
    			}
			} //end savePage()


			//=====================================================================================
			function hidePopupSaveControlsPage()
			{
		        fileBlock_.savePopup.style.display = "none";
		        fileBlock_.savePopup.style["z-index"] = "0";
		        document.getElementById("controlsPageName").value="";
	            document.getElementById("controlsPageNotes").value="";
		        Debug.log("Controls Page successfully saved!");
			} //end hidePopupSaveControlsPage()


			//=====================================================================================
			function savePageAs()
			{
	            var controlsPageName = document.getElementById("controlsPageName").value;
	            console.log("Here is our name: " + controlsPageName);
	            var Regex = /^[a-zA-Z0-9\_]+$/g;
	            if (!Regex.test(controlsPageName)) 
		        	Debug.log("Illegal characters in name. Please remove these characters and try again.", Debug.HIGH_PRIORITY);
	    		else
	    		{
    		        var controlsPageNotes = document.getElementById("controlsPageNotes").value;
    		        Debug.log(controlsPageNotes);

					if(controlsPageNotes.indexOf("@") >= 0 || controlsPageNotes.indexOf("#") >= 0 || controlsPageNotes.indexOf("..") >= 0)
					{
				         Debug.log("Illegal characters in notes. Please remove these characters and try again.", Debug.HIGH_PRIORITY);
				         return;
					}

	    			var controlsPageLibEl = document.getElementById('listOfPrivateControlsPages');
	    			var isControlsPagePublic = document.getElementById("isControlsPagePublic").checked;

					var pagetosave = Object.assign({}, page_)
	    			for (var widget in pagetosave.widgets)
					{
						pagetosave.widgets[widget].x = page_.widgets[widget].x;// * windowWidth_ / (PAGE_POSITIONS_) | 0;
						pagetosave.widgets[widget].y = page_.widgets[widget].y;// * windowHeight_ / (PAGE_POSITIONS_) | 0;
						pagetosave.widgets[widget].w = page_.widgets[widget].w;// * windowWidth_ / (PAGE_POSITIONS_) | 0;
						pagetosave.widgets[widget].h = page_.widgets[widget].h;// * windowHeight_ / (PAGE_POSITIONS_) | 0;
					}

	    			var pageString = JSON.stringify(pagetosave);

	        		if(pagesList_.indexOf(controlsPageName) !== -1) //duplicate name
	        		{
	    				Debug.log("ControlsPage name already exists!");

	    				document.getElementById('popupControlsPageAlreadyExistsOverwrite').onclick = function(){ //call edit
	    					DesktopContent.XMLHttpRequest("Request?RequestType=editControlsPage",
	    						//post data
	    						"isPublic=" + isControlsPagePublic +
								"&oldControlsPageName=" + controlsPageName +
								"&newControlsPageName=" + controlsPageName +
								"&Page=" + pageString +
								"&Time=" + Date().toString() +
								"&Notes=" + encodeURIComponent(controlsPageNotes),
								saveChangedControlsPageHandler /*handler*/,
								controlsPageName /*parameter*/);};
	        		}
	        		else
	        		{
				        DesktopContent.XMLHttpRequest("Request?RequestType=createControlsPage",
							//post data
							"isPublic=" + isControlsPagePublic +
							"&Name=" + controlsPageName +
							"&Page=" + pageString +
							"&Time=" + Date().toString() +
							"&Notes=" + encodeURIComponent(controlsPageNotes),
							createControlsPageHandler /*handler*/);

						hidePopupSaveControlsPage();
	        		}
    			}
			} //end savePageAs()


			//=====================================================================================
			function prepareWidgetXml(widgetId, pageString)
			{
				var widget = pageString.createElement("widget");
				var type = Object.keys(PHOEBUS_MAP).find(key => PHOEBUS_MAP[key] === page_.widgets[widgetId].type);
				widget.setAttribute("type", type);
				widget.setAttribute("version",	"2.0.0");
				var name = pageString.createElement("name");
				var x = pageString.createElement("x");
				var y = pageString.createElement("y");
				var width = pageString.createElement("width");
				var height = pageString.createElement("height");
				var tabBodyID = pageString.createElement("tabBodyID");

				name.innerHTML = page_.widgets[widgetId].displayName;
				widget.appendChild(name);

				//attribute objects
				if (page_.widgets[widgetId].type != WIDGET_TYPE_TAB && page_.widgets[widgetId].type != WIDGET_TYPE_NAVTAB)
					for (var attr in page_.widgets[widgetId].attributes)
					{
						var attribute = pageString.createElement(attr);
						attribute.innerHTML = page_.widgets[widgetId].attributes[attr];
						if (attribute.innerHTML !== "undefined") widget.appendChild(attribute);
					}

				x.innerHTML = page_.widgets[widgetId].x;//toPageXCoordinate(page_.widgets[widgetId].x);//page_.widgets[widgetId].x * windowWidth_ / (PAGE_POSITIONS_) | 0;
				y.innerHTML = page_.widgets[widgetId].y;//toPageYCoordinate(page_.widgets[widgetId].y);//page_.widgets[widgetId].y * windowHeight_ / (PAGE_POSITIONS_) | 0;
				width.innerHTML = page_.widgets[widgetId].w;//toPageXCoordinate(page_.widgets[widgetId].w);//page_.widgets[widgetId].w * windowWidth_ / (PAGE_POSITIONS_) | 0;
				height.innerHTML = page_.widgets[widgetId].h;//toPageYCoordinate(page_.widgets[widgetId].h);//page_.widgets[widgetId].h * windowHeight_ / (PAGE_POSITIONS_) | 0;
				widget.appendChild(x);
				widget.appendChild(y);
				widget.appendChild(width);
				widget.appendChild(height);

				return widget;
			} //end prepareWidgetXml()


			//=====================================================================================
			function makePhoebusXml(widgetId, pageString, display, group)
			{
				if(isEmpty(page_.widgets[widgetId].pvList))
				{
					var widget = prepareWidgetXml(widgetId, pageString);
					display.appendChild(widget);
				}
				else
				{
					var type = Object.keys(PHOEBUS_MAP).find(key => PHOEBUS_MAP[key] === page_.widgets[widgetId].type);

					if (type =="stripchart")
					{
						var widget = pageString.createElement("widget");
						widget.setAttribute("type", type);
						widget.setAttribute("version",	"2.0.0");

						var name = pageString.createElement("name");
						var x = pageString.createElement("x");
						var y = pageString.createElement("y");
						var width = pageString.createElement("width");
						var height = pageString.createElement("height");
						name.innerHTML = page_.widgets[widgetId].displayName;
						widget.appendChild(name);

						x.innerHTML = page_.widgets[widgetId].x;//toPageXCoordinate(page_.widgets[widgetId].x);//page_.widgets[widgetId].x * windowWidth_ / (PAGE_POSITIONS_) | 0;
						y.innerHTML = page_.widgets[widgetId].y;//toPageYCoordinate(page_.widgets[widgetId].y);//page_.widgets[widgetId].y * windowHeight_ / (PAGE_POSITIONS_) | 0;
						width.innerHTML = page_.widgets[widgetId].w;//toPageXCoordinate(page_.widgets[widgetId].w);//page_.widgets[widgetId].w * windowWidth_ / (PAGE_POSITIONS_) | 0;
						height.innerHTML = page_.widgets[widgetId].h;//toPageYCoordinate(page_.widgets[widgetId].h);//page_.widgets[widgetId].h * windowHeight_ / (PAGE_POSITIONS_) | 0;

						widget.appendChild(x);
						widget.appendChild(y);
						widget.appendChild(width);
						widget.appendChild(height);

						var traces = pageString.createElement("traces");

						for (var pv_name in page_.widgets[widgetId].pvList)
						{
							var trace = pageString.createElement("trace");

							var pv = pageString.createElement("y_pv");
							var pv_refresh = page_.widgets[widgetId].pvList[pv_name];
							pv.setAttribute("refresh_rate", pv_refresh);
							pv.innerHTML = pv_name;
							trace.appendChild(pv);

							//attribute objects
							for (var attr in page_.widgets[widgetId].attributes)
							{
								var attribute = pageString.createElement(attr);
								attribute.innerHTML = page_.widgets[widgetId].attributes[attr];
								if (attribute.innerHTML !== "undefined") trace.appendChild(attribute);
							}

							traces.appendChild(trace);
						}

						widget.appendChild(traces);
						display.appendChild(widget);
					}
					else if (type =="2dstoplight")
					{
						var widget = pageString.createElement("widget");
						widget.setAttribute("type", type);
						widget.setAttribute("version",	"2.0.0");

						var name = pageString.createElement("name");
						var x = pageString.createElement("x");
						var y = pageString.createElement("y");
						var width = pageString.createElement("width");
						var height = pageString.createElement("height");
						name.innerHTML = page_.widgets[widgetId].displayName;
						widget.appendChild(name);

						x.innerHTML = page_.widgets[widgetId].x;//toPageXCoordinate(page_.widgets[widgetId].x);//page_.widgets[widgetId].x * windowWidth_ / (PAGE_POSITIONS_) | 0;
						y.innerHTML = page_.widgets[widgetId].y;//toPageYCoordinate(page_.widgets[widgetId].y);//page_.widgets[widgetId].y * windowHeight_ / (PAGE_POSITIONS_) | 0;
						width.innerHTML = page_.widgets[widgetId].w;//toPageXCoordinate(page_.widgets[widgetId].w);//page_.widgets[widgetId].w * windowWidth_ / (PAGE_POSITIONS_) | 0;
						height.innerHTML = page_.widgets[widgetId].h;//toPageYCoordinate(page_.widgets[widgetId].h);//page_.widgets[widgetId].h * windowHeight_ / (PAGE_POSITIONS_) | 0;

						widget.appendChild(x);
						widget.appendChild(y);
						widget.appendChild(width);
						widget.appendChild(height);

						for (var pv_name in page_.widgets[widgetId].pvList)
						{
							var pv = pageString.createElement("pv_name");
							var pv_refresh = page_.widgets[widgetId].pvList[pv_name];
							pv.setAttribute("refresh_rate", pv_refresh);
							pv.innerHTML = pv_name;
							widget.appendChild(pv);
						}

						//attribute objects
						for (var attr in page_.widgets[widgetId].attributes)
						{
							var attribute = pageString.createElement(attr);
							attribute.innerHTML = page_.widgets[widgetId].attributes[attr];
							if (attribute.innerHTML !== "undefined") widget.appendChild(attribute);
						}

						var table_xSize = pageString.createElement("table_xSize");
						table_xSize.innerHTML = page_.widgets[widgetId].el.contentWindow._xSize
						var table_ySize = pageString.createElement("table_ySize");
						table_ySize.innerHTML = page_.widgets[widgetId].el.contentWindow._ySize;

						var tabledata = pageString.createElement("tabledata");
						var data = page_.widgets[widgetId].el.contentWindow.tabledata;
						for (cell in data)
						{
							var celldata = pageString.createElement("cell");
							var id = pageString.createElement("id");
							id.innerHTML = 	data[cell].id;
							var x = pageString.createElement("x");
							x.innerHTML = 	data[cell].x;
							var y = pageString.createElement("y");
							y.innerHTML = 	data[cell].y;
							var pvName = pageString.createElement("pvName");
							pvName.innerHTML = 	data[cell].pvName;
							var pvValue = pageString.createElement("pvValue");
							pvValue.innerHTML = 	data[cell].pvValue;
							var pvStatus = pageString.createElement("pvStatus");
							pvStatus.innerHTML = 	data[cell].pvStatus;
							var pvSeverity = pageString.createElement("pvSeverity");
							pvSeverity.innerHTML = 	data[cell].pvSeverity;
							var pvTime = pageString.createElement("pvTime");
							pvTime.innerHTML = 	data[cell].pvTime;

							celldata.appendChild(id);
							celldata.appendChild(x);
							celldata.appendChild(y);
							celldata.appendChild(pvName);
							celldata.appendChild(pvValue);
							celldata.appendChild(pvStatus);
							celldata.appendChild(pvSeverity);
							celldata.appendChild(pvTime);
							tabledata.appendChild(celldata);
						}

						widget.appendChild(table_xSize);
						widget.appendChild(table_ySize);
						widget.appendChild(tabledata);
						display.appendChild(widget);
					}
					else
					{
						var counter = 0;
						for (var pv_name in page_.widgets[widgetId].pvList)
						{
							var widget = pageString.createElement("widget");
							widget.setAttribute("type", type);
							widget.setAttribute("version",	"2.0.0");
							if (Object.getOwnPropertyNames(page_.widgets[widgetId].pvList).length > 1) widget.setAttribute("ots_group", group);
							var name = pageString.createElement("name");
							var pv = pageString.createElement("pv_name");
							var x = pageString.createElement("x");
							var y = pageString.createElement("y");
							var width = pageString.createElement("width");
							var height = pageString.createElement("height");

							name.innerHTML = page_.widgets[widgetId].displayName;
							widget.appendChild(name);
							var pv_refresh = page_.widgets[widgetId].pvList[pv_name];
							pv.setAttribute("refresh_rate", pv_refresh);
							pv.innerHTML = pv_name;
							widget.appendChild(pv);

							//attribute objects
							for (var attr in page_.widgets[widgetId].attributes)
							{
								var attribute = pageString.createElement(attr);
								attribute.innerHTML = page_.widgets[widgetId].attributes[attr];
								if (attribute.innerHTML !== "undefined") widget.appendChild(attribute);
							}

							x.innerHTML = page_.widgets[widgetId].x;//toPageXCoordinate(page_.widgets[widgetId].x);//page_.widgets[widgetId].x * windowWidth_ / (PAGE_POSITIONS_) | 0;
							y.innerHTML = page_.widgets[widgetId].y;//toPageYCoordinate(page_.widgets[widgetId].y);//page_.widgets[widgetId].y * windowHeight_ / (PAGE_POSITIONS_) | 0;
							width.innerHTML = page_.widgets[widgetId].w;//toPageXCoordinate(page_.widgets[widgetId].w);//page_.widgets[widgetId].w * windowWidth_ / (PAGE_POSITIONS_) | 0;
							height.innerHTML = page_.widgets[widgetId].h;//toPageYCoordinate(page_.widgets[widgetId].h);//page_.widgets[widgetId].h * windowHeight_ / (PAGE_POSITIONS_) | 0;
							x.innerHTML = parseInt(x.innerHTML) + counter *(parseInt(width.innerHTML) + 2);

							widget.appendChild(x);
							widget.appendChild(y);
							widget.appendChild(width);
							widget.appendChild(height);

							display.appendChild(widget);
							counter++;
						}
						if (Object.getOwnPropertyNames(page_.widgets[widgetId].pvList).length > 1) group++;
					}
				}
			}//end makePhoebusXML()


			//=====================================================================================
			function makePhoebusTabsXML(widgetId, pageString, display, group)
			{
				if (page_.widgets[widgetId].type == WIDGET_TYPE_TAB)
				{
					var widget = prepareWidgetXml(widgetId, pageString);
					var tabs = pageString.createElement("tabs");
					var tabs_num = page_.widgets[widgetId].el.children[0].childElementCount;
					for (var tabId=0; tabId<tabs_num; tabId++)
					{
						var tab = pageString.createElement("tab");
						var name = pageString.createElement("name");
						name.innerHTML = page_.widgets[widgetId].el.children[0].children[tabId].innerHTML;
						tab.appendChild(name);
						var children = pageString.createElement("children");
						for (var wid in page_.widgets)
						{
							if (page_.widgets[wid].tabBodyID != undefined
								&& page_.widgets[wid].type != WIDGET_TYPE_TAB
								&& page_.widgets[widgetId].type != WIDGET_TYPE_NAVTAB
								&& page_.widgets[wid].tabBodyID == "widget-" + widgetId + "-tabBody-" + tabId)
							{
								makePhoebusXml(wid, pageString, children, group);
							}
							else if (page_.widgets[wid].tabBodyID != undefined
								&& (page_.widgets[wid].type == WIDGET_TYPE_TAB
								|| page_.widgets[widgetId].type == WIDGET_TYPE_NAVTAB)
								&& page_.widgets[wid].tabBodyID == "widget-" + widgetId + "-tabBody-" + tabId)
							{
								makePhoebusTabsXml(wid, pageString, children, group);
							}
						}
						tab.appendChild(children);
						tabs.appendChild(tab);
					}
					widget.appendChild(tabs);
					display.appendChild(widget);
				}
				else if (page_.widgets[widgetId].type == WIDGET_TYPE_NAVTAB)
				{
					var widget = prepareWidgetXml(widgetId, pageString);
					var tabs = pageString.createElement("tabs");
					var tabs_num = page_.widgets[widgetId].el.children[0].childElementCount;
					for (var tabId=0; tabId<tabs_num; tabId++)
					{
						var tab = pageString.createElement("tab");
						var name = pageString.createElement("name");
						name.innerHTML = page_.widgets[widgetId].el.children[0].children[tabId].innerHTML;
						tab.appendChild(name);
						var file = pageString.createElement("file");
						file.innerHTML = page_.widgets[widgetId].attributes["file_"+tabId];
						tab.appendChild(file);
						var macros = pageString.createElement("macros");
						tab.appendChild(macros);
						var group_name = pageString.createElement("group_name");
						tab.appendChild(group_name);
						tabs.appendChild(tab);
					}
					widget.appendChild(tabs);
					display.appendChild(widget);
				}
			}//end makePhoebusXML()


			//=====================================================================================
			function savePhoebusPageAs()
			{
	            var controlsPageName = document.getElementById("controlsPageName").value;
	            console.log("Here is our name: " + controlsPageName);
	            var Regex = /^[a-zA-Z0-9\_]+$/g;
	            if (!Regex.test(controlsPageName)) 
		        	Debug.log("Illegal characters in name " +
		        		"(No spaces, only alpha-numeric, dash and underscore allowed)." +
		        		" Please fix and try again.", Debug.HIGH_PRIORITY);
	    		else
	    		{
    		        var controlsPageNotes = document.getElementById("controlsPageNotes").value;
    		        Debug.log(controlsPageNotes);

					if(controlsPageNotes.indexOf("@") >= 0 || controlsPageNotes.indexOf("#") >= 0 || controlsPageNotes.indexOf("..") >= 0)
					{
				         Debug.log("Illegal characters in notes (no @, #, or .. allowed). Please remove these characters and try again.", Debug.HIGH_PRIORITY);
				         return;
					}

	    			var controlsPageLibEl = document.getElementById('listOfPrivateControlsPages');
	    			var isControlsPagePublic = document.getElementById("isControlsPagePublic").checked;

					var pageString = document.implementation.createDocument("", "", null);
					var display = pageString.createElement("display");
					var nm = pageString.createElement("name");
					nm.innerHTML = "Display";
					display.appendChild(nm);

					var group = 0;
	    			for (var widgetId in page_.widgets)
					{
						if (page_.widgets[widgetId].type != WIDGET_TYPE_TAB
						  && page_.widgets[widgetId].type != WIDGET_TYPE_NAVTAB
						  && (page_.widgets[widgetId].tabBodyID == "" || page_.widgets[widgetId].tabBodyID == undefined))
							makePhoebusXml(widgetId, pageString, display, group);
						else if (page_.widgets[widgetId].type == WIDGET_TYPE_TAB || page_.widgets[widgetId].type == WIDGET_TYPE_NAVTAB)
							makePhoebusTabsXML(widgetId, pageString, display, group);
					}

					var controlsPageNotes = document.getElementById("controlsPageNotes").value;

					pageString.appendChild(display);
					var pheobusXml =  "<?xml version='1.0' encoding='UTF-8'?>\n"
									+ "<display version='2.0.0'>\n"
									+ pageString.firstChild.innerHTML + "\n"
									+ "<notes>\n" + controlsPageNotes + "\n"
									+ "</notes>\n"
									+ "<time>\n"
									+ Date().toString() + "\n"
									+ "</time>\n"
									+ "</display>";
					console.log("savePhoebusPageAs():\n",encodeURIComponent(pheobusXml));

					if(pagesList_.indexOf(controlsPageName) !== -1) //duplicate name
					{
						Debug.log("ControlsPage name already exists!");

						document.getElementById('popupControlsPageAlreadyExistsOverwrite').onclick = function(){ //call edit
						DesktopContent.XMLHttpRequest("Request?RequestType=editControlsPage",
									//post data
									"isPublic=" + isControlsPagePublic +
									"&oldControlsPageName=" + controlsPageName +
									"&newControlsPageName=" + controlsPageName +
									"&Page=" + pheobusXml +
									saveChangedControlsPageHandler /*handler*/,
									controlsPageName /*parameter*/);};
					}
					else
					{
						DesktopContent.XMLHttpRequest("Request?RequestType=createPhoebusControlsPage",
									//post data
									"isPublic=" + isControlsPagePublic +
									"&Name=" + controlsPageName +
									"&Page=" + pheobusXml,
									createControlsPageHandler /*handler*/);

						hidePopupSaveControlsPage();
					}
    			}

				refreshPagesList();
			} //end savePhoebusPageAs()


			//=====================================================================================
			function refreshPagesList()
			{
				console.log("Slow Controls Dashboard: refreshPagesList()");

			 	DesktopContent.XMLHttpRequest(
                                	"Request?RequestType=getPages",
                                         "", 
                                         pagesReqHandler,
                                         0 /*reqParam*/, 
                                         0 /*progressHandler*/, 
                                         0 /*callHandlerOnErr*/, 
                                         true /*doNoShowLoadingOverlay*/);

				window.setTimeout(
					function()
					{
						fileBlock_.el.firstElementChild.contentDocument.body.onload()
					},1000);
			} //end refreshPagesList()


			//=====================================================================================
			//	expecting id as 'widget-#' ..and this function extracts the 
			//	widget UID as integer #
			function setupWidget(id, parameters)
			{
				console.log("setting up widget! " + id);
				id = id.split('-')[1];

				if(page_.widgets[id] === undefined)
				{
					Debug.log("Illegal widget UID (not found in widget list) received from child widget frame: " + 
							id, Debug.HIGH_PRIORITY);
					return;
				}

				page_.widgets[id].loaded = true;

				compareAttributes(id, parameters);

				//now page_.widgets[id].attributes is merged
				console.log("page_.widgets[id].attributes", page_.widgets[id].attributes);

				var pvListCSV = "";

				console.log("page_.widgets[id].pvList", page_.widgets[id].pvList);
				for(var pv in page_.widgets[id].pvList)
				{
					pvListCSV += pv + ",";
				}

				var passParams = [id, page_.widgets[id].attributes];	
				DesktopContent.XMLHttpRequest("Request?RequestType=getPVSettings",
							//post data 
    						"pvList=" + pvListCSV + 
							"&id=" + id,
							settingsReqHandler /*handler*/,
							passParams /*parameter*/);

			} //end setupWidget()


			//=====================================================================================
			function setWidgetToolTip(pvName, pvValue, pvTime, pvStatus, pvSeverity, pv_settings_)
			{
				var toolTip =
				pvName
				+ "\nLast value: "
				+ pvValue
				+ " "
				+ pv_settings_[pvName].Units
				+ "\nTime: "
				+ ConfigurationAPI.getDateString(new Date((pvTime | 0) * 1000))
				+ "\nStatus: "
				+ pvStatus
				+ "\nSeverity: "
				+ pvSeverity
				+ "\nLower Warning Limit:  " + Number.parseFloat(pv_settings_[pvName].Lower_Warning_Limit).toExponential(2) + "\n"
			  	+ "Upper Warning Limit:  "   + Number.parseFloat(pv_settings_[pvName].Upper_Warning_Limit).toExponential(2) + "\n"
			  	+ "Lower Alarm Limit:    "   + Number.parseFloat(pv_settings_[pvName].Lower_Alarm_Limit).toExponential(2)   + "\n"
			  	+ "Upper Alarm Limit:    "   + Number.parseFloat(pv_settings_[pvName].Upper_Alarm_Limit).toExponential(2)   + "\n"
			  	+ "Lower Control Limit:   "  + Number.parseFloat(pv_settings_[pvName].Lower_Control_Limit).toExponential(2) + "\n"
			  	+ "Upper Control Limit:   "  + Number.parseFloat(pv_settings_[pvName].Upper_Control_Limit).toExponential(2) + "\n"
			  	+ "Lower Display Limit:   "  + Number.parseFloat(pv_settings_[pvName].Lower_Display_Limit).toExponential(2) + "\n"
			  	+ "Upper Display Limit:   "  + Number.parseFloat(pv_settings_[pvName].Upper_Display_Limit).toExponential(2) + "\n";
			  	return toolTip;
			} //end setWidgetToolTip()


			//=====================================================================================
			function checkPVTime(id, pvName, pvTime)
			{
				id = id.split('-')[1];
				var actualTime = Math.floor(Date.now())/1000;
				var time2compare = pvTime*1. + 10.*page_.widgets[id].pvList[pvName]/1000;
				console.log(
							  "thermometer date now: "
							+ actualTime
							+ " pvtime: "
							+ pvTime
							+ " refresh rate: "
							+ page_.widgets[id].pvList[pvName]
							);

				if ((pvTime !== undefined) && (time2compare > actualTime)) return true;
				return false;
			} //end checkPVTime()


			//=====================================================================================
			function setWidgetPVinfo(id, pvName, pvValue, pvTime, pvStatus, pvSeverity, showLabel, containers, foregroundColor, bkgColor, border, widgetElement)
			{
				var actualTime = Math.floor(Date.now())/1000;
				if (containers !== null && containers[pvName] !== null)
					if (showLabel == "true")
					{
						if(pvSeverity == "MAJOR" )
							containers[pvName].innerHTML = "<center style = 'color: red'>" + pvName.replace(/[&\/\\#,+()$~%.:*?<>{}]/g, "<br />") + "<br>Status: " + pvStatus + "<br>Severity: " + pvSeverity + "</center>";
						else if(pvSeverity == "MINOR")
							containers[pvName].innerHTML = "<center style = 'color: orange'>" + pvName.replace(/[&\/\\#,+()$~%.:*?<>{}]/g, "<br />") + "<br>Status: " + pvStatus + "<br>Severity: " + pvSeverity + "</center>";
						else
							if (checkPVTime(id, pvName, pvTime))
								containers[pvName].innerHTML = "<center style = 'color: green'>" + pvName.replace(/[&\/\\#,+()$~%.:*?<>{}]/g, "<br />") + "<br>Status: " + pvStatus + "<br>Severity: " + pvSeverity + "</center>";
							else
								containers[pvName].innerHTML = "<center style = 'color:" + foregroundColor + "'>"
																+ pvName.replace(/[&\/\\#,+()$~%.:*?<>{}]/g, "<br />")
																//+ "<br>Status: " + pvStatus + "<br>Severity: " + pvSeverity
																+ "<br>NOT UPDATED FOR MORE THAN " + parseInt((actualTime - pvTime*1.)/60) + " MINUTES</center>";
					}
					else
						containers[pvName].innerHTML = "<center>";

				if (widgetElement !== null && widgetElement !== undefined)
				{
					if (checkPVTime(id, pvName, pvTime))
						widgetElement.style.backgroundColor = 'white';
					else
						widgetElement.style.backgroundColor = bkgColor;
					
					if(pvSeverity == "MAJOR" )
						widgetElement.style.border = "2px solid red";
					else
						widgetElement.style.border = border;
				}
				else
					console.log("setWidgetPVinfo(): widgetElement is null or not defined!");
			} //end setWidgetPVinfo()


			//=====================================================================================
			function getPVHistory(id, parameters)
			{
				var pvList = "";

				id = id.split('-')[1];
				
				if(page_.widgets[id] === undefined)
				{
					Debug.log("Illegal widget UID (not found in widget list) received from child widget frame: " + 
							id, Debug.HIGH_PRIORITY);
					return;
				}

				for(var pv in page_.widgets[id].pvList)
				{
					pvList += pv + ",";
				}

				var actualTime = Math.floor(Date.now())/1000;
				var startTime = actualTime - 6*3600;
				var endTime = actualTime;

				var passParams = [id, parameters];
				DesktopContent.XMLHttpRequest("Request?RequestType=getPvArchiverData",
									//post data 
		    						"pvList=" + pvList + 
									"&id=" + id +
									"&startTime=" + startTime +
									"&endTime=" + endTime,
									pvHistoryReqHandler /*handler*/,
									 passParams /*parameter*/);
				console.log("get history for widget! pvList: " + pvList);
			} //end getPVHistory()


			//=====================================================================================
			function addPVToWidget(pv, refreshRate, widgetID, fromAddPV)
			{
				if(fromAddPV){toggleAddPV();}
				page_.widgets[widgetID].pvList[pv] = refreshRate;
				page_.widgets[widgetID].el.contentWindow.init();
			} //end addPVToWidget()


			//=====================================================================================
			function compareAttributes(id, parameters)
			{
				var actionRequired = false;

				var attributesNew = {};

				for(attribute = 0; attribute < Object.keys(parameters).length; attribute++)
				{
					if(Object.keys(page_.widgets[id].attributes).indexOf(Object.keys(parameters)[attribute]) != -1)
					{
						attributesNew[Object.keys(parameters)[attribute]] = page_.widgets[id].attributes[Object.keys(parameters)[attribute]];
					}
					else
					{
						actionRequired = true;

						if (parameters[Object.keys(parameters)[attribute]] == "")
							attributesNew[Object.keys(parameters)[attribute]] = 'undefined';
						else
							attributesNew[Object.keys(parameters)[attribute]] = parameters[Object.keys(parameters)[attribute]];

						//Debug.log("Attribute [" + Object.keys(parameters)[attribute] + "] for " + page_.widgets[id].displayName + " is now a required attribute. Action Required.", Debug.HIGH_PRIORITY);
					}
				}

				page_.widgets[id].attributes = attributesNew;
			} //end compareAttributes()


			//=====================================================================================
			//This function is called by edit pane code when
			//	a widget is selected for edit mode drawing.
			function setupForDrawSelectionRectangle(id)
			{
				Debug.log("parent level setupForDrawSelectionRectangle " + id);

				indicateUserActivityToServer();		

				if(id === undefined)
				{
					//treat as clearing drag and draw type mode
					mainBlock_.el.style.cursor = "default";
					dragAndDrawWidgetType_ = undefined;
				}
				else //drag-and-draw type was selected
				{
					//crosshair primary indicator to user that draw and drag is active
					mainBlock_.el.style.cursor = "crosshair";
					dragAndDrawWidgetType_ = id|0; //force integer type id
				}

			} //end setupForDrawSelectionRectangle()


			//=====================================================================================
			function drawSelectionRectangle(event)
			{
				event.stopPropagation();

				if(dragAndDrawWidgetType_  === undefined)
				{
					Debug.log("Impossible undefined widget draw type! Notify admins.", Debug.HIGH_PRIORITY);
					return;
				}
				var type = dragAndDrawWidgetType_;
				drawingSelectionRectangle_  = true;

				Debug.log("drawSelectionRectangle() " + type);
				var x = snapToGrip(event.clientX, GRIDSIZE_);
				var y = snapToGrip(event.clientY, GRIDSIZE_);
				xPos_ = x;
				yPos_ = y;

				var selectionRectangle = document.getElementById("selectionRectangle");
				selectionRectangle.style.top  = y + "px";
				selectionRectangle.style.left = x + "px";	

				if(widgetLibrary.dimensions[type])
				{
					console.log("selectionRectangle type:" + type);
					if(widgetLibrary.dimensions[type]["Default Width"])
					{
						console.log("Has a specified width", widgetLibrary.dimensions[type]["Default Width"]);
						selectionRectangle.style.width = (widgetLibrary.dimensions[type]["Default Width"] + "px");
					}
					else
					{
						selectionRectangle.style.width = "1px";
					}

					if(widgetLibrary.dimensions[type]["Default Height"])
					{
						console.log("Has a specified height");
						selectionRectangle.style.height = (widgetLibrary.dimensions[type]["Default Height"] + "px");
					}
					else
					{
						selectionRectangle.style.height = "1px";
					}

					if(widgetLibrary.dimensions[type]["Scale"] != "False")
					{
						console.log("Widget is scalable");
					}	
				}
				else //Default - no aspect ratio, no min size, 
				{
					selectionRectangle.style.height = "1px";
					selectionRectangle.style.width = "1px";
				}

				selectionRectangle.style.display = "block";
			} //end drawSelectionRectangle()


			//=====================================================================================
			function redrawSelectionRectangle(event) 
			{
				var type = dragAndDrawWidgetType_;
				//Debug.log("redrawSelectionRectangle() " + type);

				var drawAndDragBox = document.getElementById("selectionRectangle");

				var ex = snapToGrip(event.clientX, GRIDSIZE_);
				var ey = snapToGrip(event.clientY, GRIDSIZE_);
				var x = xPos_;
				var y = yPos_;
				var w = (ex - xPos_);
				var h = (ey - yPos_);
				if(w < 0)
				{
					x = ex;
					w *= -1;
				}
				if(h < 0)
				{
					y = ey;
					h *= -1;
				}

				drawAndDragBox.style.left = x + "px";
				drawAndDragBox.style.top = y + "px";	

				if(widgetLibrary.dimensions[type] && 
						widgetLibrary.dimensions[type]["Y"] && 
						widgetLibrary.dimensions[type]["X"])
				{ //if forced aspect ratio, then maintain aspect ratio

					var aspect_ratio = parseFloat(widgetLibrary.dimensions[type]["X"]) /
							parseFloat(widgetLibrary.dimensions[type]["Y"]);

					if((h > widgetLibrary.dimensions[type]["Y"]) ||
							(w > widgetLibrary.dimensions[type]["X"]))
					{
						var adjusted_y_displacement = h * aspect_ratio;

						if(adjusted_y_displacement >= w)
						{
							drawAndDragBox.style.width = parseFloat(h * aspect_ratio) + "px";
							drawAndDragBox.style.height = h + "px";						
						}
						else
						{							
							drawAndDragBox.style.width = w + "px";
							drawAndDragBox.style.height = parseFloat(w / aspect_ratio) + "px";					
						}
					}
				}
				else //free draw, no aspect constraint
				{					
					drawAndDragBox.style.width = w + "px";
					drawAndDragBox.style.height = h + "px";						
				}
			} //end redrawSelectionRectangle()


			//=====================================================================================
			function stopDragAndDrawRectangle(event) 
			{
				var type = dragAndDrawWidgetType_;
				Debug.log("stopDragAndDrawRectangle() " + type);

				var drawAndDragBox = document.getElementById("selectionRectangle");

				//console.log((event.clientX - xPos_));
				//console.log(drawAndDragBox.style.width);

				var x,y,w,h;
				x = snapToGrip(drawAndDragBox.offsetLeft, GRIDSIZE_);
				y = snapToGrip(drawAndDragBox.offsetTop, GRIDSIZE_);

				//if widget attribute Scale is set to false, then always a fixed size
				if(widgetLibrary.dimensions[type] &&
						widgetLibrary.dimensions[type]["Scale"] && 
						widgetLibrary.dimensions[type]["Scale"].toLowerCase() == "false")
				{
					w = widgetLibrary.dimensions[type]["X"]|0;
					h = widgetLibrary.dimensions[type]["Y"]|0;
				}
				else  //else Scale is true which means that the drawAndDragBox from draw-and-drag sets the size
				{
					w = drawAndDragBox.offsetWidth;
					h = drawAndDragBox.offsetHeight;
				}

				drawWidget(undefined /*need widget uid assigned*/,
						type,
						x,y,w,h);

				//clear globals back to not drawing mode
				mainBlock_.el.style.cursor = "default";//"crosshair"; //"default";
				drawAndDragBox.style.display = "none";
				drawingSelectionRectangle_  = false;
				dragAndDrawWidgetType_ = undefined;
				editBlock_.el.firstChild.contentWindow.selectWidgetTile(); //unselect in edit block
			} //end stopDragAndDrawRectangle()


			//=====================================================================================
			function openTabPage(e) 
			{
				Debug.log("openTabPage",e.target.id);
				targetTabBodyId_ = e.target.id.replace("tabSelectButton","tabBody");				
				
				//allow race condition to endWidgetDragAndResize() to win
				window.clearTimeout(dragTimeout_);				
				dragTimeout_ = window.setTimeout(
					function()
					{
						startWidgetDrag(e,e.target.id.split('-')[1]|0);	
					}, 300 /*ms*/);
			} // end openTabPage()

			//=====================================================================================
			function checkWidgetInTabBody(widget, tabWidget)
			{
				if (widget.x >= tabWidget.x && widget.y >= tabWidget.y
				    && ((widget.x + widget.w) <= (tabWidget.x + tabWidget.w))
				    && ((widget.y + widget.h) <= (tabWidget.y + tabWidget.h)))
					return true;
				return false;
			} //end checkWidgetInTabBody()


			//=====================================================================================
			function drawTabWidgets(id, type, widgetObject)
			{
				var str = "";
				if (!widgetObject.attributes["tabs_num"])
					widgetObject.attributes["tabs_num"] = 3;

				var STARTING_TAB_COUNT = widgetObject.attributes["tabs_num"];

				var tabEl = document.createElement("div");
				tabEl.className = "tabWidgetTabContainer";
				for(var i=0;i<STARTING_TAB_COUNT;++i)
				{
					if (!widgetObject.attributes["tabname_"+i])
						widgetObject.attributes["tabname_"+i] = "Tab " + i;

					str += "<div id='widget-" + id + "-tabSelectButton-" + i
						+ "'' style='background-color:" + (i == 0?"#777":"") +
						"'class='tabWidgetSelectButton'>"
						+ widgetObject.attributes["tabname_"+i]
						+ "</div>";
				}
				tabEl.innerHTML = str;

				widgetObject.el.appendChild(tabEl);

				var tabBodyEl = document.createElement("div");
				tabBodyEl.className = "tabWidgetBodyContainer";
				str = "";
				for(var i=0;i<STARTING_TAB_COUNT;++i)						
					str += "<div id='widget-" + id + "-tabBody-" + i + 
						"'' style='display:" + (i == 0?"block":"none") + 
						"' class='tabWidgetBody'>Tab Body " + i + "</div>";

				tabBodyEl.innerHTML = str;

				widgetObject.el.appendChild(tabBodyEl);

				//for every tab and body, add mouse handlers
				var tabBodies = widgetObject.el.getElementsByClassName("tabWidgetBody");
				for (var i = 0; i < tabBodies.length; i++)
				{
					tabBodies[i].addEventListener("mousedown", 
							makeHandlerWithID(id,		handleWidgetCoverMouseDown));
					tabBodies[i].addEventListener("mouseup", 
							makeHandlerWithID(id,		endWidgetDragAndResize));
					tabBodies[i].addEventListener("mousemove", 
						function()
						{
							if(!drawingSelectionRectangle_ && 
								dragAndDrawWidgetType_ !== undefined)
								this.style.cursor = "crosshair";
							else
								this.style.cursor = "grab";
						});

				} //end tab body handlers
				var tabButtons = widgetObject.el.getElementsByClassName("tabWidgetSelectButton");		
				for (var i = 0; i < tabButtons.length; i++)
				{
					tabButtons[i].addEventListener("mousedown", openTabPage);
					tabButtons[i].addEventListener("mouseup", 
							makeHandlerWithID(id, endWidgetDragAndResize));
				} //end tab button handlers

				if(type == WIDGET_TYPE_NAVTAB)
				{
					Debug.log("Show starting point widgets");
					window.setTimeout(
						function()							
						{
							var tabBodyPages = [];
							for(var i=0;i<STARTING_TAB_COUNT;++i)
								if (widgetObject.attributes["file_" + i])
									tabBodyPages[i] = widgetObject.attributes["file_" + i];
								else
									widgetObject.attributes["file_" + i] = "";

							Debug.log("Loading a file",id);
							for(var i=0;i<tabBodyPages.length;++i)
								loadPhoebusPage(tabBodyPages[i],
									"widget-" + id + "-tabBody-" + i);
						}, 1000);
				}
			} //end drawTabWidgets()


			//================================================================================
			//draws widget based on id
			//	if id === undefined, then creates new uid widget
			//	if new parameters are defined they are placed in widget object
			//	if hideFrame, hides the iframe and widget content (more moving and resizing).
			function drawWidget(id, type, newx, newy, neww,
					newh, hideFrame)
			{			
				//console.log("drawWidget() id=",id,
				//		" type=",type);

				var OUTLINE_OFFSET = 5;
				
				var containerDiv;
				var widgetCover;

				var resizeDiv;
				var resizeDivTop;
				var resizeDivLeft;
				var resizeDivRight;
				var resizeDivBottom;
				var resizeDivTopLeft;
				var resizeDivTopRight;
				var resizeDivBottomRight;
				var resizeDivBottomLeft;

				var editIcon, otherEditIcon;

				var z = 50;

				//Steps:
				//	- check page_ object for widget details
				//		* if missing, add to object
				//	- check page for widget elements
				//		* if missing, add to page

				if(page_ === undefined)
				{
					Debug.log("Impossible page object missing! Notify admins", Debug.HIGH_PRIORITY);
					return;
				}

				if(page_.widgets == undefined)
				{
					page_.widgets = {};
				}

				var widgetObject;

				if(id === undefined || page_.widgets[id] === undefined)
				{					
					Debug.log("Creating new widget object..");

					//start at number of widgets, and then keep adding 1 until no record found in 
					id = Object.keys(page_.widgets).length;
					while(page_.widgets[id] !== undefined)
						++id;
					Debug.log("Found new available widget ID = " + id);

					page_.widgets[id] = {}; //start new widget object
					widgetObject = page_.widgets[id];

					widgetObject.pvList 		= {};
					widgetObject.attributes 	= {};
					widgetObject.displayName 	= "widget-" + id;
					widgetObject.loaded 		= false;
					widgetObject.tabBodyID		= targetTabBodyId_?targetTabBodyId_:"";
					//attempt to get element, ok if undefined (will be created)
					widgetObject.el				= document.getElementById("widget-" + id);
				} //end new widget object handling
				else
					widgetObject = page_.widgets[id];

				{ //filling widget object with new parameters

					//all x,y,w,h represented as "per thousand" (PAGE_POSITIONS_ positions, integer representation)
					if(newx !== undefined)
						widgetObject.x 		= toScaledXCoordinate(newx);
					if(newy !== undefined)
						widgetObject.y 		= toScaledYCoordinate(newy);
					if(neww !== undefined)
						widgetObject.w 		= toScaledXCoordinate(neww);
					if(newh !== undefined)
						widgetObject.h 		= toScaledYCoordinate(newh);

					if(type !== undefined)
						widgetObject.type 	= type | 0; //force integer type
				} //end filling widget object with new parameters

				if(!widgetObject.el)
				{
					Debug.log("Creating widget elements for widget" + id);

					containerDiv = document.createElement("div");
					containerDiv.className = "widgetContainerDiv";
					containerDiv.id = "widget-" + id + "-container";
					containerDiv.style.zIndex = Object.keys(page_.widgets).length;

					if(type == WIDGET_TYPE_TAB || type == WIDGET_TYPE_NAVTAB)
					{
						Debug.log("Making simple tab structure, not iframe.");

						widgetObject.el = document.createElement("div");
						widgetObject.el.id = "widget-" + id;
						drawTabWidgets(id, type, widgetObject);
					}
					else
					{
						widgetObject.el = document.createElement("iframe");
						widgetObject.el.scrolling="No";
						widgetObject.el.id = "widget-" + id;

						widgetObject.el.src = "widgets/" + 
								widgetLibrary.typeToSrc[widgetObject.type];
						widgetObject.el.style.border = "0";
						widgetObject.el.innerHTML = widgetObject.displayName;
					}

					widgetCover = document.createElement("div");
					widgetCover.className = "widgetCover";
					widgetCover.id = "widget-" + id + "-cover";

					resizeDiv = document.createElement("div");
					resizeDiv.className = "resizeWidgetCover";
					resizeDiv.id = "widget-" + id + "-resize-cover";

					//Create elements to handle the different resize arrows
					{ //resize sides
						resizeDivTop = document.createElement("div");
						resizeDivTop.className = "resizeWidgetCoverTop";
						resizeDivTop.id = "widget-" + id + "-resize-cover-north";
						resizeDivTop.style.cursor = "ns-resize";

						resizeDivLeft = document.createElement("div");
						resizeDivLeft.className = "resizeWidgetCoverLeft";
						resizeDivLeft.id = "widget-" + id + "-resize-cover-west";
						resizeDivLeft.style.cursor = "ew-resize";

						resizeDivRight = document.createElement("div");
						resizeDivRight.className = "resizeWidgetCoverRight";
						resizeDivRight.id = "widget-" + id + "-resize-cover-east";
						resizeDivRight.style.cursor = "ew-resize";

						resizeDivBottom = document.createElement("div");
						resizeDivBottom.className = "resizeWidgetCoverBottom";
						resizeDivBottom.id = "widget-" + id + "-resize-cover-south";
						resizeDivBottom.style.cursor = "ns-resize";
					} //end resize sides

					{ //resize corners
						resizeDivTopLeft = document.createElement("div");
						resizeDivTopLeft.className = "resizeWidgetCoverTopLeft";
						resizeDivTopLeft.id = "widget-" + id + "-resize-cover-northwest";
						resizeDivTopLeft.style.cursor = "nwse-resize";

						resizeDivTopRight = document.createElement("div");
						resizeDivTopRight.className = "resizeWidgetCoverTopRight";
						resizeDivTopRight.id = "widget-" + id + "-resize-cover-northeast";
						resizeDivTopRight.style.cursor = "nesw-resize";

						resizeDivBottomRight = document.createElement("div");
						resizeDivBottomRight.className = "resizeWidgetCoverBottomRight";
						resizeDivBottomRight.id = "widget-" + id + "-resize-cover-southeast";
						resizeDivBottomRight.style.cursor = "nwse-resize";

						resizeDivBottomLeft = document.createElement("div");
						resizeDivBottomLeft.className = "resizeWidgetCoverBottomLeft";
						resizeDivBottomLeft.id = "widget-" + id + "-resize-cover-southwest";
						resizeDivBottomLeft.style.cursor = "nesw-resize";
					} //end resize corners

					editIcon = document.createElement("div");
					editIcon.className = "widgetEditIcon";
					editIcon.id = "widget-" + id + "-editIcon";
					editIcon.title = "Edit the attributes and PV-list for this widget-" +
						id + ".";
					editIcon.onmouseup = makeHandlerWithID(id,
							toggleContextMenu);
					editIcon.onmousedown = function(e){e.stopPropagation();}

					otherEditIcon = document.createElement("div");
					otherEditIcon.className = "widgetEditIcon widgetOtherEditIcon";
					otherEditIcon.id = "widget-" + id + "-otherEditIcon";
					otherEditIcon.title = "Edit the attributes and PV-list for this widget-" + 
						id + ".";
					otherEditIcon.onmouseup = makeHandlerWithID(id,
							toggleContextMenu);
					otherEditIcon.onmousedown = function(e){e.stopPropagation();}				

					widgetCover.addEventListener("mousedown", 
							makeHandlerWithID(id,		handleWidgetCoverMouseDown));
					widgetCover.addEventListener("mouseup", 
							makeHandlerWithID(id,		endWidgetDragAndResize));
					widgetCover.addEventListener("mousemove", 
						function()
						{
							if(!drawingSelectionRectangle_ && 
								dragAndDrawWidgetType_ !== undefined)
								this.style.cursor = "crosshair";
							else
								this.style.cursor = "grab";
						});

					resizeDivTop.addEventListener("mousedown", 
							makeHandlerWithID(id,		startWidgetResize));
					resizeDivLeft.addEventListener("mousedown", 
							makeHandlerWithID(id,		startWidgetResize));
					resizeDivRight.addEventListener("mousedown", 
							makeHandlerWithID(id,		startWidgetResize));
					resizeDivBottom.addEventListener("mousedown", 
							makeHandlerWithID(id,		startWidgetResize));
					resizeDivTopLeft.addEventListener("mousedown", 
							makeHandlerWithID(id,		startWidgetResize));
					resizeDivTopRight.addEventListener("mousedown", 
							makeHandlerWithID(id,		startWidgetResize));
					resizeDivBottomRight.addEventListener("mousedown", 
							makeHandlerWithID(id,		startWidgetResize));
					resizeDivBottomLeft.addEventListener("mousedown", 
							makeHandlerWithID(id,		startWidgetResize));

					resizeDivTop.addEventListener("mouseup", 
							makeHandlerWithID(id,		endWidgetDragAndResize));
					resizeDivLeft.addEventListener("mouseup", 
							makeHandlerWithID(id,		endWidgetDragAndResize));
					resizeDivRight.addEventListener("mouseup", 
							makeHandlerWithID(id,		endWidgetDragAndResize));
					resizeDivBottom.addEventListener("mouseup", 
							makeHandlerWithID(id,		endWidgetDragAndResize));
					resizeDivTopLeft.addEventListener("mouseup", 
							makeHandlerWithID(id,		endWidgetDragAndResize));
					resizeDivTopRight.addEventListener("mouseup", 
							makeHandlerWithID(id,		endWidgetDragAndResize));
					resizeDivBottomRight.addEventListener("mouseup", 
							makeHandlerWithID(id,		endWidgetDragAndResize));
					resizeDivBottomLeft.addEventListener("mouseup", 
							makeHandlerWithID(id,		endWidgetDragAndResize));

					resizeDiv.appendChild(resizeDivTop);
					resizeDiv.appendChild(resizeDivLeft);
					resizeDiv.appendChild(resizeDivRight);
					resizeDiv.appendChild(resizeDivBottom);
					resizeDiv.appendChild(resizeDivTopRight);
					resizeDiv.appendChild(resizeDivTopLeft);
					resizeDiv.appendChild(resizeDivBottomRight);
					resizeDiv.appendChild(resizeDivBottomLeft);

					resizeDiv.appendChild(editIcon);
					resizeDiv.appendChild(otherEditIcon);


					containerDiv.appendChild(resizeDiv);
					containerDiv.appendChild(widgetCover);


					containerDiv.appendChild(widgetObject.el);

					//if in a tab widget, add directly
					if(widgetObject.tabBodyID && widgetObject.tabBodyID != "")
						addWidgetToTabBody(id,widgetObject.tabBodyID);
					else
						mainBlock_.el.appendChild(containerDiv);
				}
				else //iframe and elements already exist
				{
					containerDiv 			= document.getElementById("widget-" + id + "-container");
					widgetCover 			= document.getElementById("widget-" + id + "-cover");

					editIcon 				= document.getElementById("widget-" + id + "-editIcon");
					otherEditIcon 				= document.getElementById("widget-" + id + "-otherEditIcon");					

					resizeDiv 				= document.getElementById("widget-" + id + "-resize-cover");

					//Sides for resize
					resizeDivTop 			= document.getElementById("widget-" + id + "-resize-cover-north");
					resizeDivLeft 			= document.getElementById("widget-" + id + "-resize-cover-west");
					resizeDivRight 			= document.getElementById("widget-" + id + "-resize-cover-east");
					resizeDivBottom 		= document.getElementById("widget-" + id + "-resize-cover-south");

					//Corners for resize
					resizeDivTopLeft 		= document.getElementById("widget-" + id + "-resize-cover-northwest");
					resizeDivTopRight 		= document.getElementById("widget-" + id + "-resize-cover-northeast");
					resizeDivBottomRight 	= document.getElementById("widget-" + id + "-resize-cover-southeast");
					resizeDivBottomLeft 	= document.getElementById("widget-" + id + "-resize-cover-southwest");

					//hide and show widget children properly
					if(widgetObject.type == WIDGET_TYPE_TAB || 
						widgetObject.type == WIDGET_TYPE_NAVTAB)
					{				
						Debug.log("Drawing tab widget..");

						var tabBodies = widgetObject.el.getElementsByClassName("tabWidgetBody");						
						if(targetTabBodyId_ == "")
							targetTabBodyId_ = undefined;
						//find active tab body (if not specified)
						for (var i = 0; i < tabBodies.length; i++) 
						{
							if ((targetTabBodyId_ !== undefined &&
								tabBodies[i].id == targetTabBodyId_) ||
								(targetTabBodyId_ === undefined &&
								tabBodies[i].style.display == "block"))
							{
								targetTabBodyId_ = tabBodies[i].id;
								tabBodies[i].style.display = "block";
							}
							else
								tabBodies[i].style.display = "none";
						}

						//clear tab button colors
						var tabButtons = widgetObject.el.getElementsByClassName("tabWidgetSelectButton");						
						for (i = 0; i < tabButtons.length; i++) 
							tabButtons[i].style.backgroundColor = "";	

						if(!tabBodies.length) return;

						//if no body is active, activate the first one now!
						if(targetTabBodyId_ === undefined)
						{
							tabBodies[0].style.display = "block";
							targetTabBodyId_ = tabBodies[0].id;
						}

						var activeTabButton = document.getElementById(
							targetTabBodyId_.replace("tabBody","tabSelectButton"));
						activeTabButton.style.backgroundColor = "#777";
						

						Debug.log("Done drawing tab widget..");
						
					} //end tab content draw handling
				}

				//now type object has been updated, now apply sizes in pixel units
				var x = toPageXCoordinate(widgetObject.x); //get "pixel units"
				var y = toPageYCoordinate(widgetObject.y); //get "pixel units"
				var w = toPageXCoordinate(widgetObject.w); //get "pixel units"
				var h = toPageYCoordinate(widgetObject.h); //get "pixel units"

				containerDiv.style.width = w + "px";
				containerDiv.style.height = h + "px";
				containerDiv.style.position = "absolute";
				containerDiv.style.left = x + "px";
				containerDiv.style.top = y + "px";
				//containerDiv.style.zIndex = "5";

				widgetCover.style.width = w + "px";
				widgetCover.style.height = h + "px";
				widgetCover.style.position = "absolute";
				widgetCover.style.left = "0px";
				widgetCover.style.top = "0px";
				widgetCover.style.zIndex = z;

				//tab widgets should use tabs to move widget, so hide this cover
				if(type == WIDGET_TYPE_TAB || type == WIDGET_TYPE_NAVTAB)
					widgetCover.style.display = "none";

				resizeDiv.style.width = (w + (2 * OUTLINE_OFFSET)) + "px";
				resizeDiv.style.height = (h + (2 * OUTLINE_OFFSET)) + "px";
				resizeDiv.style.position = "absolute";
				resizeDiv.style.left = -(OUTLINE_OFFSET) + "px";
				resizeDiv.style.top = -(OUTLINE_OFFSET) + "px";
				resizeDiv.style.zIndex = z-1;

				//To handle the different resize arrows
				//Edges for resize
				resizeDivTop.style.width = w + "px";
				resizeDivTop.style.height = OUTLINE_OFFSET + "px";
				resizeDivTop.style.position = "absolute";
				resizeDivTop.style.left = OUTLINE_OFFSET + "px";
				resizeDivTop.style.top = "0px";
				resizeDivTop.style.zIndex = z-1;

				resizeDivLeft.style.width = OUTLINE_OFFSET + "px";
				resizeDivLeft.style.height = h + "px";
				resizeDivLeft.style.position = "absolute";
				resizeDivLeft.style.left ="0px";
				resizeDivLeft.style.top = OUTLINE_OFFSET + "px";
				resizeDivLeft.style.zIndex = z-1;

				resizeDivRight.style.width = OUTLINE_OFFSET + "px";
				resizeDivRight.style.height = h + "px";
				resizeDivRight.style.position = "absolute";
				resizeDivRight.style.right = "0px";
				resizeDivRight.style.top = OUTLINE_OFFSET + "px";
				resizeDivRight.style.zIndex = z-1;

				resizeDivBottom.style.width = w + "px";
				resizeDivBottom.style.height = OUTLINE_OFFSET + "px";
				resizeDivBottom.style.position = "absolute";
				resizeDivBottom.style.left = OUTLINE_OFFSET + "px";
				resizeDivBottom.style.bottom = "0px";
				resizeDivBottom.style.zIndex = z-1;

				//Corners for resize
				resizeDivTopLeft.style.width = OUTLINE_OFFSET + "px";
				resizeDivTopLeft.style.height = OUTLINE_OFFSET + "px";
				resizeDivTopLeft.style.position = "absolute";
				resizeDivTopLeft.style.left = "0px";
				resizeDivTopLeft.style.top = "0px";
				resizeDivTopLeft.style.zIndex = z-1;

				resizeDivTopRight.style.width = OUTLINE_OFFSET + "px";
				resizeDivTopRight.style.height = OUTLINE_OFFSET + "px";
				resizeDivTopRight.style.position = "absolute";
				resizeDivTopRight.style.right = "0px";
				resizeDivTopRight.style.top = "0px";
				resizeDivTopRight.style.zIndex = z-1;

				resizeDivBottomRight.style.width = OUTLINE_OFFSET + "px";
				resizeDivBottomRight.style.height = OUTLINE_OFFSET + "px";
				resizeDivBottomRight.style.position = "absolute";
				resizeDivBottomRight.style.right = "0px";
				resizeDivBottomRight.style.bottom = "0px";
				resizeDivBottomRight.style.zIndex = z-1;

				resizeDivBottomLeft.style.width = OUTLINE_OFFSET + "px";
				resizeDivBottomLeft.style.height = OUTLINE_OFFSET + "px";
				resizeDivBottomLeft.style.position = "absolute";
				resizeDivBottomLeft.style.left = "0px";
				resizeDivBottomLeft.style.bottom = "0px";
				resizeDivBottomLeft.style.zIndex = z-1;

				editIcon.style.position = "absolute";
				editIcon.style.right = 0 + "px";
				editIcon.style.top = h + "px";
				editIcon.style.zIndex = z-1;

				otherEditIcon.style.position = "absolute";
				otherEditIcon.style.left = 0 + "px";
				otherEditIcon.style.top = 0 + "px";
				otherEditIcon.style.zIndex = z-1;

				if(!hideFrame)
				{
					widgetObject.el.style.position = "absolute";
					widgetObject.el.style.width = w + "px";
					widgetObject.el.style.height = h + "px";
					widgetObject.el.style.left = 0 + "px";
					widgetObject.el.style.top = 0 + "px";
				}

				setEditModeWidgetTarget(widgetObject.el);
				widgetObject.el.style.display = hideFrame?"none":"block";
			} //end drawWidget()


			//================================================================================
			//widget x,y,w,h represented as "per thousand" scaled coordinates
			//	(PAGE_POSITIONS_ positions, integer representation)
			function toPageXCoordinate(x)
			{ return Math.round(x * windowWidth_ / PAGE_POSITIONS_); }
			function toPageYCoordinate(y)
			{ return Math.round(y * windowHeight_ / PAGE_POSITIONS_); }
			function toScaledXCoordinate(x)
			{ return Math.round(PAGE_POSITIONS_ * x / windowWidth_); }
			function toScaledYCoordinate(y)
			{ return Math.round(PAGE_POSITIONS_ * y / windowHeight_); }
			//end page and scaled coordinate conversion


			//=====================================================================================
			function mouseoverEditBlock(e)
			{
				Debug.log("mouseoverEditBlock()");
				editBlock_.el.style.marginBottom = (
						EDIT_BLOCK_HEIGHT
						- EDIT_BLOCK_PEEK_HEIGHT) + "px";
			} // end mouseoverEditBlock()


			//=====================================================================================
			function mouseoutEditBlock(e)
			{
				Debug.log("mouseoutEditBlock()");
				editBlock_.el.style.marginBottom = 0 + "px";
			} //end mouseoutEditBlock()


			//================================================================================
			function toggleEditMode()
			{
				Debug.log("Toggle Edit Mode");

				mouseoutEditBlock();
				//mouseoverEditBlock();

				var covers = document.getElementsByClassName("widgetCover");
			    var resize_covers = document.getElementsByClassName("resizeWidgetCover");
				var editButton = document.getElementById("menuli2");

				if(editBlock_.isHidden && !isReadOnly_)
				{
					Debug.log("Edit Mode On");
					document.getElementById("menuli3").innerHTML = "";

					editBlock_.isHidden = false;
					editBlock_.el.style.display = "block";
					editButton.innerHTML = "Go Live!";

					//Make sure pv list is up-to-date
					DesktopContent.XMLHttpRequest(
						"Request?RequestType=getList",
						"", 
						pvListReqHandler /*returnHandler*/, 
						0 /*reqParam*/, 
						0 /*progressHandler*/, 
						0 /*callHandlerOnErr*/, 
						false /*doNoShowLoadingOverlay*/);

					UID_ = 0;

					window.clearTimeout(timerVariable_);
					window.clearTimeout(lastAlarmsTimerVariable_);
					window.clearTimeout(alarmsLogTimerVariable_);

					//editButton.classList.add("navigationMenu--Edit");
					mainBlock_.el.classList.add("editMode");

					for(widgetId in page_.widgets)
					{
						if(page_.widgets[widgetId].el.contentWindow) page_.widgets[widgetId].el.contentWindow.drawWidget(page_.widgets[widgetId]);
						drawWidget(widgetId);
					}

					for(var i = 0;i<covers.length;++i)
						if (page_.widgets[i].type != WIDGET_TYPE_TAB
						  && page_.widgets[i].type != WIDGET_TYPE_NAVTAB)
							covers[i].style.display = "block";

					for(var i = 0;i<resize_covers.length;++i)
						resize_covers[i].style.display = "block";//	resize_covers[i].style["z-index"] = "8";

					toggleGrid(true);
					if (editBlock_.el.firstChild.contentWindow.document.getElementById("gridCheckbox") != null)
						editBlock_.el.firstChild.contentWindow.document.getElementById("gridCheckbox").checked = true
				}
				else
				{
					Debug.log("Edit Mode Off");
					document.getElementById("menuli3").innerHTML = "<br/>Go Back to previous page";

					editBlock_.isHidden = true;
					editBlock_.el.style.display = "none";
					editButton.innerHTML = "Switch to Edit Mode";

					UID_ = 0;

					if (page_.widgets != undefined && !isEmpty(page_.widgets))
					{
						var pvListSize = 0;
						var allLastAlarmsSize = 0;
						var allAlarmsLogSize = 0;

						for (var widget in page_.widgets)
						{						
							if (!isEmpty(page_.widgets[widget].pvList))
								pvListSize ++;
							else
								if (page_.widgets[widget].type == 1)
								{
									if (page_.widgets[widget].attributes["getLastAlarms"] == "true")
										allLastAlarmsSize++;
									if (page_.widgets[widget].attributes["getAlarmsLog"] == "true")
										allAlarmsLogSize++;
								}
						}

						if (pvListSize > 0)
						{
							generateUID();
							pollServer();
							//timerVariable_ = window.setTimeout(pollServer, refreshRate_);
						}

						if (allLastAlarmsSize > 0)
							getLastAlarms();
							//lastAlarmsTimerVariable_ = window.setTimeout(pollLastAlarms, refreshRate_);
						if (allAlarmsLogSize > 0)
							getAlarmsLog();
							//alarmsLogTimerVariable_ = window.setTimeout(pollAlarmsLog, refreshRate_);
					}

					mainBlock_.el.classList.remove("editMode");
					//editButton.classList.remove("navigationMenu--Edit");

					for(var i = 0;i<covers.length;++i)
						covers[i].style.display = "none";

					for(var i = 0;i<resize_covers.length;++i)
						resize_covers[i].style.display = "none";

					setEditModeWidgetTarget();
					toggleGrid(false);
					if (editBlock_.el.firstChild.contentWindow.document.getElementById("gridCheckbox") != null)
						editBlock_.el.firstChild.contentWindow.document.getElementById("gridCheckbox").checked = false;
				}
			} //end toggleEditMode()


			//=====================================================================================
			function goBackToPreviousPage()
			{
				console.log("goBackToPreviousPage(): ");
				if(previousPage_ != "") loadPhoebusPage(previousPage_);
			} //end goBackToPreviousPage()

			//=====================================================================================
			// returns a handler function that can be used to respond 
			//	to event handlers and pass an id parameter
			function makeHandlerWithID(id,handlerFunction)
			{
				 return function(event) {
					 console.log("makeHandlerWithID handlerFunction called id=",id);
					 handlerFunction(event, id);
				};
			} //end makeHandlerWithID()


			//=====================================================================================
			function toggleContextMenu(e, id)
			{			
				if(e) e.stopPropagation();

				console.log("toggle toggleContextMenu id=",id);

				toggleContextMenuOff(); //hide first, so menu always comes up
				if(menuState_ !== 1)
				{
					menuState_ = 1; //set state

					//hide lower Edit pane
					mouseoutEditBlock(e);

					var w = DesktopContent.getWindowWidth();
					var h = DesktopContent.getWindowHeight();

					var x = e.clientX;
					var y = e.clientY;

					//prevent context menu from being offscreen
					// context menu seems to be 320 x 300
					if(x + 320 > w)
						x = w - 320;
					if(y + 280 > h - EDIT_BLOCK_PEEK_HEIGHT)
						y = h - EDIT_BLOCK_PEEK_HEIGHT - 280;

					//show menu to popup of tab body, if in tab body
					if(page_.widgets[id].tabBodyID && page_.widgets[id].tabBodyID != "")
						document.getElementById("menu__item_popOutOfTab").style.display = "block";
					else
						document.getElementById("menu__item_popOutOfTab").style.display = "none";

					menu_.style.left = x + "px";
					menu_.style.top = y + "px";
					menu_.setAttribute("widgetID", id);
					menu_.classList.add(activeMenu_);

					
					//set target element
					targetElement_ = document.getElementById("widget-" + id);
				}
			} //end toggleContextMenu()


			//=====================================================================================
			function toggleContextMenuOff(e)
			{
				if(e) e.stopPropagation();			
				if(menuState_ !== 0)
				{
					menuState_ = 0;
					menu_.classList.remove(activeMenu_);
				}
			} //end toggleContextMenuOff()


			//=====================================================================================
			function toggleHotkeyMenu()
			{
				var rectangle = document.getElementById("menuli3").getBoundingClientRect();
				if((elPointer_["hotkeyMenuDiv"].style.display).indexOf("block") != -1)
				{
					elPointer_["hotkeyMenuDiv"].style.display = "none";
				}
				else
				{
					elPointer_["hotkeyMenuDiv"].style.display = "block";
					elPointer_["hotkeyMenuDiv"].style.left = rectangle.left + "px";
					elPointer_["hotkeyMenuDiv"].style.top = rectangle.top + "px";
				}
			} //end toggleHotkeyMenu()


			//=====================================================================================
			function toggleAddPV()
			{
				console.log(menu_.getAttribute("widgetID"));

				if(elPointer_["addPVMenuDiv"].style.display == "none")
				{
					toggleContextMenuOff();
					elPointer_["addPVMenuDiv"].setAttribute("widgetID", menu_.getAttribute("widgetID"));
					elPointer_["addPVMenuDiv"].style.display = "block";
					elPointer_["addPVMenu"].style.display = "block";
				}
				else
				{
					elPointer_["addPVMenuDiv"].style.display = "none"
					elPointer_["addPVMenu"].style.display = "none";
				}
			} //end toggleAddPV()


			//=====================================================================================
			function toggleFileMenu()
			{
				Debug.log("Toggle File Pane");

				var mainBlockContainer = document.getElementById("mainBlockContainer");
				var cover = document.getElementById("grayOutCoverDiv");
				cover.style.width = mainBlockContainer.offsetWidth + "px";
				cover.style.height = mainBlockContainer.offsetHeight + "px";

				//file toggle movement approach is always leave left
				//	the same, and change margin-left 
				//	(style transition speed on margin-left property for graceful movement)
				fileBlock_.el.style.left = (- FILE_BLOCK_WIDTH) + "px";

				if(fileBlock_.isHidden)
				{
					console.log("Showing file pane!");

					fileBlock_.isHidden = false;
					fileBlock_.el.style.marginLeft = FILE_BLOCK_WIDTH + "px";
					fileBlock_.el.style.width = FILE_BLOCK_WIDTH + "px";

					cover.style.display = "block";

					nav_.classList.remove("navigationMenu--active");
					nav_.style.display = "none";
				}
				else
				{
					console.log("Hiding file pane!");

					fileBlock_.isHidden = true;
					fileBlock_.el.style.marginLeft = -50 + "px";

					cover.style.display = "none";

					//mainBlock_.el.style.display = "block";

					//editBlock_.el.style.display = "block";

					nav_.classList.add("navigationMenu--active");
					nav_.style.display = "block";
				}
			} //end toggleFileMenu()


			//=====================================================================================
			//createTopPaneContent ~~
			function createTopPaneContent(H, W) 
			{
				var popupBody = document.getElementById("editWidgetAttributesPopup-body-pvlist");
				popupBody.innerHTML = "";

				// Make Top pane
				if (document.getElementById("topPane") != null)
				{
					document.getElementById("selbox-TopPVBox").parentNode.removeChild(document.getElementById("selbox-TopPVBox"));
					document.getElementById("recordTopMultiSelect").parentNode.removeChild(document.getElementById("recordTopMultiSelect"));
					document.getElementById("topPane").parentNode.removeChild(document.getElementById("topPane"));
				}

				var _topPane = document.createElement("div");
				_topPane.setAttribute("class", "pane");
				_topPane.setAttribute("id", "topPane");

				var datalist = document.getElementById("pvDatalist");
				var keys  = [];
				var types = [];
				var vals  = [];
				var noMultiSelect = false; // true or false (false for multiselect functionality)

				for(var pv=0; pv < datalist.options.length; pv++)
				{
					keys[pv] = datalist.options[pv].value;
					vals[pv] = datalist.options[pv].value;
				}

				Debug.log("keys: ", keys);

				//create multiselect box
				var el = document.createElement("div");
				el.setAttribute("class", "recordTopMultiSelect");
				el.setAttribute("id", "recordTopMultiSelect");
				el.setAttribute("style", //"height:200px; width:250px;" +
						//);
						//"margin-bottom: 0px;" +
						"margin: -15px 0 -10px 0;" +
						"height:" + H + "px;" + 
						"width:" + (W-25) + "px;");

				//write MultiSelectBox to a particular div
				MultiSelectBox.mySelects_ = {};
				MultiSelectBox.createSelectBox(el,
						"TopPVBox",
						"Chose PV names",
						vals,keys,types,"",noMultiSelect);

				//MultiSelectBox.initMySelectBoxes();
				_topPane.appendChild(el);

				var popupBody = document.getElementById("editWidgetAttributesPopup-body-pvlist");
				popupBody.appendChild(_topPane);
			}	//end createTopPaneContent()


			//=====================================================================================
			//createAddRemovePVContent ~~
			function createAddRemovePVContent(W) 
			{
				if (document.getElementById("addRemovePv") != null) return;

				//create add remove buttons
				var div = document.createElement("div");
				div.setAttribute("id", "addRemovePv");

				div.setAttribute("style", //"height:200px; width:250px;" +
						//);
						//"margin-bottom: 0px;" +
						"margin: 10px 0 35px 0;" +
						"height:" + 20 + "px;" + 
						"width:" + (W-25) + "px;");

				var add = document.createElement("button");
				add.innerHTML = "Add";
				//add.onmousedown = function(e){e.stopPropagation();}
				//add.onmouseup = function(e)
				add.onclick = function(e)
				{
					//e.stopPropagation();

					var i =0;
					var selected  = {};

					var currentPvIndexList = MultiSelectBox.getSelectionArray(document.getElementById("recordBottomMultiSelect"));
					for (var pv in currentPvIndexList)
					{
						var selection = MultiSelectBox.getSelectionElementByIndex(document.getElementById("recordBottomMultiSelect"), pv);
						if(selection != null) selected[selection.innerText] = i;
						i++;
					}

					var addedPvIndexList = MultiSelectBox.getSelectionArray(document.getElementById("recordTopMultiSelect"));
					for (var pv in addedPvIndexList)
					{
						var selection = MultiSelectBox.getSelectionElementByIndex(document.getElementById("recordTopMultiSelect"), pv);
						if(addedPvIndexList[pv] != 0 && addedPvIndexList[pv] != currentPvIndexList[pv] && selection != null)
						{
							selected[selection.innerText] = i;
							i++;
						}
					}

					console.log("Add PVContent:", selected);
					createBottomPaneContent(130, 400, selected);
				};

				var remove = document.createElement("button");
				remove.innerHTML = "Remove";
				remove.onclick = function()
				{
					var pvIndexList = MultiSelectBox.getSelectionArray(document.getElementById("recordBottomMultiSelect"));
					console.log("Remove PVContent:", pvIndexList);

					var i =0;
					var selected  = {};
					if (pvIndexList.length==0) return;
					for (var pv in pvIndexList)
					{
						var selection = MultiSelectBox.getSelectionElementByIndex(document.getElementById("recordBottomMultiSelect"), pv);
						if(pvIndexList[pv] == 0 && selection != null)
						{
							selected[selection.innerText] = i;
							i++;
						}
					}
					createBottomPaneContent(130, 400, selected);
				};

				var table = document.createElement("table");
				table.style.width = "300px";
				var tr = document.createElement("tr");
				var td1 = document.createElement("td");
				td1.style.width = "150px";
				var td2 = document.createElement("td");
				td1.appendChild(add);
				td2.appendChild(remove);
				tr.appendChild(td1);
				tr.appendChild(td2);
				table.appendChild(tr);
				div.appendChild(table);
				var popupBody = document.getElementById("editWidgetAttributesPopup-body-pvlist");
				popupBody.appendChild(div);
			}	//end createAddRemovePVContent()


			//=====================================================================================
			//createBottomPaneContent ~~
			function createBottomPaneContent(H, W, pvlist)
			{
				var keys  = [];
				var types = [];
				var vals  = [];
				var noMultiSelect = false; // true or false (false for multiselect functionality)

				var i = 0;
				for(var pv in pvlist)
				{
					keys[i] = pv;
					vals[i] = pv;
					i++;
				}

				Debug.log("keys: ", keys);

				// Make Bottom pane
				if (document.getElementById("bottomPane") != null)
				{
					document.getElementById("selbox-BottomPVBox").parentNode.removeChild(document.getElementById("selbox-BottomPVBox"));
					document.getElementById("recordBottomMultiSelect").parentNode.removeChild(document.getElementById("recordBottomMultiSelect"));
					document.getElementById("bottomPane").parentNode.removeChild(document.getElementById("bottomPane"));
				}
				var _bottomPane = document.createElement("div");
				_bottomPane.setAttribute("class", "pane");
				_bottomPane.setAttribute("id", "bottomPane");
			
				var el = document.createElement("div");
				el.setAttribute("class", "recordBottomMultiSelect");
				el.setAttribute("id", "recordBottomMultiSelect");
				el.setAttribute("style",
					"margin: -15px 0 -10px 0;" +
					"height:" + H + "px;" + 
					"width:" + (W-25) + "px;");

				//write MultiSelectBox to a particular div
				MultiSelectBox.createSelectBox(el,
						"BottomPVBox",
						"PV names chosen",
						vals,keys,types,"",noMultiSelect);

				//MultiSelectBox.initMySelectBoxes();

				_bottomPane.appendChild(el);
				var popupBody = document.getElementById("editWidgetAttributesPopup-body-pvlist");
				popupBody.appendChild(_bottomPane);
				MultiSelectBox.initMySelectBoxes(true);
			}	//end createBottomPaneContent()


			//=====================================================================================
			//createPVTable ~~
			function createPVTable() 
			{
				//BEGIN PVTable
				var popupBody = document.getElementById("editWidgetAttributesPopup-body-pvlist");
				popupBody.innerHTML = "";
				var table = document.createElement("table");
				table.id = "widgetPVTable";
				table.className = "widgetPopupTable";
				table.style.width = "95%";
				table.style.height = "95%";
				table.style.margin = "auto";
				var thead = document.createElement("thead");
				var trhead = document.createElement("tr");
				var thPV = document.createElement("th");
//				thPV.className = "widgetPopupTable";
				thPV.innerHTML = "PV Name";
				thPV.style.width = "60%";
				var thRefresh = document.createElement("th");
//				thRefresh.className = "widgetPopupTable";
				thRefresh.innerHTML = "Refresh Rate (Sec)";
				thRefresh.style.width = "40%";
				trhead.appendChild(thPV);
				trhead.appendChild(thRefresh);
				thead.appendChild(trhead);
				table.appendChild(thead);
				var tbody = document.createElement("tbody");
				tbody.id = "widgetPVTableBody";
				table.appendChild(tbody);
				elPointer_["editWidgetAttributesPopup-body-pvlist"].appendChild(table);

				for(var pv in page_.widgets[menu_.getAttribute("widgetID")].pvList)
				{
					editWidgetAttributesaddRowPVList(pv, page_.widgets[menu_.getAttribute("widgetID")].pvList[pv]/1000, "widgetPVTableBody", "pvDatalist");
				}

				for(var i = 0; i < 15; i++)
				{
					editWidgetAttributesaddRowPVList("", "", "widgetPVTableBody", "pvDatalist");
				}
				//END PVTable
			}	//end createPVTable()


			//=====================================================================================
			//createAttributesTable ~~
			function createAttributesTable() 
			{
				//BEGIN AttributesTable
				var attributeBody = elPointer_["editWidgetAttributesPopup-body-attributes"];
				attributeBody.innerHTML = "";
				var attributeTable = document.createElement("table");
				attributeTable.id = "widgetAttributesTable";
				attributeTable.className = "widgetPopupTable";
				attributeTable.style.width = "95%";
				attributeTable.style.height = "100%";
				var thead = document.createElement("thead");
				var trhead = document.createElement("tr");
				var thParameter = document.createElement("th");
				thParameter.className = "widgetPVTable";
				thParameter.innerHTML = "Parameter";
				//thParameter.style.width = "40%";
				var thParameterValue = document.createElement("th");
				thParameterValue.className = "widgetPopupTable";
				thParameterValue.innerHTML = "Value";
				//thParameterValue.style.width = "60%";
				trhead.appendChild(thParameter);
				trhead.appendChild(thParameterValue);
				thead.appendChild(trhead);
				attributeTable.appendChild(thead);
				var tbody = document.createElement("tbody");
				tbody.id = "widgetAttributesTableBody";
				attributeTable.appendChild(tbody);
				elPointer_["editWidgetAttributesPopup-body-attributes"].appendChild(attributeTable);

				console.log(page_.widgets[menu_.getAttribute("widgetID")].attributes);

				for(var attribute in page_.widgets[menu_.getAttribute("widgetID")].attributes)
				{
					console.log(attribute);
					editWidgetAttributesaddRowPVList(attribute, page_.widgets[menu_.getAttribute("widgetID")].attributes[attribute], "widgetAttributesTableBody", "");
				}
				//END AttributesTable
			}	//end createAttributesTable()


			//=====================================================================================
			function editWidgetAttributesOpen()
			{
				document.getElementById("editWidgetAttributesPopup-container").style.display = "block";
				toggleContextMenuOff();

				//BEGIN HEADER
				var header = document.getElementById("editWidgetAttributesPopup-header");
				header.innerHTML = "";
				var title = document.createElement("input");
				title.setAttribute("type", "text")
				title.value = page_.widgets[menu_.getAttribute("widgetID")].displayName;
				title.onchange = function(){setWidgetDisplayName(menu_.getAttribute("widgetID"), this.value);};
				title.className = "editableInput";
				header.appendChild(title);
				console.log(header.clientHeight);
				var fontsize = 5;
				while(fontsize < (0.6 * header.clientHeight))
				{
					title.style.fontSize = ++fontsize + "px";
				}
				//END HEADER

				//createPVTable();
				createTopPaneContent(160, 400);
				createAddRemovePVContent(180);
				createBottomPaneContent(130, 400, page_.widgets[menu_.getAttribute("widgetID")].pvList);
				createAttributesTable();

				showeditWidgetAttributesPopupBody("EditPVlist");

				//BEGIN FOOTER
				var footer = document.getElementById("editWidgetAttributesPopup-footer");
				footer.innerHTML = "";
				var closeButton = document.createElement("button");
				closeButton.className = "editPopupButton";
				closeButton.style.left = "55%";
				closeButton.innerHTML = "Cancel";
				closeButton.onclick = function(){editWidgetAttributesClose();};
				footer.appendChild(closeButton);
				var saveButton = document.createElement("button");
				saveButton.className = "editPopupButton";
				saveButton.style.left = "35%";
				saveButton.innerHTML = "Save";
				saveButton.onclick = function(){editWidgetAttributesSave(); editWidgetAttributesClose();};
				footer.appendChild(saveButton);				
				//END FOOTER
			} //end editWidgetAttributesOpen()


			//=====================================================================================
			function editWidgetAttributesClose()
			{
				document.getElementById("editWidgetAttributesPopup-container").style.display = "none";
			} //end editWidgetAttributesClose()


			//=====================================================================================
			function addPVTableToWidget()
			{
				page_.widgets[menu_.getAttribute("widgetID")].pvList = {};
				var table = document.getElementById("widgetPVTable");
				for(var tr = 0; tr < table.getElementsByTagName("tr").length; tr++)
				{
					if(table.getElementsByTagName("tr")[tr].getElementsByTagName("td").length > 0)
					{
						var pv = table.getElementsByTagName("tr")[tr].getElementsByTagName("td")[0].getElementsByTagName("input")[0].value;
						if(pv != "")
						{
							console.log(pv);
							var refreshRate = table.getElementsByTagName("tr")[tr].getElementsByTagName("td")[1].getElementsByTagName("input")[0].value*1000;
							console.log("refreshRate (ms): " + refreshRate);
							if(refreshRate == "")
								refreshRate = -1;

							page_.widgets[menu_.getAttribute("widgetID")].pvList[pv] = refreshRate;
						}
						page_.widgets[menu_.getAttribute("widgetID")].el.contentWindow.init();
					}
				}
			} //end addPVTableToWidget()


			//=====================================================================================
			function addPVPaneToWidget()
			{
				page_.widgets[menu_.getAttribute("widgetID")].pvList = {};
				var pvIndexList = MultiSelectBox.getSelectionArray(document.getElementById("recordBottomMultiSelect"));
				console.log("addPVPaneToWidget():", MultiSelectBox.getSelectedCount(document.getElementById("recordBottomMultiSelect")));

				var i = 0;
				var pvName = "";
				while (MultiSelectBox.getSelectionElementByIndex(document.getElementById("recordBottomMultiSelect"), i))
				{
					pvName = MultiSelectBox.getSelectionElementByIndex(document.getElementById("recordBottomMultiSelect"), i).innerText;
					page_.widgets[menu_.getAttribute("widgetID")].pvList[pvName] = refreshRate_;
					i++;
				}
				if(page_.widgets[menu_.getAttribute("widgetID")].el.contentWindow)
					page_.widgets[menu_.getAttribute("widgetID")].el.contentWindow.init();
			} //end addPVPaneToWidget()


			//=====================================================================================
			function addAttributesListToWidget()
			{
				var actionRequired = false;
				page_.widgets[menu_.getAttribute("widgetID")].attributes = {};
				var attributesTable = document.getElementById("widgetAttributesTable");
				console.log(attributesTable);
				for(var tr = 0; tr < attributesTable.getElementsByTagName("tr").length; tr++)
				{
					console.log(tr);
					if(attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td").length > 0)
					{
						var parameter = attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td")[0].getElementsByTagName("input")[0].value;
						if(parameter != "")
						{
							var value = attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td")[1].getElementsByTagName("input")[0].value;							
							console.log(" a: " + parameter, value);
							if(value == 'undefined')
								actionRequired = true;

							if(parameter == "upload_csv_file")
							{
								var tdButton = attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td")[0].getElementsByTagName("input")[0];
								tdButton.setAttribute("type", "button");
								tdButton.className = "";
								tdButton.style.width = "100%";
								tdButton.style.height = "50%";
								tdButton.onmouseup = function (){popupUploadCSVTableForm();};
							}
							else if(parameter == "export_csv_file")
							{
								var tdButton = attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td")[0].getElementsByTagName("input")[0];
								tdButton.setAttribute("type", "button");
								tdButton.className = "";
								tdButton.style.width = "100%";
								tdButton.style.height = "50%";
								tdButton.onmouseup = function (){popupExportCSVTableForm()};
								if (page_.widgets[menu_.getAttribute("widgetID")].el.contentWindow.tabledata)
									tdButton.disabled = false;
								else
									tdButton.disabled = true; 
							}
							else if(parameter == "upload_image")
							{
								var tdButton = attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td")[0].getElementsByTagName("input")[0];
								tdButton.setAttribute("type", "button");
								tdButton.className = "";
								tdButton.style.width = "100%";
								tdButton.style.height = "50%";
								tdButton.onmouseup = function (){popupUploadImage();};
							}
							else if(parameter == "inner_map_html")
							{
								var tdTextArea = attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td")[1].getElementsByTagName("input")[0];
								tdTextArea.style.backgroundColor = "white";
								var tdButton = attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td")[0].getElementsByTagName("input")[0];
								
								//Use this Button to go to https://www.image-map.net/ to make image map area code. After add your <area ....> code in the next text area
								tdButton.setAttribute("type", "button");
								tdButton.className = "";
								tdButton.style.width = "100%";
								tdButton.style.height = "50%";
								tdButton.onclick = function(){window.open("https://www.image-map.net/", "_blank")};
								tdButton.title = "Click here to go to https://www.image-map.net/ to make image map area code. After add your <area ....> code in the next text area";
							}
							else
								attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td")[0].getElementsByTagName("input")[0].readOnly = true;

							page_.widgets[menu_.getAttribute("widgetID")].attributes[parameter] = value;
						}
					}
				}
				try
				{
					if (page_.widgets[menu_.getAttribute("widgetID")].type != WIDGET_TYPE_TAB && page_.widgets[menu_.getAttribute("widgetID")].type != WIDGET_TYPE_NAVTAB)
						page_.widgets[menu_.getAttribute("widgetID")].el.contentWindow.setAttributes(page_.widgets[menu_.getAttribute("widgetID")].attributes);
				}
				catch(e)
				{
					Debug.log("There are errors when calling setAttributes() of target widget: " + e,
						Debug.WARN_PRIORITY);
				}
				try
				{
					if (page_.widgets[menu_.getAttribute("widgetID")].type != WIDGET_TYPE_TAB && page_.widgets[menu_.getAttribute("widgetID")].type != WIDGET_TYPE_NAVTAB)
						page_.widgets[menu_.getAttribute("widgetID")].el.contentWindow.drawWidget(page_.widgets[menu_.getAttribute("widgetID")], page_.widgets[menu_.getAttribute("widgetID")].attributes);
					else
					{
						// update tabs widgets
						var widgetObject = page_.widgets[menu_.getAttribute("widgetID")];
						var tabs_num = widgetObject.el.children[0].childElementCount;
						
						// delete attributes and widgets when tabs are removed
						if (widgetObject.attributes["tabs_num"] < tabs_num)
							for (var i=widgetObject.attributes["tabs_num"]; i<tabs_num;++i)
							{
								// delete attributes
								delete widgetObject.attributes["tabname_"+i];
								if (page_.widgets[menu_.getAttribute("widgetID")].type == WIDGET_TYPE_NAVTAB)
									delete widgetObject.attributes["file_"+i];
									
								// delete widgets in tab bodies
								for(wid in page_.widgets)
									if(page_.widgets[wid].tabBodyID == "widget-"+menu_.getAttribute("widgetID")+"-tabBody-"+i)
									{
										targetElement_ = page_.widgets[wid].el;
										deleteWidget();
									}
								targetElement_ = undefined;
							}

						widgetObject.el.innerHTML = "";
						drawTabWidgets(menu_.getAttribute("widgetID"), page_.widgets[menu_.getAttribute("widgetID")].type, widgetObject);

						//if in a tab widget, add directly
						for (wid in page_.widgets)
							if(page_.widgets[wid].tabBodyID && page_.widgets[wid].tabBodyID != "")
								addWidgetToTabBody(wid,page_.widgets[wid].tabBodyID);
						drawWidget(menu_.getAttribute("widgetID"));
					}
				}
				catch(e)
				{
					Debug.log("There are errors when calling drawWidget() of target widget: " + e,
						Debug.WARN_PRIORITY);
				}
			} //end addAttributesListToWidget()


			//=====================================================================================
			function editWidgetAttributesSave()
			{
				if(elPointer_["editWidgetAttributesPopup-body-pvlist"].style.display == "table-row"){
					//addPVTableToWidget();
					addPVPaneToWidget();
				}
				else if(elPointer_["editWidgetAttributesPopup-body-attributes"].style.display == "table-row")
				{
					addAttributesListToWidget();
				}
			} //end editWidgetAttributesSave()


			//=====================================================================================
			function editWidgetAttributesaddRowPVList(keyParam, valueParam, tablebody, list)
			{
				var tbody = document.getElementById(tablebody);
				var dummytr = document.createElement("tr");
				dummytr.className = "widgetPopupTable";
				var dummyts = document.createElement("td");
				dummyts.className = "widgetPopupTable";
				var keyField = document.createElement("input");

				if(keyParam == "upload_csv_file")
				{
					keyField.setAttribute("type", "button")
					keyField.className = "";
					keyField.style.width = "100%";
					keyField.style.height = "50%";
					keyField.onmouseup = function (){popupUploadCSVTableForm();};
				}
				else if(keyParam == "export_csv_file")
				{
					keyField.setAttribute("type", "button")
					keyField.className = "";
					keyField.style.width = "100%";
					keyField.style.height = "50%";
					keyField.onmouseup = function (){popupExportCSVTableForm()};
					if (page_.widgets[menu_.getAttribute("widgetID")].el.contentWindow.tabledata)
						keyField.disabled = false;
					else
						keyField.disabled = true; 
				}
				else if(keyParam == "upload_image")
				{
					keyField.setAttribute("type", "button")
					keyField.className = "";
					keyField.style.width = "100%";
					keyField.style.height = "50%";
					keyField.onmouseup = function (){popupUploadImage();};
				}
				else if(keyParam == "inner_map_html")
				{
					//Use this Button to go to https://www.image-map.net/ to make image map area code. After add your <area ....> code in the next text area
					keyField.setAttribute("type", "button");
					keyField.className = "";
					keyField.style.width = "100%";
					keyField.style.height = "50%";
					keyField.onclick = function(){window.open("https://www.image-map.net/", "_blank")};
					keyField.title = "Click here to go to https://www.image-map.net/ to make image map area code. After add your <area ....> code in the next text area";
				}
				else
				{
					keyField.setAttribute("type", "text")
					keyField.className = "editableInput";
					keyField.style.color = "black";
					keyField.setAttribute("list", list);
					keyField.onmouseup = function (){};
					keyField.readOnly = true;
				}

				keyField.value = keyParam;
				keyField.onchange = function(){checkIfMoreRowsNeeded(this); };
				dummyts.appendChild(keyField);

				var dummyts2 = document.createElement("td");
				dummyts2.className = "widgetPopupTable";
				var valueField = document.createElement("input");
				valueField.setAttribute("type", "text")
				valueField.className = "editableInput";
				valueField.style.color = "black";
				valueField.value = valueParam;
				keyField.onchange = function (){setRefreshRate(keyField,valueField)};
				dummyts2.appendChild(valueField);
				dummytr.appendChild(dummyts);
				dummytr.appendChild(dummyts2);
				dummytr.style["max-height"] = "10%";
				tbody.appendChild(dummytr);	
				if(keyParam == "inner_map_html")
				{
					valueField.style.backgroundColor = "white";
				}
			} //end editWidgetAttributesaddRowPVList()


			//=====================================================================================
			function checkIfMoreRowsNeeded(inputEl)
			{
				console.log(inputEl.parentElement.parentElement.parentElement.lastElementChild);
				if(inputEl.parentElement.parentElement == inputEl.parentElement.parentElement.parentElement.lastElementChild)
				{
					editWidgetAttributesaddRowPVList("", "");
				}
			} //end checkIfMoreRowsNeeded()


			//=====================================================================================
			function setWidgetDisplayName(widget, displayName)
			{
				page_.widgets[widget].displayName = displayName;
			} //end setWidgetDisplayName()


			//=====================================================================================
			function showeditWidgetAttributesPopupBody(body)
			{
				editWidgetAttributesSave();

				elPointer_["editWidgetAttributesPopup-body-pvlist"].style.display = "none";
				elPointer_["editWidgetAttributesPopup-body-attributes"].style.display = "none";

				if (body == "EditAttributes")
				{
					console.log("EditAttributes");
					elPointer_["editWidgetAttributesPopup-body-attributes"].style.display = "table-row";
				}
				else if (body == "Macromaker")
				{
					//elPointer_["editWidgetAttributesPopup-body-macromaker"].style.display = "table-row";
				}
				else
				{
					elPointer_["editWidgetAttributesPopup-body-pvlist"].style.display = "table-row";
				}
			} //end showeditWidgetAttributesPopupBody()


			//=====================================================================================
			function popupUploadCSVTableForm() 
			{
				document.getElementById("popupUploadSaveCsvFile").style.display = "block";
				document.getElementById("popupUploadSaveCsvFile").style["z-index"] = 101;
				Debug.log("Slow Controls Dashboard: popupUploadCSVTableForm");
				_tableUploadStr = ""; //clear previous upload

				var str = "";

				var el = document.getElementById("popUpDialog");
				if (!el)
				{
					el = document.createElement("div");
					el.setAttribute("id", "popUpDialog");
				}

				str += "<div id='popUpDialog-div'>";

				str += "<center>Please choose a CSV formatted data file (i.e. commas for columns, and new lines for rows) " +
					"to upload, and choose whether you want to replace the current " +
					"data or prepend/append the new data:</center><br>";

				str += "<center>";

				str += "<input type='file' id='popUpDialog-fileUpload' " +
					"accept='.csv' enctype='multipart/form-data' />";

				// done with special handling
				// continue with pop-up prompt
				str += "</center></div><br><br>"; //close main popup div

				str += "<center><input id='popUpDialog-submitButton' disabled type='button'" +
					"value='Upload File' title='" +
					"Upload the chosen file to the current widget lights table.'/>";
				str += "<input id='popUpDialog-closeButton' type='button' onmouseup='" +
					"closeFilePopup()' value='Cancel'/></center>";

				el.innerHTML = str;
				document.getElementById("popupUploadSaveCsvFile").appendChild(el); //add element to editWidgetAttributesPopup-file div

				document.getElementById('popUpDialog-fileUpload').addEventListener(
					'change', function (evt)
					{
						var files = evt.target.files;
						var file = files[0];
						var reader = new FileReader();
						var uploadbutton = document.getElementById('popUpDialog-submitButton');
						reader.onload = 
							function ()
							{
								//store uploaded file and enable button
								_tableUploadStr = this.result;
								Debug.log("_tableUploadStr = " + _tableUploadStr);
								uploadbutton.disabled = false;
							}
						reader.readAsText(file);
						var filename = file.name;
						uploadbutton.title = "Upload the chosen " + filename + " file to the current widget lights table.";
						uploadbutton.onmouseup = function (){uploadTableFromCSV(filename); closeFilePopup();};
					}, false);
			} //end popupUploadCSVTableForm()


			//=====================================================================================
			function popupExportCSVTableForm() 
			{
				console.log("popupExportCSVTableForm()");
				
				var popupSave = document.getElementById("popupUploadSaveCsvFile");
				popupSave.style.display = "block";
				popupSave.style["z-index"] = 101;

				var str = "";

				var el = document.getElementById("popUpDialog");
				if (!el)
				{
					el = document.createElement("div");
					el.setAttribute("id", "popUpDialog");
				}

				str += "<div id='popUpDialog-div'>";

				str += "<center>Please choose where to export data in a CSV formatted data file"
				str += "Default field delimiters (in Excel and Numbers) vary based " +
						"on keyboard settings, so please select your field delimiter: <br><br>";
				str += "<select id='fieldSelect'>";

				str += "<option value= ',' selected>Comma ,</option>";
				str += "<option value= ';'>Semicolon ;</option>";
				str += "</select><br><br>";

				str += "<input type='button' id='popUpDialog-fileSave' title='Download file with your chosen delimiter'" +
					"value='Download file' />   ";
				str += "<input id='popUpDialog-closeButton' type='button' onmouseup='" +
					"closeFilePopup()' value='Cancel'/>";

				str += "</center></div>"; //close main popup div

				el.innerHTML = str;
				popupSave.appendChild(el); //add element to editWidgetAttributesPopup-file div

				document.getElementById('popUpDialog-fileSave').onclick = 
					function ()
					{
						var data = page_.widgets[menu_.getAttribute("widgetID")].el.contentWindow.tabledata;
						var xSize = page_.widgets[menu_.getAttribute("widgetID")].el.contentWindow._xSize;
						var ySize = page_.widgets[menu_.getAttribute("widgetID")].el.contentWindow._ySize;

						var dataStr = "data:text/csv;charset=utf-8,";

						var rowDel = '\n';
						var colDel = document.getElementById("fieldSelect").value;

						var i = 0;
						for(var row = 1; row <= ySize; row++)
						{
							for (var cell = 1; cell <= xSize; cell++)
							{
								dataStr += encodeURI(data[i].pvName);
								if (cell < xSize) dataStr += encodeURI(colDel);
								i++;
							}
							dataStr += encodeURI(rowDel);
						}

						var link = document.createElement("a");
						link.setAttribute("href", dataStr); //double encode, so encoding remains in CSV
						link.setAttribute("style", "display:none");
						link.setAttribute("download", "data_download.csv");
						document.body.appendChild(link); // Required for FF

						link.click(); // This will download the data file with filename *_download.csv

						link.parentNode.removeChild(link);
					};

			} //end popupExportCSVTableForm()


			//=====================================================================================
			function uploadTableFromCSV(filename)
			{
				var tabledata = page_.widgets[menu_.getAttribute("widgetID")].el.contentWindow.tabledata;
				tabledata = [];

				var colDel, rowDel = '\n'; //row/record and column/field delimeters

				//auto find record delimeter (finding auto-row delimiter is more complicated if there are options.. to avoid confusion with data)
				//	take last found, which must always be correct
				//	because last fields are forced fields (author/time) and 
				//	do not have special characters.

				for (var i = _tableUploadStr.length-1;i >= 0; --i) 
				{
					if (_tableUploadStr[i] == ',')
					{
						colDel = ',';
						break;
					}
					else if (_tableUploadStr[i] == ';')
					{
						colDel = ';';
						break;
					}
				}

				//find row and col size
				var srcRows = _tableUploadStr.length? //if no data, make no rows
						_tableUploadStr.replace(/"([^"]+(?="))"/g, '$1').split(rowDel):[]; 
				var src = []; //src = [r][c]
				for (var i = 0; i < srcRows.length; ++i)
					src.push(srcRows[i].split(colDel));			
				console.log("uploadTableFromCSV(): src matrix", src);

				var ySize = src.length-1;
				var xSize = src[0].length;
				var pvList = {};

				// make widget tabledata
				var counter = 0;
				for (var i = 0; i < _ySize; i++)
				{
					for (var j = 0; j < _xSize; j++)
					{
						//var pv = "x"+j + ",y" + i;
						var pv = src[i][j];
						var value = "";
						var status = "";
						var severity = "";
						var time = "";

						var cell = {
									  id:counter
									, y:i
									, x:j
									, pvName:pv
									, pvValue:value
									, pvStatus:status
									, pvSeverity:severity
									, pvTime:time
								  };

						tabledata.push(cell);
						if (pv != "-1") pvList[pv] = counter;
						counter++;
					}
				}

				// set matrix size and data to widget
				page_.widgets[menu_.getAttribute("widgetID")].el.contentWindow._xSize = xSize;
				page_.widgets[menu_.getAttribute("widgetID")].el.contentWindow._ySize = ySize;
				page_.widgets[menu_.getAttribute("widgetID")].el.contentWindow.tabledata = tabledata;

				var attributesTable = document.getElementById("widgetAttributesTable");
				for(var tr = 0; tr < attributesTable.getElementsByTagName("tr").length; tr++)
				{
					if(attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td").length > 0)
					{
						var tdButton = attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td")[0].getElementsByTagName("input")[0];
						var parameter = tdButton.value;
						if (parameter == "upload_csv_file")
							attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td")[1].getElementsByTagName("input")[0].value = filename + " uploaded";
						else if(parameter == "export_csv_file")
						{
							tdButton.disabled = false;
						}
					}
				}

				createBottomPaneContent(130, 400, pvList);
				addPVPaneToWidget();
				console.log("uploadTableFromCSV(): pvList", pvList);
			} //end uploadTableFromCSV()


			//=====================================================================================
			function popupUploadImage() 
			{
				document.getElementById("popupUploadSaveCsvFile").style.display = "block";
				document.getElementById("popupUploadSaveCsvFile").style["z-index"] = 101;
				Debug.log("Slow Controls Dashboard: popupUploadImage");

				var str = "";

				var el = document.getElementById("popUpDialog");
				if (!el)
				{
					el = document.createElement("div");
					el.setAttribute("id", "popUpDialog");
				}

				str += "<div id='popUpDialog-div'>";

				str += "<center>Please choose an image file to upload</center><br>";

				str += "<center>";
				str += "<form id='fileForm' enctype='multipart/form-data' method='post' action='Log'>";

				str += "<input type='file' id='popUpDialog-imageUpload' " +
					"accept='image/*'  />";

				// done with special handling
				// continue with pop-up prompt
				var MAX = 100;//MB
				str += "<br><br><div id='checkFileSize'>File upload limit is " + MAX + " MB. </div>";

				str += "</form></center></div><br><br>"; //close main popup div

				str += "<center><input id='popUpDialog-submitButton' disabled type='button'" +
					"value='Upload Image' title='" +
					"Upload the chosen image to the current widget.'/>";
				str += "<input id='popUpDialog-closeButton' type='button' onmouseup='" +
					"closeFilePopup()' value='Cancel'/></center>";

				el.innerHTML = str;
				document.getElementById("popupUploadSaveCsvFile").appendChild(el); //add element to editWidgetAttributesPopup-file div

				document.getElementById('popUpDialog-imageUpload').addEventListener(
					'change', function (evt)
					{
						var files = evt.target.files;
						var file = files[0];

						document.getElementById('popUpDialog-submitButton').disabled = true;

						if (file)
						{
							if (!file.type.includes("image"))
							{
						    	document.getElementById('checkFileSize').innerHTML = "<span style='color:red'>Selected File is not an image<span>";
								return;
							}

							checkFileSize(file, MAX);
						}
					}, false);

			} //end popupUploadImage()

			//=====================================================================================
			function checkFileSize(file, maxSize)
			{
				var fileSize;
			    if (file.size > maxSize * 1024 * 1024)
			    {
			    	document.getElementById('checkFileSize').innerHTML = "Selected file exceeds file upload limit of " + maxSize + " MB.";
			    	return;
			    }
			    else if (file.size > 1024 * 1024)
			    	fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + ' MB';
			    else	
			    	fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + ' KB';

				document.getElementById('checkFileSize').innerHTML = "File upload limit is " + maxSize + " MB. Actual file size is: " + fileSize;

				var uploadbutton = document.getElementById('popUpDialog-submitButton');
				uploadbutton.disabled = false;
				uploadbutton.title = "Upload the chosen " + file.name + " file to the current widget";
				uploadbutton.onmouseup = 
					function (){
						uploadImage(file.name, file);
					};
			}

			//=====================================================================================
			function uploadImage(filename, file)
			{
				Debug.log("uploadImage(): " );
				var xhr = new XMLHttpRequest();
				var fd = new FormData(document.getElementById('fileForm'));

				/* event listeners */
				xhr.upload.addEventListener("progress", uploadProgress, false);
				xhr.addEventListener("load", saveImageFileHandler, false);
				xhr.addEventListener("error", uploadFailed, false);
				xhr.addEventListener("abort", uploadCanceled, false);

				//saveImageFileHandler()
				function saveImageFileHandler(req)
				{
					Debug.log("saveImageFileHandler() was called for " + controlsPageName);// Req: " + req.responseText);
					Debug.log("Your page was succesfully saved!",Debug.INFO_PRIORITY);
				} //end saveImageFileHandler()

				var urn = DesktopContent._localUrnLid?DesktopContent._localUrnLid:DesktopContent._serverUrnLid;
				requestURL = "/urn:xdaq-application:lid="+urn+"/Request?RequestType=saveImageFile&CookieCode=" + DesktopContent._cookieCodeMailbox;
				xhr.open("POST", requestURL);

                //add other values to form so they are transmitted with files
				fd.append("isPublic", "false");
				fd.append("image", file);
				xhr.send(fd);

				var attributesTable = document.getElementById("widgetAttributesTable");
				var webpath = "";
				for(var tr = 0; tr < attributesTable.getElementsByTagName("tr").length; tr++)
				{
					if(attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td").length > 0)
					{
						var tdButton = attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td")[0].getElementsByTagName("input")[0];
						var parameter = tdButton.value;
						if (parameter == "upload_image")
							attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td")[1].getElementsByTagName("input")[0].value = webpath + filename;
					}
				}
			}// end uploadImage()

			//=====================================================================================
			function uploadProgress(evt)
			{
				if (evt.lengthComputable) {
					var percentComplete = Math.round(evt.loaded * 100 / evt.total);
					document.getElementById('checkFileSize').innerHTML = percentComplete.toString() + '%';
					Debug.log("Logbook uploadProgress " +  percentComplete.toString() + '%');
					if (percentComplete.toString() == "100")
						closeFilePopup();
				}
				else {
					document.getElementById('checkFileSize').innerHTML = 'unable to compute';
					Debug.log("Image uploadProgress 'unable to compute'");
				}
			}// end uploadProgress()

			//=====================================================================================
			// This event is raised when the server send back a response
			function uploadComplete(evt)
			{
				Debug.log("Logbook uploadComplete " +  evt.target.responseText);
			}// end uploadComplete()

			//=====================================================================================
			function uploadFailed(evt)
			{
				Debug.log("There was an error attempting to upload the file.");
			}// end uploadFailed()

			//=====================================================================================
			function uploadCanceled(evt)
			{
				Debug.log("The upload has been canceled by the user or the browser dropped the connection.");
			}// end uploadCanceled()


			//=====================================================================================
			function closeFilePopup()
			{
				document.getElementById("popupUploadSaveCsvFile").style.display = "none";
			} //end closeUploadFilePopup()


			//=====================================================================================
			function toggleGrid(on)
			{
				if(on)
				{
					mainBlock_.el.style["background-image"] = "linear-gradient(to right, " + gridColor_ + " 1px, transparent 1px), linear-gradient(" + gridColor_ + " 1px, transparent 1px)";
					mainBlock_.el.style["background-size"]  =  GRIDSIZE_ + "px " + GRIDSIZE_ + "px";
				}
				else
				{
					mainBlock_.el.style["background-image"] = "";
					mainBlock_.el.style["background-size"]  =  "";
				}
			} //end toggleGrid()


			//=====================================================================================
			function setBackgroundColor(color)
			{
				mainBlock_.el.style["background-color"] = color;
			} //end setBackgroundColor()


			//=====================================================================================
			function setGridColor(color, on)
			{
				gridColor_ = color;
				toggleGrid(on);
			} //end setGridColor()


			//=====================================================================================
			function setGridSnap(snap)
			{
				gridSnap_ = snap;
			} //end setGridSnap()


			//=====================================================================================
			function snapToGrip(val, gridSize)
			{
				if(gridSnap_)
				{
			    	var snap_candidate = gridSize * Math.round(val/gridSize);
			    	return snap_candidate;
				}
				else return val;
			} //end snapToGrip()


			//=====================================================================================
			function handleKeys(e,isKeyDown)
			{
				if (targetElement_==undefined) return;
				var id;

				if(e.shiftKey)
				{
					if(isKeyDown) return; //ignore shift keys down (only up)

					var ARROW_SPEED; if (gridSnap_) ARROW_SPEED = GRIDSIZE_; else ARROW_SPEED = 30;

					switch(e.keyCode)
					{
					case 88: 	//X (cut)
				    	console.log("cut widget",targetElement_);
				    	cutWidget(targetElement_);
				    	break;
					case 86: 	//V (paste)
				    	console.log("paste widget");
				    	pasteWidget();
				    	break;
					case 79: 	//O (open)
				    	console.log("toggle file manager");
				    	toggleFileMenu();
				    	break;
					case 69: 	//E (edit mode)
				    	console.log("toggle edit mode");
				    	toggleEditMode();
				    	break;
					case 38: 	//up arrow (move widget)
						id = localGetWidgetId();
						console.log(isKeyDown,"up move widget",id);
						page_.widgets[id].y -= ARROW_SPEED;
						drawWidget(id);
						break;
					case 40: 	//down arrow (move widget)
						id = localGetWidgetId();
						console.log(isKeyDown,"down move widget",id);
						page_.widgets[id].y += ARROW_SPEED;
						drawWidget(id);
						break;
					case 37: 	//left arrow (move widget)
						id = localGetWidgetId();
						console.log(isKeyDown,"left move widget",id);
						page_.widgets[id].x -= ARROW_SPEED;
						drawWidget(id);
						break;
					case 39: 	//right arrow (move widget)
						id = localGetWidgetId();
						console.log(isKeyDown,"right move widget",id);
						page_.widgets[id].x += ARROW_SPEED;
						drawWidget(id);
						break;
					default:;
					}
				} //end shift key + key handling
				else //no shift key
				{
					if(!isKeyDown) return; //ignore on key up side

					var ARROW_SPEED; if (gridSnap_) ARROW_SPEED = GRIDSIZE_; else ARROW_SPEED = 1;
					switch(e.keyCode)
					{
					case 38: 	//up arrow (move widget)
						id = localGetWidgetId();
				    	console.log(isKeyDown,"up move widget",id);
				    	page_.widgets[id].y -= ARROW_SPEED;
				    	drawWidget(id);
				    	break;
					case 40: 	//down arrow (move widget)
						id = localGetWidgetId();
				    	console.log(isKeyDown,"down move widget",id);
						page_.widgets[id].y += ARROW_SPEED;
				    	drawWidget(id);
				    	break;
					case 37: 	//left arrow (move widget)
						id = localGetWidgetId();
				    	console.log(isKeyDown,"left move widget",id);
				    	page_.widgets[id].x -= ARROW_SPEED;
				    	drawWidget(id);
				    	break;
					case 39: 	//right arrow (move widget)
						id = localGetWidgetId();
						console.log(isKeyDown,"right move widget",id);
						page_.widgets[id].x += ARROW_SPEED;
						drawWidget(id);
						break;
					default:;
					}
				} //end no shift key key handling

				return;

				//===============
				function localGetWidgetId()
				{
					var id;
					try
					{
						id = targetElement_.id.split('-')[1] | 0; //force integer
						if(page_.widgets[id] === undefined)
							throw ("Missing id target " + id);
					}
					catch(e)
					{
						Debug.log("Illegal target key element: " + e,
								Debug.HIGH_PRIORITY);
						throw(e);
					}
					return id;
				} //end localGetWidgetId
			} //end handleKeys()


			//=====================================================================================
			function bringToFront()
			{
				if(!targetElement_)
				{
					Debug.log("Ignoring bringToFront() with no target element");
					return;
				}
				var id = targetElement_.id.split('-')[1]|0;

				var widgetContainer = document.getElementById("widget-" + id + 
					"-container");
				if(widgetContainer)
				{
					var size = Object.keys(page_.widgets).length;
					widgetContainer.style.zIndex = size;

					for(widget in page_.widgets)
					{
						if(widget != id)
						{
							var container = document.getElementById("widget-" + widget + 
								"-container");
							if(container && container.style.zIndex > 0)
								container.style.zIndex--;
						}
					}
				}
				else
					Debug.log("Could not find widget container to bring to Front");

				toggleContextMenuOff();
			} //end bringToFront()


			//=====================================================================================
			function sendToBack()
			{
				if(!targetElement_)
				{
					Debug.log("Ignoring sendToBack() with no target element");
					return;
				}
				var id = targetElement_.id.split('-')[1]|0;

				var widgetContainer = document.getElementById("widget-" + id + 
					"-container");
				if(widgetContainer)
				{
					widgetContainer.style.zIndex = 0;

					var size = Object.keys(page_.widgets).length;

					for(widget in page_.widgets)
					{
						if(widget != id)
						{
							var container = document.getElementById("widget-" + widget + 
								"-container");
							if(container && container.style.zIndex < size)
								container.style.zIndex++;
						}
					}
				}
				else
					Debug.log("Could not find widget container to Send to Back");

				toggleContextMenuOff();
			} //end sendToBack()


			//=====================================================================================
			function deleteWidget()
			{
				if(!targetElement_)
				{
					Debug.log("Ignoring deleteWidget() with no target element");
					return;
				}
				var id = targetElement_.id.split('-')[1]|0;

				// delete widgets in tab bodies
				if (page_.widgets[id].type == WIDGET_TYPE_TAB
			 	 || page_.widgets[id].type == WIDGET_TYPE_NAVTAB)
			 	 {
			 	 	var tabs_num = targetElement_.children[0].childElementCount;
			 	 	for (var i=0; i<tabs_num; ++i)
						for(wid in page_.widgets)
							if(page_.widgets[wid].tabBodyID == "widget-"+id+"-tabBody-"+i)
							{
								targetElement_ = page_.widgets[wid].el;
								deleteWidget();
							}
 	 			}

				if(page_.widgets[id] && page_.widgets[id].el)
				{
					page_.widgets[id].el.parentNode.removeChild(page_.widgets[id].el);
					delete page_.widgets[id].el;
				}
				if(page_.widgets[id])
					delete page_.widgets[id];

				var widgetContainer = document.getElementById("widget-" + id + 
					"-container");
				if(widgetContainer)
				{
					var oldZindex = widgetContainer.style.zIndex;
					widgetContainer.parentNode.removeChild(widgetContainer);

					for(widget in page_.widgets)
					{
						var container = document.getElementById("widget-" + widget + 
							"-container");

						if(widget != id)
						{
							if(container && container.style.zIndex > oldZindex && container.style.zIndex > 0)
								container.style.zIndex--;
						}
					}
				}
				else
					Debug.log("Could not find widget container to remove");

				targetElement_ = undefined;
				toggleContextMenuOff();
			} //end deleteWidget()


			//=====================================================================================
			function cutWidget(widgetCover)
			{
				var id = widgetCover.id.substring(0, widgetCover.id.indexOf("-cover"));
				console.log(id);
				delete page_.widgets[id].el
				cutWidget_ = page_.widgets[id];
				console.log("here");
				console.log(widgetCover);
				console.log(page_.widgets[widgetCover.parentNode.getElementsByTagName("iframe")[0].id].el);
				console.log(widgetCover.id);
				cutWidgetId_ = id;
				delete page_.widgets[id];
				mainBlock_.el.removeChild(widgetCover.parentNode);

				toggleContextMenuOff();
			} //end cutWidget()


			//=====================================================================================
			function copyWidget()
			{
				if(!targetElement_)
				{
					Debug.log("Ignoring copyWidget() with no target element");
					return;
				}

				var id = targetElement_.id.split('-')[1]|0;

				if(page_.widgets[id])
					copyWidget_ = page_.widgets[id];

				toggleContextMenuOff();
			} //end copyWidget()


			//=====================================================================================
			function copyPasteWidget()
			{
				//Steps:
				//  - copy widget
				//	- when copy must create a new widget object for paste
				if(!targetElement_)
				{
					Debug.log("Ignoring copyPasteWidget() with no target element");
					return;
				}

				var id = targetElement_.id.split('-')[1]|0;

				if(page_.widgets[id])
					copyWidget_ = page_.widgets[id];

				if(copyWidget_)
				{
					//start at number of widgets, and then keep adding 1 until no record found in 
					var id = Object.keys(page_.widgets).length;
					while(page_.widgets[id] !== undefined)
						++id;
					Debug.log("copyPasteWidget(): Found new available widget ID = " + id);

					drawWidget(
							undefined /*create new id*/,
							copyWidget_.type,
							toPageXCoordinate(copyWidget_.x+20),
							toPageYCoordinate(copyWidget_.y+20),
							toPageXCoordinate(copyWidget_.w),
							toPageYCoordinate(copyWidget_.h)
							);

					page_.widgets[id].attributes = copyWidget_.attributes;
					page_.widgets[id].pvList = copyWidget_.pvList;
				}

				toggleContextMenuOff();
			} //end copyPasteWidget()

			//=====================================================================================
			function resizeWidgetToFullPage()
			{
				if(!targetElement_)
				{
					Debug.log("Ignoring resizeWidgetToFullPage() with no target element");
					return;
				}
				var id = targetElement_.id.split('-')[1]|0;

				if(page_.widgets[id])
				{
					drawWidget(
							id,
							page_.widgets[id].type,
							1,
							50,
							window.innerWidth-1,
							window.innerHeight-51
							);
				}

				toggleContextMenuOff();
			} //end resizeWidgetToFullPage()

			//=====================================================================================
			// the edit target, shows the dashed border
			function setEditModeWidgetTarget(target)
			{
				if(targetElement_ == target) return; //already the target

				//unselect previous target, and select parameter target

				//first unselect old target
				if(targetElement_)
				{
					var widget = page_.widgets[targetElement_.id.split('-')[1]|0];
					if(widget.type == WIDGET_TYPE_TAB || widget.type == WIDGET_TYPE_NAVTAB)
					{
						//show content now
					}
					widget.el.style.display = "block";
					var	els = widget.el.parentNode.getElementsByTagName("resizeWidgetCover");
					if(els.length)
						els[0].style.display = "none";		
				}

				//second select new target
				if(target)
				{
					var widget = page_.widgets[target.id.split('-')[1]|0];
					if(widget.type == WIDGET_TYPE_TAB || widget.type == WIDGET_TYPE_NAVTAB)
					{
						//show content now
					}
					widget.el.style.display = "none";
					var	els = widget.el.parentNode.getElementsByTagName("resizeWidgetCover");
					if(els.length)
						els[0].style.display = "block";		
				}

				// if(targetElement_ && targetElement_.parentNode)
				// {
				// 	var tid = targetElement_.id.split('-')[1]|0;
				// 	var els = targetElement_.parentNode.getElementsByTagName("iframe");
				// 	if(els.length)
				// 		els[0].style.display = "block";

				// 	els = targetElement_.parentNode.getElementsByTagName("resizeWidgetCover");
				// 	if(els.length)
				// 		els[0].style.display = "none";			
				// }

				targetElement_ = target;
				// if(targetElement_ && targetElement_.parentNode)
				// {
				// 	var els = targetElement_.parentNode.getElementsByTagName("iframe");
				// 	if(els.length)
				// 		els[0].style.display = "none";

				// 	els = targetElement_.parentNode.getElementsByTagName("resizeWidgetCover");
				// 	if(els.length)
				// 		els[0].style.display = "block";
				// }
			} //end setEditModeWidgetTarget()

			//=====================================================================================
			function handleWidgetCoverMouseDown(e,id)
			{
				if(id !== undefined && page_.widgets[id] && 
				(page_.widgets[id].type == WIDGET_TYPE_TAB || page_.widgets[id].type == WIDGET_TYPE_NAVTAB))
				{
					Debug.log("start Tab!");
				}

				//if clicking a scrollbar of a tab widget, BLOCK!
				if(e && e.target && 
					(e.offsetX > e.target.clientWidth ||
					e.offsetY > e.target.clientHeight))
				{
					Debug.log("Tab Widget Scrolling!? Ignore click",
						e.offsetX, e.target.clientWidth);
					return true;
				}

				targetTabBodyId_ = undefined;
				//allow drawing widget in widget cover
				if(!drawingSelectionRectangle_ && 
						dragAndDrawWidgetType_ !== undefined)
				{
					Debug.log("handleMouseDown " + dragAndDrawWidgetType_ );

					//check if starting drawing over a tab widget
					if(id !== undefined && (page_.widgets[id].type == WIDGET_TYPE_TAB || 
								page_.widgets[id].type == WIDGET_TYPE_NAVTAB))//page_.widgets[id].type == WIDGET_TYPE_TAB)
					{

						var tabcontent = page_.widgets[id].el.getElementsByClassName("tabWidgetBody");						
						for (var i = 0; i < tabcontent.length; i++) 
						{
							if (tabcontent[i].style.display == "block")
							{
								targetTabBodyId_ = tabcontent[i].id;
								break;
							}
						}
						Debug.log("Over tab widget",id,targetTabBodyId_);
						
					}

					drawSelectionRectangle(e);
				}
				else
					startWidgetDrag(e,id);
			} //end handleWidgetCoverMouseDown()

			//=====================================================================================
			function startWidgetDrag(e,id)
			{
				if(e) e.stopPropagation();

				if(editBlock_.isHidden)
				{
					Debug.log("Ignoring widget drag when not edit mode.");
					return; //ignore drag during edit mode
				}

				//validate target
				if(e.target.className.indexOf("widgetCover") < 0 &&
					e.target.className.indexOf("tabWidgetSelectButton") < 0 &&
					e.target.className.indexOf("tabWidgetBody") < 0)
				{
					Debug.log("Unknown drag target?! Notify admins id=" + id,
							Debug.HIGH_PRIORITY);
					return;
				}
				//else dragging a widget

				Debug.log("startWidgetDrag() id=" + id);

				if(targetTabBodyId_ && (targetTabBodyId_.split('-')[1]|0) != (id|0))
					targetTabBodyId_ = undefined; //clear target for new tab widget, otherwise take current value
				
				//check if starting drawing over a tab widget
				//if dragging tab widget, hide all content widgets
				if(id !== undefined && (page_.widgets[id].type == WIDGET_TYPE_TAB || 
								page_.widgets[id].type == WIDGET_TYPE_NAVTAB))
				{
					var tabcontent = page_.widgets[id].el.getElementsByClassName("tabWidgetBody");						
					for (var i = 0; i < tabcontent.length; i++) 
					{
						//save active tab body if not defined
						if (!targetTabBodyId_ &&
							tabcontent[i].style.display == "block")						
							targetTabBodyId_ = tabcontent[i].id;

						tabcontent[i].style.display = "none"; //hide all bodies
					}
				}

				resizeWidgetId_ = id;
				dragLockout_ = true; //indicate dragging

				redrawTargetWidget(e, 
						false /*doNotRestorePosition*/, 
						true /*isFirstTime*/); //redraw for first time
			} //end startWidgetDrag()


			//=====================================================================================
			function startWidgetResize(e,id)
			{
				if(e) e.stopPropagation();

				//verify known target
				if(e.target.className.indexOf("resizeWidgetCover") < 0)
				{
					Debug.log("Unknown resize target?! Notify admins id=" + id,
							Debug.HIGH_PRIORITY);
					return;
				}
				//else valid target

				Debug.log("startWidgetResize() id=" + id);

				indicateUserActivityToServer();	

				resizeWidgetId_ = id;
				resizeLockout_ = true;
				resizeFrom_ = e.target.id.substring(
						e.target.id.indexOf("resize-cover") + ("resize-cover").length + 1);

				redrawTargetWidget(e, 
						false /*doNotRestorePosition*/, 
						true /*isFirstTime*/); //redraw for first time
			} //end startWidgetResize()

			//=====================================================================================
			//Note: one mouseup handler must be the end all
			//	because the user is inaccurate with mouseup elements
			function endWidgetDragAndResize(e,id)
			{
				if(id !== undefined && page_.widgets[id] && 
				(page_.widgets[id].type == WIDGET_TYPE_TAB || page_.widgets[id].type == WIDGET_TYPE_NAVTAB))
				{
					Debug.log("end Tab!");
				}
				window.clearTimeout(dragTimeout_);
				if(e) e.stopPropagation();

				if(!resizeLockout_ && !dragLockout_ && 
						!dragAndDrawTargetEl_)
				{
					Debug.log("Unknown drag/resize end target. Ignoring drag/resize end.");

					//redraw target tab widget (in case this was due to a tab button click)
					if(targetTabBodyId_ && targetTabBodyId_ != "")
						drawWidget(targetTabBodyId_.split('-')[1]|0);
					return;
				}
				if(!dragAndDrawTargetEl_)
				{
					Debug.log("Unknown drag/resize end target?! Notify admins id=" + id,
							Debug.HIGH_PRIORITY);
					return;
				}

				Debug.log("endWidgetDragAndResize() " + id);
				if(!id)
				{	
					id = dragAndDrawTargetEl_.id.split('-')[1];
					Debug.log("endWidgetDragAndResize() " + id);
				}

				//restore cursor
				dragAndDrawTargetEl_.style.cursor = saveCursorType_;

				//if target element is a tab widget, redraw children objects at new position
				// if(id !== undefined && (page_.widgets[id].type == WIDGET_TYPE_TAB || 
				// 				page_.widgets[id].type == WIDGET_TYPE_NAVTAB))
				// {
				// 	var tabcontent = page_.widgets[id].el.getElementsByClassName("tabWidgetBody");						

				// 	Debug.log("endWidgetDragAndResize() tab widget", id, targetTabBodyId_);	
					
				// 	for (var j = 0; j < Object.keys(page_.widgets).length; j++) 						
				// 		if (j != id && //move all widgets in ANY tab
				// 			page_.widgets[j].tabBodyID.length &&
				// 			page_.widgets[j].tabBodyID.split('-')[1] == id) 				
				// 		{
				// 			//hide the -container element of the tab's active body's children							
				// 			if(page_.widgets[j].tabBodyID == targetTabBodyId_) 
				// 				page_.widgets[j].el.parentElement.style.display = "block";

				// 			if(resizeLockout_)
				// 				continue;
				// 			var ex, ey, deltaX, deltaY, newx, newy;

				// 			ex = snapToGrip(e.clientX, GRIDSIZE_);
				// 			ey = snapToGrip(e.clientY, GRIDSIZE_);

				// 			newx = toPageXCoordinate(page_.widgets[j].x);
				// 			newy = toPageYCoordinate(page_.widgets[j].y);

				// 			deltaX = ex - xPos_;
				// 			deltaY = ey - yPos_;

				// 			if (gridSnap_)
				// 			{
				// 				newx += -newx % GRIDSIZE_;
				// 				newy += -newy % GRIDSIZE_;
				// 			}
				// 			newx += deltaX;
				// 			newy += deltaY;
				// 			drawWidget(j, undefined, newx, newy);
				// 		}
				// }

				//redraw target widget one more time and keep final position
				redrawTargetWidget(e, true /*doNotRestorePosition*/);

				//check if widget is now within a tab body
				if(id !== undefined && 
					(page_.widgets[id].tabBodyID == "" || !page_.widgets[id].tabBodyID) && 
					page_.widgets[id].type != WIDGET_TYPE_TAB  &&
				 	page_.widgets[id].type != WIDGET_TYPE_NAVTAB)
				{
					for (var j = 0; j < Object.keys(page_.widgets).length; j++) 
						if(page_.widgets[j].type == WIDGET_TYPE_TAB || page_.widgets[j].type == WIDGET_TYPE_NAVTAB)
						{
							var tabcontent = page_.widgets[j].el.getElementsByClassName("tabWidgetBody");						
							for (var i = 0; i < tabcontent.length; i++) 
							{
								if (tabcontent[i].style.display == "block")
								{
									//found display body
									if(checkWidgetInTabBody(page_.widgets[id], 
										page_.widgets[j])) 
									{										
										addWidgetToTabBody(id,tabcontent[i].id);
										//apply x,y offset to compensate for tab body
										page_.widgets[id].x -= page_.widgets[j].x;
										page_.widgets[id].y -= page_.widgets[j].y;
										drawWidget(id);
									}
									break; //can only be one active body, so break
								} //end body within tab widget handling
							} //end body within tab widget search loop		
						} //end tab widget handling
					//end tab widget search loop
				}

				resizeFrom_ = undefined;
				resizeWidgetId_ = undefined;
				resizeLockout_ = false;
				dragLockout_ = false;
				dragAndDrawTargetEl_ = undefined;
			} //end endWidgetDragAndResize()

			//=====================================================================================
			//popWidgetOutOfTabBody ~~
			function popWidgetOutOfTabBody()
			{
				var id = targetElement_.id.split('-')[1]|0;
				Debug.log("popWidgetOutOfTabBody() id=",id);
				if(!page_.widgets[id])
				{
					Debug.err("Impossible popout widget ID Error",id);
					return;
				}
				page_.widgets[id].tabBodyID = "";
				
				var parentId = page_.widgets[id].el.parentNode.parentNode.id.split('-')[1];
				if(!page_.widgets[parentId])
				{
					Debug.err("Impossible popout parent widget ID Error",parentId);
					return;
				}

				//remove widget container from tab body
				page_.widgets[id].el.parentNode.parentNode.removeChild(
					page_.widgets[id].el.parentNode);

				//add widget container to main page
				mainBlock_.el.appendChild(page_.widgets[id].el.parentNode);

				//apply x,y offset to compensate for tab body
				page_.widgets[id].x += page_.widgets[parentId].x;
				page_.widgets[id].y += page_.widgets[parentId].y;
				drawWidget(id);
			} //end popWidgetOutOfTabBody()

			//=====================================================================================
			//addWidgetToTabBody ~~
			function addWidgetToTabBody(id,tabBodyID)
			{
				if(!page_.widgets[id] || !page_.widgets[id].el ||
					!page_.widgets[id].el.parentNode)
				{
					Debug.err("Impossible addWidgetToTabBody widget ID Error",id);
					return;
				}
				var tabBodyEl = document.getElementById(tabBodyID);
				if(!tabBodyEl)
				{
					Debug.err("Impossible addWidgetToTabBody tabBodyElError",tabBodyID);
					return;
				}
				var tid = tabBodyEl.id.split('-')[1]|0;

				page_.widgets[id].tabBodyID = tabBodyID;
				console.log("Widget is inside tabWidgetBody: " + tabBodyID);
				if(!page_.widgets[tid])
				{
					Debug.err("Impossible addWidgetToTabBody tab widget ID Error",tid);
					return;
				}

				//remove widget container from dashboard
				if(page_.widgets[id].el.parentNode.parentNode)
					page_.widgets[id].el.parentNode.parentNode.removeChild(
						page_.widgets[id].el.parentNode);

				//add widget container to active tab body
				tabBodyEl.appendChild(page_.widgets[id].el.parentNode);

			} //end addWidgetToTabBody()

			//=====================================================================================
			//redrawTargetWidget ~~
			//	handles mouse drag behavior for widget resize/translate
			function redrawTargetWidget(e, doNotRestorePosition, isFirstTime)
			{
				if(e) e.stopPropagation();

				var ex = snapToGrip(e.clientX, GRIDSIZE_);
				var ey = snapToGrip(e.clientY, GRIDSIZE_);

				if(isFirstTime)
				{
					indicateUserActivityToServer();
					dragAndDrawTargetEl_ = e.target;

					//save current cursor and set to grabbing cursor
					saveCursorType_ = dragAndDrawTargetEl_.style.cursor;
					dragAndDrawTargetEl_.style.cursor = "grabbing";
			
					xPos_ = ex;
					yPos_ = ey;

					if(resizeLockout_)
						Debug.log("Resizing from " + resizeFrom_);
					else if(dragLockout_)
						setEditModeWidgetTarget(dragAndDrawTargetEl_);
					else
					{
						Debug.log("Impossible resize/translate mode! Notify admins.",
								Debug.HIGH_PRIORITY);
						return;
					}
				} //end first time handling

				if(page_.widgets[resizeWidgetId_] === undefined)
				{
					Debug.log("Resize/translate widget target not found " + resizeWidgetId_);
					return; //skip resize/translate if widget does not exist
				}

				//save and restore starting x,y,w,h while user playing with size
				// on end resize/translate position will be finalized
				var saveSize = [page_.widgets[resizeWidgetId_].x,
								page_.widgets[resizeWidgetId_].y,
								page_.widgets[resizeWidgetId_].w,
								page_.widgets[resizeWidgetId_].h];

				var newx = toPageXCoordinate(page_.widgets[resizeWidgetId_].x);
				var newy = toPageYCoordinate(page_.widgets[resizeWidgetId_].y);
				var neww = toPageXCoordinate(page_.widgets[resizeWidgetId_].w);
				var newh = toPageYCoordinate(page_.widgets[resizeWidgetId_].h);

				var deltaX = ex - xPos_;
				var deltaY = ey - yPos_;

				if(gridSnap_)
				{
					newx += -newx%GRIDSIZE_;
					neww += -neww%GRIDSIZE_;
					newy += -newy%GRIDSIZE_;
					newh += -newh%GRIDSIZE_;
				}

				if(resizeLockout_)
				{
					//for resizing widget

					//Depending on where we are pulling the resize,
					//	which way means "make the widget bigger" is different
					if(resizeFrom_ == "north" || resizeFrom_ == "northeast" ||
						resizeFrom_ == "northwest")
					{
						if(newh - deltaY < 0) //if passed bottom
						{
							newy += newh; //top becomes old bottom
							newh = -(newh - deltaY);
						}
						else
						{
							newy += deltaY;
							newh -= deltaY;
						}												
					}

					if(resizeFrom_ == "east" || resizeFrom_ == "northeast" ||
						resizeFrom_ == "southeast")
					{
						if(neww + deltaX < 0) //if passed left
						{
							newx += neww + deltaX;
							neww = -(neww + deltaX);
						}
						else
						{
							neww += deltaX;
						}
					}

				 	if(resizeFrom_ == "south" || resizeFrom_ == "southeast" ||
				 		resizeFrom_ == "southwest")
					{
						if(newh + deltaY < 0) //if passed top
						{
							newy += newh + deltaY;
							newh = -(newh + deltaY);
						}
						else
						{
							newh += deltaY;
						}
					}

					if(resizeFrom_ == "west" || resizeFrom_ == "northwest" ||
						resizeFrom_ == "southwest")
					{
						if(neww - deltaX < 0) //if passed right
						{
							newx += neww; //left becomes old right
							neww = -(neww - deltaX);
						}
						else
						{
							newx += deltaX;
							neww -= deltaX;
						}
					}

				} //end resize handling
				else if(dragLockout_)
				{	//for dragging a widget
					newx += deltaX;
					newy += deltaY;
				} //end drag handling
				else
				{
					Debug.log("Impossible resize/translate mode! Notify admins.",
							Debug.HIGH_PRIORITY);
					return;
				}

				Debug.log("Resizing",newx,newy,neww,newh);
				drawWidget(
						resizeWidgetId_,
						undefined /*type not changed*/,
						newx,
						newy,
						neww,
						newh,
						doNotRestorePosition?false:true /*hideFrame*/);

				//restore starting x,y,w,h while user playing with size
				if(!doNotRestorePosition)
				{
					page_.widgets[resizeWidgetId_].x = saveSize[0];
					page_.widgets[resizeWidgetId_].y = saveSize[1];
					page_.widgets[resizeWidgetId_].w = saveSize[2];
					page_.widgets[resizeWidgetId_].h = saveSize[3];
				}
			} //end redrawTargetWidget()


			//=====================================================================================
			function handleMouseDown(e)
			{
				console.log("handleMouseDown",e.buttons,e.button);
				if(!drawingSelectionRectangle_ && 
						dragAndDrawWidgetType_ !== undefined)
				{
					targetTabBodyId_ = undefined;
					Debug.log("handleMouseDown " + dragAndDrawWidgetType_ );	
					drawSelectionRectangle(e);
				}
			} //end handleMouseDown()


			//=====================================================================================
			function handleMouseUp(e)
			{	
				Debug.log("handleMouseUp()");

				if(drawingSelectionRectangle_)
				{
					Debug.log("handleMouseUp finish widget draw type=" + 
							dragAndDrawWidgetType_);
					stopDragAndDrawRectangle(e);
				}
				else if(dragAndDrawTargetEl_ !== undefined)
				{
					Debug.log("handleMouseUp call finish drag/resize");
					endWidgetDragAndResize(e);
				}
				else if(!fileBlock_.isHidden)
				{
					Debug.log("handleMouseUp hide file menu");
					toggleFileMenu();
				}
				else //default click into nothingness
				{
					Debug.log("handleMouseUp click nothing handling");
					toggleContextMenuOff(e); //close widget context menu
					setEditModeWidgetTarget(/*no target*/);
				}

			} //end handleMouseUp()


			//=====================================================================================
			function handleMouseMove(e)
			{
				//Debug.log("handleMouseMove");
				if(drawingSelectionRectangle_)
				{ //drag and draw
					//console.log("handleMouseMove", dragAndDrawWidgetType_);
					if(e.buttons != 0)
						redrawSelectionRectangle(e);
					else //mouse up?! (should really be handled by mouse up, but maybe user went off screen with mouse)
						stopDragAndDrawRectangle(e);
				}
				else if(resizeLockout_ || dragLockout_)
				{ //dragging or resizing	
					//console.log("handleMouseMove", dragAndDrawTargetEl_);
					if(e.buttons != 0)
						redrawTargetWidget(e);
					else //mouse up?! (should really be handled by mouse up, but maybe user went off screen with mouse)
						endWidgetDragAndResize(e);
				}
			} //end handleMouseMove()


			//=====================================================================================
			function handleResize(e)
			{
				windowWidth_ = DesktopContent.getWindowWidth(); //window.innerWidth
				windowHeight_ = DesktopContent.getWindowHeight(); //window.innerHeight

				console.log("handleResize()","windowWidth_",windowWidth_,
						"windowHeight_",windowHeight_);

				for(widgetId in page_.widgets)
					drawWidget(widgetId);

				setEditModeWidgetTarget(/*no target*/);
				redrawWindow();
			}; //end handleResize()


			//=====================================================================================
			function redrawWindow(event, hover)
			{
				Debug.log("redrawWindow() clicked-hover: " + event + "-" + hover
				 	+ " w,h: " + windowWidth_+ "," + windowHeight_);

				var _MARGIN = 10;
				var _TOPMARGIN = 40;

				var maxWidth = windowWidth_;
				var maxHeight = windowHeight_ - (1 * _MARGIN);
				var marginLeft = 0;
				var cover = document.getElementById("mainBlockContainer");
				//var editCover = document.getElementById("editCoverDiv");

				hiddenWidth_ = maxWidth * 0.05;
				unhiddenWidth_ = maxWidth * 0.35;

				//DEFAULT VALUES //Sides Hidden
				var fileTop = _MARGIN, fileWidth = FILE_BLOCK_WIDTH, fileHeight = window.innerHeight;
				var editWidth = maxWidth, editHeight = EDIT_BLOCK_HEIGHT;
				var mainLeft = 0, mainTop = 0, mainWidth = maxWidth, mainHeight = window.innerHeight;			

				mainBlock_.el.style.left = mainLeft + "px";
				mainBlock_.el.style.top = "0px";
				mainBlock_.el.style.width =  mainWidth + "px";
				mainBlock_.el.style.height =  mainHeight + "px";
				mainBlock_.el.style.marginLeft = "0px";

				fileBlock_.el.style.top =  0 + "px";
			    fileBlock_.el.style.width =  fileWidth + "px";
				fileBlock_.el.style.height =  fileHeight + "px";

				editBlock_.el.style.width =  editWidth + "px";
				editBlock_.el.style.height =  editHeight + "px";

				cover.style.top			= 	mainTop + "px";
				cover.style.width		= 	(window.innerWidth-mainLeft) + "px";
				cover.style.height	    = 	window.innerHeight + "px";
				cover.style.left		= 	mainLeft + "px";

				editBlock_.el.style.bottom = (
						EDIT_BLOCK_PEEK_HEIGHT //i.e. document.getElementById("editorPanelTitle").offsetHeight, but it does not exist yet
						- EDIT_BLOCK_HEIGHT) + "px";
				editBlock_.el.style.marginBottom = 0 + "px";

				if(!editBlock_.isHidden)
				{
					console.log("Edit mode");
					UID_ = 0;
					//editCover.style.display = "none";
				}
				else
				{
					console.log("Not edit mode");
					//editCover.style.display = "block";
				}

				var navBar = document.getElementById("navigationBarDiv");

				if(isReadOnly_)
				{
					navBar.style.display = "none";
					if(!editBlock_.isHidden)
						toggleEditMode();

					console.log(navBar);
				}
				else
				{
					navBar.style.display = "block";
				}
			} //end redrawWindow()


			//=====================================================================================
			//evaluateJS ~~
			function evaluateJS(str)
			{
				Debug.log("evaluateJS = " + str);
				eval(str);
			} //end evaluateJS()


			//=====================================================================================
			function setRefreshRate(keyField,rateField)
			{
				console.log("setRefreshRate()",keyField.value,rateField.value);
				if(keyField.value != "")
					if(pvList_[keyField.value] != "")
						rateField.value = pvList_[keyField.value];
					else
						rateField.value = 10;
			} //end setRefreshRate()


			//=====================================================================================
			function isEmpty(obj)
			{
				return (Object.getOwnPropertyNames(obj).length === 0);
			} //end isEmpty()

		</script>
	</head>

	<body onload='//init() called by DesktopContent.js'>
		<div id="navigationBarDiv">
	   	  <nav>
		    <ul id="navigationMenu">
		      <li><a href="#" title="" id="menuli1" onclick="toggleFileMenu()">File Manager</a></li>
		      <li><a href="#" title="" id="menuli2" onclick="toggleEditMode()">Edit Mode</a></li>
		      <a href="#" title="" id="menuli3" onclick="goBackToPreviousPage()"></a>
		    </ul>
	      </nav>
		</div>

		<div class='mainBlock' 	id='fileBlock'  ></div>

		<div id="grayOutCoverDiv"></div>

		<div id="mainBlockContainer" height="auto" width="auto">
			<div class='mainBlock '	id='mainBlock' > <!-- onclick=redrawWindow("mainBlock") onmouseover="redrawWindow(null, false)"> -->
				<div id="contextMenuDiv">
					<nav id="contextMenu" class="menu ">
					  <ul class="menu__items ">
						<!--li class="menu__item ">
						  <a href="#" class="menu__link "
						  	onmousedown="event.stopPropagation();"
						  	onmouseup="event.stopPropagation(); toggleAddPV();">
							<i class=""></i> Add PV
						  </a>
						</li-->
						<li class="menu__item">
						  <a href="#" class="menu__link" 
						  	onmousedown="event.stopPropagation();"
						  	onmouseup="event.stopPropagation(); editWidgetAttributesOpen()" >
							<i class=""></i> Edit Attributes
						  </a>
						</li>
						<li class="menu__item">
						  <a href="#" class="menu__link" 
						  	onmousedown="event.stopPropagation();"
						  	onmouseup="event.stopPropagation(); bringToFront()">
							<i class=""></i> Bring to Front
						  </a>
						</li>
						<li class="menu__item">
						  <a href="#" class="menu__link" 
						  	onmousedown="event.stopPropagation();"
						  	onmouseup="event.stopPropagation(); sendToBack()">
							<i class=""></i> Send to Back
						  </a>
						</li>
						<li class="menu__item">
						  <a href="#" class="menu__link" 
						  	onmousedown="event.stopPropagation();"
						  	onmouseup="event.stopPropagation(); copyPasteWidget()">
							<i class=""></i> Copy and Paste Widget
						  </a>
						</li>
						<li class="menu__item" id="menu__item_popOutOfTab">
						  <a href="#" class="menu__link" 
						  	onmousedown="event.stopPropagation();"
						  	onmouseup="event.stopPropagation(); popWidgetOutOfTabBody(); toggleContextMenuOff();" >
							<i class=""></i> Pop-out of Tab Body
						  </a>
						</li>
						<li class="menu__item">
						  <a href="#" class="menu__link" 
						  	onmousedown="event.stopPropagation();"
						  	onmouseup="event.stopPropagation(); resizeWidgetToFullPage()">
							<i class=""></i> Resize Widget to full Page
						  </a>
						</li>
						<li class="menu__item">
						  <a href="#" class="menu__link" 
						  	onmousedown="event.stopPropagation();"
						  	onmouseup="event.stopPropagation(); deleteWidget();">
							<i class=""></i> Delete Widget
						  </a>
						</li>
						<li class="menu__item">
						  <a href="#" class="menu__link" 
						  	onmousedown="event.stopPropagation();"
						  	onmouseup="event.stopPropagation(); toggleContextMenuOff();" >
							<i class=""></i> Close
						  </a>
						</li>
					  </ul>
					</nav>
				</div>
				<div id="addPVMenuDiv">
				  <nav id="addPVMenu" class="menu ">
					<ul class="menu__items ">
					  <li class="menu__item ">
					<span class="menu__link">
					  <i class=""></i><input type="text" id="addPVPV" class="editableInput addPVMenuInput" placeholder="PV" list="pvDatalist"></input>
					</span> 		
					  </li>
					  <li class="menu__item">
					<span class="menu__link">
					  <i class=""></i><input type="text" id="addPVRefreshRate" class="editableInput addPVMenuInput" placeholder="Refresh Rate (ms)"></input>
					</span>
					  </li>
					  <li class="menu__item" style="height: auto">
					<span style="width: 100%; height: auto;">
					  <a href="#" onclick="addPVToWidget(document.getElementById('addPVPV').value, document.getElementById('addPVRefreshRate').value, document.getElementById('addPVMenuDiv').getAttribute('widgetID'), true)"><button type="button" class="menu__button" >Add PV </button></a>
					  <a href="#" onclick="toggleAddPV()"><button type="button" class="menu__button">Close</button></a>
						</span>
					  </li>
					</ul>
				  </nav>
				</div>
				<div class="drawAndDragBox-select" id="selectionRectangle"><span></span></div>
				</div>
				<!--div class="cover" id='editCoverDiv' onclick=toggleEditMode(true)></div-->
				<div class='mainBlock' id='editBlock' ></div>
			</div>

			<div id="popupSaveControlsPage" class="popup"
				onmouseup="event.stopPropagation();"
				onmousedown="event.stopPropagation();">
			  <center><h2>Save your page!</h2></center>
			  <div>
				<p><b>Page Name:</b></p>
				<center><textarea id="controlsPageName" cols="43" rows="1"></textarea></center>
				<p><b>Page Notes:</b></p>
				<center><textarea id="controlsPageNotes" cols="43" rows="5"></textarea></center>
				<div id="makeControlsPagePublic">
				  <input type="checkbox" id="isControlsPagePublic"> Make accessible to public</input>
				</div>
				<div class="buttongroup">
				  <center>
				<button onclick="hidePopupSaveControlsPage()">Cancel</button>
				<button onclick="savePhoebusPageAs()">Save Page</button>
				  </center>
				</div>
			  </div>
			</div>

			<div class='popupCsv' id='popupUploadSaveCsvFile'></div>

			<div class="editWidgetAttributesPopup-container" id="editWidgetAttributesPopup-container">
			  <div class="editWidgetAttributesPopup-header" id="editWidgetAttributesPopup-header" ></div>
			  <div class="editWidgetAttributesPopup-menu"   id="editWidgetAttributesPopup-menu">
				<nav id="editWidgetAttributesPopup-menu-nav">
				  <ul class="menu__items ">
				<li class="menu__item ">
				  <a href="#" class="menu__link " onclick="showeditWidgetAttributesPopupBody('EditPVlist')">
					<i class=""></i> Edits PVs
				  </a>
				</li>
				<li class="menu__item">
				  <a href="#" class="menu__link" onclick="showeditWidgetAttributesPopupBody('EditAttributes')" >
					<i class=""></i> Edit Attributes
				  </a>
				</li>
				<!--<li class="menu__item">
					<a href="#" class="menu__link" onclick="showeditWidgetAttributesPopupBody('Macromaker')">
					  <i class=""></i> Macromaker
					</a>
				</li>-->
				  </ul>
				</nav>
			  </div>
			  <div class="editWidgetAttributesPopup-body"   id="editWidgetAttributesPopup-body-pvlist"></div>
			  <div class="editWidgetAttributesPopup-body"   id="editWidgetAttributesPopup-body-attributes"><p>body</p></div>
			  <!--<div class="editWidgetAttributesPopup-body"   id="editWidgetAttributesPopup-body-macromaker"></div>-->
			  <div class="editWidgetAttributesPopup-footer" id="editWidgetAttributesPopup-footer"></div>
			</div> <!-- end main block -->
		</div> <!-- end main block container -->

		<datalist id="pvDatalist"></datalist>
		<p hidden id="mailbox"></p>

		<div class='preloadImage' id='preloadImage-treeEditTrashIconHover'></div>
		<div class='preloadImage' id='preloadImage-treeEditIconHover'></div>
	</body>
</html>
