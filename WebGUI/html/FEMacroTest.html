<!DOCTYPE HTML>
<html lang="en"> 
<head>
	<title>FE Macros</title>

	<link href='/WebPath/css/fonts.css?family=Inconsolata:400' rel='stylesheet' type='text/css'>
		
	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationGUI.css">

	<!-- MultiSelectBox: Must include .css style sheet and .js functionality -->
	<link rel="stylesheet" type="text/css" href="/WebPath/css/MultiSelectBox.css">
	<script type="text/JavaScript" src="/WebPath/js/js_lib/MultiSelectBox.js"></script>

	<style type="text/css">			

		/* fix margin for this page in Multi-Select (must have changed because of font/font-size) 
		.multiselectbox input, textarea {
			margin: 			14px 5px 5px 12px;
		} */

		/* make buttons and inputs have a hand cursor */
		input, button, select, a {
			cursor: 			pointer;
		}
	
		#popUpDialog {
			position: 			absolute;
			z-index: 			1000;    
			border: 			1px solid #770000;
		    background-color: 	#efeaea;
		    text-align: 		center;
		    padding: 			10px;
		}
		

		#clearDiv {
			clear: 				both;
		}
		
		#display {
			padding: 		10px;
			margin: auto;
		}
		
		#macroModulesTable, .macroModuleTable {
			border:				0;
			
		}
		body .macroModule{
			margin: auto;
		}
		.macroModule {
			border:				2px solid #000058;
			padding:			30px;
			background: rgb(255, 255, 255);
			/* background: -webkit-linear-gradient(top, #838AB1, #B2FFFC);
			background: -moz-linear-gradient(top, #838AB1, #B2FFFC);
			background: linear-gradient(to bottom, #838AB1, #B2FFFC); */
			margin: auto;
		}
				
		td {
			white-space: 		nowrap;
			vertical-align:		top;
		}
		
		.macroOutputName, .macroInputName  {
			font-weight:		bold;
		}
		h1{
			font-size: 			40px;
		}

		.goodValue {
			color:				darkgreen; 
			font-size:			inherit;
			font-weight:		bold;
		}
		.badValue {
			color:				red; 
			font-size:			inherit;
			font-weight:		bold;
		}

		.smallPopup {
			width:					300px;
			height:					120px;
			background-color: 		#002540;
			z-index:				9;
			position: 				fixed;
			top: 					30%;
			left: 					50%;
			margin-left: 			-110px;
			opacity:				0.9;
			border-radius:			5px;
			padding:				15px;
			color:					#c4e9f5;
			border: 				2px solid #c4e9f5;
			display:				none;
		}

		#historyContent {
			margin-bottom: 30px;
			height: 80vh;
			max-height: fit-content;
			overflow-y: auto;
			resize: horizontal;
		}

		.record .component {
			text-align: left;
			padding: 2px;
			font-weight: bold;
			cursor: pointer;
			/* white-space: initial; */
			text-overflow: clip;
		}

		.component {
			height: fit-content;
			display: grid;
			grid-template-columns: 4fr 1fr;
			height: auto;
		}

		.component button {
			float: right;
			margin-left: 2px;
		}
		
		.record.light {
			background-color: lightskyblue;
		}

		.record.dark {
			background-color: lightsteelblue;
		}

		.component.light {
			background-color: lavender;
		}

		.component.dark {
			background-color: lightgrey;
		}

		.macroInfo {
			background-image: url(/WebPath/images/windowContentImages/macromaker-information.png);
			position: absolute;
			background-size: cover;
			height: 24px;
			width: 24px;
		}

		#macroModule-sequence {
			display: none;
		}

		#sequence-builder, #show-sequence {
			max-height: 500px;
			overflow-y: auto;
			resize: horizontal;
		}

		.vbox
		{
			display: grid;
			grid-template-columns: 1fr;
			float: right;
		}
		
	</style>
	
	
	<script type="text/JavaScript" src="/WebPath/js/Globals.js"></script>	
	<script type="text/JavaScript" src="/WebPath/js/Debug.js"></script>	
	<script type="text/JavaScript" src="/WebPath/js/DesktopContent.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/js_lib/SimpleContextMenu.js"></script>
	
	<script>		
		
		
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////
	
		//functions:		
			//init()	
			//runMacro(r,c)
			//getDateString(date)
			//redraw()
			//checkForAnyFrontends()
			//handleSelectedFEClass(r,c)
			//multiFESelectionHandler(el)
			//feUIDMultiSelectToggle(r,c)
			//handleSelectedFEUID(r,c)
			//handleSelectedMacroType(r,c)
			//handleSelectedMacroName(r,c)
			//setCaretPosition(el, caretPos, endPos)

		var verticalOrientation_ = true;
		var sequenceMode_ = false;

		var feClassToFEsMap_; 	//map of FE Classes to FE UIDs
		var feToMacrosMap_;		//map of FE UIDs to FE Macro structure 
			//{requiredPermissions,inputs,outputs,supervisor,lid, feClass}
		var publicMacros_;		//map of macro name to macro structure
			//{requiredPermissions,inputs,outputs}
		var privateMacros_;		//map of macro name to macro structure
			//{requiredPermissions,inputs,outputs}
		
		var macroModuleLayoutString_ = "" ; //row,
											//col,
											//class or *,
											//UID or *,
											//macroType:=fe|public|private:username,
											//macroName;
		//macroModuleLayoutString_ += "0,1,DTCFrontEndInterface,ExampleInterface0,fe,ROC_Read;";
		//macroModuleLayoutString_ += "1,0,DTCFrontEndInterface,*,private,testPrivate;";
		
		macroModuleLayoutString_ += "0,0,*,*,fe,;";
		// macroModuleLayoutString_ += "1,0,*,*,fe,;";
		macroModuleLayoutString_ += "0,1,*,*,fe,;";
		// macroModuleLayoutString_ += "1,1,*,*,fe,;";
		macroModuleLayoutString_ += "0,2,*,*,fe,;";
		macroModuleLayoutString_ += "0,3,*,*,fe,;";
		
		var macroModules_; //row col to module struct
			//			macroModules_[r][c]["feClassSelected"] = feClassSelected;
			//			macroModules_[r][c]["feUIDSelected"] = feUIDSelected;
			//			macroModules_[r][c]["feMacroTypeSelected"] = feMacroTypeSelected;
			//			macroModules_[r][c]["feMacroNameSelected"] = feMacroNameSelected;
			//			macroModules_[r][c]["feMacroNameObject"] = feMacroNameObject;
		var layoutMaxRow_, layoutMaxCol_;

		var MACRO_TYPE_FE_ 			= "fe";
		var MACRO_TYPE_PUBLIC_ 		= "public";
		var MACRO_TYPE_PRIVATE_ 	= "private";
		var MACRO_TYPES_ = {
				"FE Macro Function" : 			MACRO_TYPE_FE_,
				"Public MacroMaker Macro" : 	MACRO_TYPE_PUBLIC_,
				"Private MacroMaker Macro" :	MACRO_TYPE_PRIVATE_,
		};
		var MAP_FROM_LAYOUT_TO_MACRO_TYPES_ = {}
		MAP_FROM_LAYOUT_TO_MACRO_TYPES_[MACRO_TYPE_FE_] 		= 0;
		MAP_FROM_LAYOUT_TO_MACRO_TYPES_[MACRO_TYPE_PUBLIC_] 	= 1;
		MAP_FROM_LAYOUT_TO_MACRO_TYPES_[MACRO_TYPE_PRIVATE_] 	= 2;

		var inputValueHistory_ = {}; //keep last input values, and recall for quick launches
		var multiSelectToggleSetting_ = {}; //true for multiselect display

		var focusedMacroCell = [-1,-1]; //when enter is pressed which macro to run

		var firstTime = true;

		var liveViewActive = false;

		var intervalTime;

		var currentLiveViewTimeout = null;
		
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////
		
		//=====================================================================================
		//toggleView ~~
		//toggleView called when user clicks to change view style
		function toggleView() 
		{			
			verticalOrientation_ = !verticalOrientation_;
			Debug.log("feMacroTest toggleView ",verticalOrientation_);
			init();
		} //end toggleView()
		
		//=====================================================================================
		//init ~~
		//init called once body has loaded
		function init() 
		{			
			if(firstTime)
			{
				firstTime = false;
			}
			
			Debug.closeErrorPop(); //close any debug pop-ups to start a blank slate 
			Debug.log("feMacroTest init ");

			macroModuleLayoutString_ = "" ; //row,
											//col,
											//class or *,
											//UID or *,
											//macroType:=fe|public|private:username,
											//macroName;
			//macroModuleLayoutString_ += "0,1,DTCFrontEndInterface,ExampleInterface0,fe,ROC_Read;";
			//macroModuleLayoutString_ += "1,0,DTCFrontEndInterface,*,private,testPrivate;";
			
			if(verticalOrientation_)
			{
				macroModuleLayoutString_ += "0,0,*,*,fe,;";
				macroModuleLayoutString_ += "0,1,*,*,fe,;";
				macroModuleLayoutString_ += "0,2,*,*,fe,;";
				macroModuleLayoutString_ += "0,3,*,*,fe,;";
			}
			else
			{
				macroModuleLayoutString_ += "0,0,*,*,fe,;";
				macroModuleLayoutString_ += "1,0,*,*,fe,;";
				macroModuleLayoutString_ += "0,1,*,*,fe,;";
				macroModuleLayoutString_ += "1,1,*,*,fe,;";
			}
	
	
			//get FE Macros
			DesktopContent.XMLHttpRequest("Request?RequestType=getFEMacroList", "", 
					function (req) 
					{			

						var str = "";

						//var user = DesktopContent.getXMLValue(req,"UserDisplayName");
						//Debug.log("user = " + user);

						var macroVar;
						var macroInArgs, macroOutArgs;
						var FEMACROS_HEADER_FIELDS = 4;
			
						feClassToFEsMap_ 	= {}; //reset
						feToMacrosMap_ 		= {}; //reset
						publicMacros_ 		= {}; //reset
						privateMacros_ 		= {}; //reset

						/////////////////////
						//FE Macros			
						var feMacros = req.responseXML.getElementsByTagName("FEMacros");
						Debug.log("feMacros.length = " + feMacros.length);	
						for(var i=0;i<feMacros.length;++i)
						{
							macroVar = feMacros[i].getAttribute("value");
							Debug.log(macroVar);
							macroVar = macroVar.split(";");

							var supervisor = macroVar[0];
							var lid = macroVar[1];
							var feClass = macroVar[2];
							var feUID = macroVar[3];
							
							if(1) // ALWAYS add FE in case want to run Macro //  macroVar.length > FEMACROS_HEADER_FIELDS) //at least one function, so display name
							{
								//add FE UID to FE Class in global map ---------------
								if(!feClassToFEsMap_[feClass])
								{
									Debug.log("Need to create FE Class to FE map entry.");							
									feClassToFEsMap_[feClass] = [];
								}
								feClassToFEsMap_[feClass].push(feUID);
							}

							var c = FEMACROS_HEADER_FIELDS;
							while(c < macroVar.length)
							{					
								var macroName = macroVar[c];

								//add FE Macro name to FE in global map ---------------
								if(!feToMacrosMap_[feUID])
								{
									Debug.log("Need to create FE to FE Macro map entry.");							
									feToMacrosMap_[feUID] = {};
								}
								feToMacrosMap_[feUID][macroName] = 
								{
										"requiredPermissions": 	macroVar[c+1],
										"tooltip":				decodeURIComponent(macroVar[c+2]),
										"inputs": 				[],
										"outputs": 				[],
										"supervisor": 			supervisor,
										"lid": 					lid,
										"feClass":				feClass,
								};
								c += 3; //skip permissions and tooltip
								for(var j=0;j<(macroVar[c]|0);++j)							
									feToMacrosMap_[feUID][macroName].inputs.push(decodeURIComponent(macroVar[c+1+j]));
								c += 1 + (macroVar[c]|0);
								for(var j=0;j<(macroVar[c]|0);++j)
									feToMacrosMap_[feUID][macroName].outputs.push(decodeURIComponent(macroVar[c+1+j]));																

									
								c += 1 + (macroVar[c]|0);
							} //end FE macro loop
		
						} //end FE supervisor loop
						
						/////////////////////
						//Public Macros			
						FEMACROS_HEADER_FIELDS = 2;
						var publicMacros = req.responseXML.getElementsByTagName("PublicMacro");
						Debug.log("publicMacros.length = " + publicMacros.length);	
						for(var i=0;i<publicMacros.length;++i)
						{
							macroVar = publicMacros[i].getAttribute("value");
							Debug.log(macroVar);
							macroVar = macroVar.split(":");

							var macroName = macroVar[0];
							var requiredPermissions = macroVar[1];

							publicMacros_[macroName] = 
							{
									"requiredPermissions": 	requiredPermissions,
									"inputs": 				[],
									"outputs": 				[],
							};


							var c = FEMACROS_HEADER_FIELDS;
							for(var j=0;j<(macroVar[c]|0);++j)							
								publicMacros_[macroName].inputs.push(macroVar[c+1+j]);
							c += 1 + (macroVar[c]|0);
							for(var j=0;j<(macroVar[c]|0);++j)
								publicMacros_[macroName].outputs.push(macroVar[c+1+j]);						
						} //end public macro loop

						/////////////////////
						//Private Macros		
						var privateMacros = req.responseXML.getElementsByTagName("PrivateMacro");
						Debug.log("privateMacros.length = " + privateMacros.length);	
						for(var i=0;i<privateMacros.length;++i)
						{
							macroVar = privateMacros[i].getAttribute("value");
							Debug.log(macroVar);
							macroVar = macroVar.split(":");

							var macroName = macroVar[0];
							var requiredPermissions = macroVar[1];

							privateMacros_[macroName] = 
							{
									"requiredPermissions": 	requiredPermissions,
									"inputs": 				[],
									"outputs": 				[],
							};


							var c = FEMACROS_HEADER_FIELDS;
							for(var j=0;j<(macroVar[c]|0);++j)							
								privateMacros_[macroName].inputs.push(macroVar[c+1+j]);
							c += 1 + (macroVar[c]|0);
							for(var j=0;j<(macroVar[c]|0);++j)
								privateMacros_[macroName].outputs.push(macroVar[c+1+j]);						
						} //end public macro loop
						

						console.log("feClassToFEsMap_",feClassToFEsMap_);
						console.log("feToMacrosMap_",feToMacrosMap_);
						console.log("privateMacros_",privateMacros_);
						console.log("publicMacros_",publicMacros_);
						

						if(Object.keys(feClassToFEsMap_).length == 0)
						{
							Debug.log("No FE Macros were found, have you Configured the State Machine? " +
									"Try configuring and then <a onclick='init()'>Refresh</a> this window.",
									Debug.WARN_PRIORITY);
						}

						//construct macro module layout
						console.log("macroModuleLayoutString_",macroModuleLayoutString_);

						macroModules_ = {}; //reset
						layoutMaxRow_ = 0;
						layoutMaxCol_ = 0;
						var layoutModules = macroModuleLayoutString_.split(';');
						for(var i=0;i<layoutModules.length;++i)
						{
							var layoutArgs = layoutModules[i].split(',');
							if(layoutArgs.length != 6)
								continue;
							console.log(i,":","layoutArgs",layoutArgs);

							//layout args:
							//			row,
							//			col,
							//			class or *,
							//			UID or *,
							//			macroType:=fe|public|private:username,
							//			macroName;
							var r = layoutArgs[0] | 0;
							var c = layoutArgs[1] | 0;
							var feClassSelected = layoutArgs[2];
							var feUIDSelected = layoutArgs[3];
							var feMacroTypeSelected = layoutArgs[4];
							var feMacroNameSelected = layoutArgs[5];

							if(r > layoutMaxRow_)
								layoutMaxRow_ = r;
							if(c > layoutMaxCol_)
								layoutMaxCol_ = c;

							if(!macroModules_[r])
								macroModules_[r] = {};
							if(!macroModules_[r][c])
								macroModules_[r][c] = {};
							macroModules_[r][c]["feClassSelected"] = feClassSelected;
							macroModules_[r][c]["feUIDSelected"] = feUIDSelected;
							macroModules_[r][c]["feMacroTypeSelected"] = feMacroTypeSelected;
							macroModules_[r][c]["feMacroNameSelected"] = feMacroNameSelected;
							macroModules_[r][c]["feMacroNameObject"] = undefined;

						} //end macro module extraction loop


						console.log("macroModules_",macroModules_);

						redraw();
						return;	
				
					}); //end getFEMacroList handler
		} //end init()
	
		//=====================================================================================
		//runMacro ~~
		var verticalOutputDivSize_ = [600,1000];
		var row, col;
		function runMacro(r, c)
		{
			row = r;
			col = c;
			//get any user resize of output element
			var el = document.getElementById("verticalLayoutOutputDiv");
			if(el)
			{
				Debug.log("Found output div at size ",el.offsetWidth,el.offsetHeight);
				verticalOutputDivSize_ = [el.offsetWidth,el.offsetHeight];
				el = document.getElementById("macroModule-output");
				el.style.width = (verticalOutputDivSize_[0] + 30) + "px";
			}


			Debug.log("runMacro(" + r + "," + c + ")");
			
			Debug.log("feUID target",macroModules_[r][c].feUIDSelected);

			var scrollTop = DesktopContent.getWindowScrollTop();
			Debug.log("Starting scroll position", scrollTop);

			if(!macroModules_[r])
			{
				Debug.log("Invalid row " + r + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			if(!macroModules_[r][c])
			{
				Debug.log("Invalid column " + c + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			
			var feClassSelected = macroModules_[r][c].feClassSelected;	
			var feUIDSelected = macroModules_[r][c].feUIDSelected;	
			var feMacroTypeSelected = macroModules_[r][c].feMacroTypeSelected;
			var macroName = macroModules_[r][c].feMacroNameSelected;
			
			var macroObj = macroModules_[r][c].feMacroNameObject[macroName];
			if(!macroObj)
			{
				Debug.log("Invalid Macro Name '" + macroName + "' - please select a valid Macro Name.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}

			
			var saveOutputs = document.getElementById("outputMacroToFile-row-" + r + "-col-" + c).checked?1:0;
			var inputsArr 	= macroObj.inputs;
			var outputsArr 	= macroObj.outputs;
			
			var inEls = document.getElementsByClassName(
					"macroInput-row-" + r + "-col-" + c
			);
			var postData = "";
			
			postData += "inputArgs=";
			inputData = "";
			//save input args to history, and last macroName map to input args for r,c FE macro cell			
			inputValueHistory_[r + "," + c] = [macroName, {}]; 
			for(var i=0;i<inputsArr.length;++i)
			{
				Debug.log("inputArgs " + inputsArr[i]);
				Debug.log("inputArgs.value " + inEls[i].value);
				inputValueHistory_[inputsArr[i]] = inEls[i].value;	
				inputValueHistory_[r + "," + c][1][inputsArr[i]] = inEls[i].value;				
				if(i) inputData += ";";
				inputData += encodeURIComponent(inputsArr[i]) + "," + encodeURIComponent(inEls[i].value);
			}
			postData += inputData;
			
			
			postData += "&outputArgs=";
			var outputData = "";
			for(var i=0;i<outputsArr.length;++i)
			{
				Debug.log("outputArgs " + outputsArr[i]);
				if(i) outputData += ",";
				outputData += encodeURIComponent(outputsArr[i]);
			}
			postData += outputData;
			
			console.log("postData",postData);
			
			var str = "";
			str += "Launched... " + getDateString(new Date) + 
					".. waiting for response...";
			var el;
			
			if(verticalOrientation_)
				el = document.getElementById(
					"macroModule-output");			
			else
				el = document.getElementById(
					"macroResults-row-" + r + "-col-" + c);
			el.innerHTML = str;

			// if I am building a sequence I do not have to run
			if (!sequenceBuilding_)
			{
				DesktopContent.XMLHttpRequest("Request?RequestType=runFEMacro" +					
					//"&feSupervisorID=" + feSupervisorID +
					"&feClassSelected=" + feClassSelected +
					"&feUIDSelected=" + feUIDSelected +
					"&macroType=" + feMacroTypeSelected +
					"&macroName=" + macroName + 
					"&saveOutputs=" + saveOutputs
					, postData, 
					handleMacroResponse,
					0 /*reqParam*/, 0 /*progressHandler*/, 
					true /*callHandlerOnErr*/
					);
			}

			if (currentLiveViewTimeout !== null)
			{
        		clearTimeout(currentLiveViewTimeout);
       			currentLiveViewTimeout = null;
   			}

			if (liveViewActive)
			{
        		currentLiveViewTimeout = setTimeout(function() { runMacro(r, c); }, intervalTime); 
    		}
			
			var command = {
				"feClass": feClassSelected,
				"feUID": feUIDSelected,
				"macroType": feMacroTypeSelected,
				"macroName": macroName,
				"inputArgs": inputData,
				"outputArgs": outputData,
				"saveOutputs": saveOutputs,
			}
			// add to the sequence
			if (verticalOrientation_ && sequenceBuilding_)
			{
				appendMacroToSequence(JSON.stringify(command));
				return;
			}
				
			if (verticalOrientation_)
				appendHistoryRecord(JSON.stringify(command));
		} //end runMacro()
		
		function handleMacroResponse(req, reqParam, errStr) 
		{
			var el;
			var scrollTop = DesktopContent.getWindowScrollTop();
			if(verticalOrientation_)
				el = document.getElementById("macroModule-output");			
			else
				el = document.getElementById("macroResults-row-" + row + "-col-" + col);	// r is not defined

			var str = "";
			
			if(!errStr) 
				errStr = "";
			var err = DesktopContent.getXMLValue(req,"Error");
			if(err && err != "")
				errStr += "\n" + err;				
			if(errStr != "")
			{
				str += "Received error... " + getDateString(new Date);
				str += "<br>";
				Debug.log("Error while running FE Macro: " + errStr,
						Debug.HIGH_PRIORITY);
				el.innerHTML = str;
				return;
			}
			
			var feExecs = req.responseXML.getElementsByTagName("feMacroExec");
			var feMacroRunArgNames = req.responseXML.getElementsByTagName("feMacroRunArgs_name");
			var feMacroRunArgValues = req.responseXML.getElementsByTagName("feMacroRunArgs_value");	
			
			Debug.log("feExecs .length = " + feExecs .length);	

			if(verticalOrientation_)
				str += DesktopContent.htmlOpen("div", //start macro module table
							{
								"id"		: "verticalLayoutOutputDiv",
								"style"		: "overflow:auto; width:" + 
									verticalOutputDivSize_[0] + "px; height:" + 
									verticalOutputDivSize_[1] + "px; resize: both;",									
							},
							"" /*innerHTML*/,
							false /*doCloseTag*/);

			var outputFileFound = false;
			for(var i=0;i<feMacroRunArgNames.length;++i)
			{
				var name = feMacroRunArgNames[i].getAttribute("value");
				//first decode URI, then convert html entities
				var value = Debug.errorPopConditionString(decodeURIComponent(
					feMacroRunArgValues[i].getAttribute("value")), 
					-1 /* allow max strings before truncation */);

				if(name == "Filename" || name == "filename")
				{
					str += name + " = " +
						//if filename, add link to CodeEditor
						DesktopContent.htmlOpen("a", //start macro module table
							{
								"title":"Open file in a new browser tab: \n" +
								value,
								"onclick":"DesktopContent.openNewBrowserTab(" +
								"\"Code Editor\",undefined /*subname undefined for LID lookup*/," + 
								"\"?" +
								"startFilePrimary=" +
								value + "\",undefined /*unique undefined for LID lookup*/);' ", //end onclick
							},
							value /*innerHTML*/,
							true /*doCloseTag*/) + "<br>";							

					outputFileFound = true;
				}
				else
				{
					value = value.replace(/OK/g,"<label class='goodValue'>OK</label>")
						.replace(/DONE/g,"<label class='goodValue'>DONE</label>")
						.replace(/GOOD/g,"<label class='goodValue'>GOOD</label>")
						.replace(/LOCKED/g,"<label class='goodValue'>LOCKED</label>")

						.replace(/Not/g,"<label class='badValue'>Not</label>")
						.replace(/DEAD/g,"<label class='badValue'>DEAD</label>")
						.replace(/FAILED/g,"<label class='badValue'>FAILED</label>")
						.replace(/FAIL/g,"<label class='badValue'>FAIL</label>")
						.replace(/ERROR/g,"<label class='badValue'>ERROR</label>")									.replace(/MISSING/g,"<label class='badValue'>MISSING</label>")
						.replace(/BAD/g,"<label class='badValue'>BAD</label>")
						;
					
					str += name + " = " + 
						value + "<br>";
				}
			} //end high-level fe macro run arguments
			
			for(var f=0;f == 0 || f<feExecs.length;++f)
			{
				if(feExecs.length)
				{
					var feMacroName =  feExecs[f].getAttribute("value");
					var feExecTime = DesktopContent.getXMLValue(feExecs[f],"exec_time");
					var feTargetUID = DesktopContent.getXMLValue(feExecs[f],"fe_uid");
					var feTargetHostname = DesktopContent.getXMLValue(feExecs[f],"fe_hostname");
					var feTargetContext = DesktopContent.getXMLValue(feExecs[f],"fe_context");
					var feTargetSupervisor = DesktopContent.getXMLValue(feExecs[f],"fe_supervisor");
					var outputArgNames = feExecs[f].getElementsByTagName("outputArgs_name");
					var outputArgValues = feExecs[f].getElementsByTagName("outputArgs_value");	
					
					if(f == 0)
					{
						str += "Last ran... " + getDateString(new Date) + "<br>";
						str += "FEMacro: &quot;" + feMacroName + "&quot;<br>";						
						str += "On " + feExecs.length + " front-end target(s).<br>";
					}
					
					if(!outputFileFound || outputArgNames.length > 1)
					{
						if(outputArgNames.length > 1 || f == 0)
							str += "<hr width='80%'><br>";
						str += "<b>";//Ran... " + feExecTime + "<br>";
						if(outputArgNames.length > 1 || f == 0)
							str += "FEMacro: &quot;" + feMacroName + "&quot;<br>";
						str += "FE Target #" + (f+1) + " UID: <label style='color:red; font-size:inherit;'>" +
							feTargetUID + "</label> (" + 
							feTargetHostname + ":" + feTargetContext + "/" + feTargetSupervisor + 
							")</b><br>";
					}
				}
				else //old way
				{
					var outputArgNames = req.responseXML.getElementsByTagName("outputArgs_name");
					var outputArgValues = req.responseXML.getElementsByTagName("outputArgs_value");	
					
					str += "Last ran... " + getDateString(new Date) + "<br>";
				}
			

				for(var i=0;i<outputArgNames.length;++i)
				{
					var name = outputArgNames[i].getAttribute("value");
					//first decode URI, then convert html entities
					var value = Debug.errorPopConditionString(decodeURIComponent(
							outputArgValues[i].getAttribute("value")), 
							-1 /* allow max strings before truncation */);

					if(name == "Filename" || name == "filename")
						str += name + " = " +
							//if filename, add link to CodeEditor
							DesktopContent.htmlOpen("a", //start macro module table
								{
									"title":"Open file in a new browser tab: \n" +
									value,
									"onclick":"DesktopContent.openNewBrowserTab(" +
									"\"Code Editor\",undefined /*subname undefined for LID lookup*/," + 
									"\"?" +
									"startFilePrimary=" +
									value + "\",undefined /*unique undefined for LID lookup*/);' ", //end onclick
								},
								value /*innerHTML*/,
								true /*doCloseTag*/) + "<br>";								
					else
					{
						value = value.replace(/OK/g,"<label class='goodValue'>OK</label>")
							.replace(/DONE/g,"<label class='goodValue'>DONE</label>")
							.replace(/GOOD/g,"<label class='goodValue'>GOOD</label>")
							.replace(/LOCKED/g,"<label class='goodValue'>LOCKED</label>")
							.replace(/Not/g,"<label class='badValue'>Not</label>")
							.replace(/DEAD/g,"<label class='badValue'>DEAD</label>")
							.replace(/FAILED/g,"<label class='badValue'>FAILED</label>")
							.replace(/FAIL/g,"<label class='badValue'>FAIL</label>")
							.replace(/ERROR/g,"<label class='badValue'>ERROR</label>")									
							.replace(/MISSING/g,"<label class='badValue'>MISSING</label>")
							.replace(/BAD/g,"<label class='badValue'>BAD</label>")
							;
						
						str += name + " = " + 
							value + "<br>";
					}
				}
				str += "<br>";
			}
			if(verticalOrientation_)
				str += "</div>"; //close scrolling div
			el.innerHTML = str;

			Debug.log("Returning scroll position", 
				DesktopContent.getWindowScrollTop(),"to",scrollTop);
			DesktopContent.setWindowScrollTop(scrollTop);				
		}

		//=====================================================================================
		//getDateString ~~
		var dayArr_ = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
		var monthArr_ = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
		function getDateString(date)
		{
			var dateStr = "";

			dateStr += dayArr_[date.getDay()];
			dateStr += " ";
			dateStr += monthArr_[date.getMonth()];
			dateStr += " ";
			dateStr += date.getDate();
			dateStr += " ";
			dateStr += date.getHours();
			dateStr += ":";
			dateStr += ((date.getMinutes()<10)?"0":"") + date.getMinutes();
			dateStr += ":";
			dateStr += ((date.getSeconds()<10)?"0":"") + date.getSeconds();
			dateStr += " ";
			dateStr += date.getFullYear();
			dateStr += " ";
			dateStr += date.toLocaleTimeString([],{timeZoneName: "short"}).split(" ")[2];
			return dateStr;
		} //end getDateString()
		
		//=====================================================================================
		//redraw ~~
		function redraw()
		{
			Debug.log("redraw()");

			var maxRow = layoutMaxRow_;
			var maxCol = layoutMaxCol_;
						
			console.log("maxRow",maxRow);
			console.log("maxCol",maxCol);
			
			//make module grid
			var str = "";
			str += DesktopContent.htmlOpen("table",
					{
							"id": "macroModulesTable",
					});
			for(var c=0;c<=maxCol;++c)
			{
				str += DesktopContent.htmlOpen("tr");
				for(var r=0;r<=maxRow;++r)
				{
					str += DesktopContent.htmlOpen(
							"td",
							{
								"id": "macroModule-row-" + r + "-col-" + c,
								"class":"macroModule",
								"onclick":"handleClickInMacroArea(" +
											r + "," + c + ");"
							},
						"" /*innerHTML*/,true /*doCloseTag*/);
				}
				if(c == 0 && verticalOrientation_) //create output area and the history
				{
					// add the output area
					str += DesktopContent.htmlOpen(
							"td",
							{
								"id": "macroModule-output",
								"class":"macroModule",
								"rowspan": maxRow,
								"width":"400px",
							},
						"<h3>Macro output will be displayed here.</h3>" 
						/*innerHTML*/,true /*doCloseTag*/);

					// add the history
					str += DesktopContent.htmlOpen(
						"td",
						{
							"id": "macroModule-history",
							"class":"macroModule",
							"rowspan": maxRow,
							"width":"400px",
						},
						"<div style='display: flex; justify-content: space-between; align-items: center; width: 100%;'>" +
							"<h3>Command history</h3>" +
							"<button id='liveViewBtn' onClick='toggleLiveView()'>Live View</button>",
						true);
					
					// add sequence builder
					str += DesktopContent.htmlOpen(
						"td",
						{
							"id": "macroModule-sequence",
							"class":"macroModule",
							"rowspan": maxRow,
							"width":"500px",
						},
						"<h3>Sequence Mode</h3>",
						true);
				}

				str += "</tr>";
			}
			str += "</table>";

			var el = document.getElementById("display");
			el.innerHTML = str;
			
			var count = 0;
			for(var row in macroModules_)
				for(var col in macroModules_[row])
				{					
					//layout args:
					//			row,
					//			col,
					//			class or *,
					//			UID or *,
					//			macroType:=fe|public|private:username,
					//			macroName;
					var r = row | 0;
					var c = col | 0;
					var feClassSelected = macroModules_[r][c].feClassSelected;
					var feUIDSelected = macroModules_[r][c].feUIDSelected;
					var feMacroTypeSelected = macroModules_[r][c].feMacroTypeSelected;
					var feMacroNameSelected = macroModules_[r][c].feMacroNameSelected;

					//make drop down for class, UID
					//	then inputs and outpus

					str = "";
					
					str += (++count) + ". <br>";
					
					str += DesktopContent.htmlOpen("table", //start macro module table
							{
									"class": "macroModuleTable",
							});
					{ //FE Class html
						str += DesktopContent.htmlOpen("tr"); //start row for FE Class
						str += DesktopContent.htmlOpen("td",{},"<b>FE Type:</b>" /*innerHTML*/,true /*doCloseTag*/);
						str += DesktopContent.htmlOpen("td");
						{
							str += DesktopContent.htmlOpen(
									"select",
									{
											"id": "feClassSelect-row-" + r + "-col-" + c,
											"class":"feClassSelect",
											"onclick":"checkForAnyFrontends();",
											"onchange":"handleSelectedFEClass(" +
											r + "," + c + ");",
									});
							str +=  DesktopContent.htmlOpen(
									"option" + ("*"==feClassSelected?" selected":""),
									{},
									"*" /*innerHTML*/,true /*doCloseTag*/);
							for(var feClass in feClassToFEsMap_) //go through class keys
							{
								console.log(feClass);
								str +=  DesktopContent.htmlOpen(
										"option" + (feClass==feClassSelected?" selected":""),
										{},
										feClass /*innerHTML*/,true /*doCloseTag*/);
							} //end class key loop
							str += "</select>";
						}
						str += "</td></tr>"; //end row for FE Class
					} //end FE Class html

					{ //FE UID html
						str += DesktopContent.htmlOpen("tr"); //start row for FE UID
						str += DesktopContent.htmlOpen("td",{},"<b>FE Target UID:</b>" /*innerHTML*/,true /*doCloseTag*/);
						str += DesktopContent.htmlOpen("td");
						{							
							str += DesktopContent.htmlOpen(
									"select",
									{
											"id": "feUIDSelect-row-" + r + "-col-" + c,
											"class":"feUIDSelect",
											"onclick":"checkForAnyFrontends();",
											"onchange":"handleSelectedFEUID(" +
											r + "," + c + ");",
									});
							str += "</select>";

							str += DesktopContent.htmlOpen(
									"input",
									{
											"type": "checkbox",
											"id": "feUIDMultiSelectToggle-row-" + r + "-col-" + c,
											"class":"feUIDMultiSelectToggle",
											"onchange":"feUIDMultiSelectToggle(" +
												r + "," + c + ");",
											"style" : "margin: 0 4px 0 0;"
									});
							str += "<a onclick='" +
								"var el = document.getElementById(\"feUIDMultiSelectToggle-row-" + r + "-col-" + c + "\");" +
								"var forFirefox = (el.checked = !el.checked);" +
								" feUIDMultiSelectToggle(" + r + "," + c + "); return false;'>";
							str += "Toggle Multi-select";
							str += "</a>";
							str += "</input>";

							str += DesktopContent.htmlOpen(
									"div",
									{
											"id": "feUIDMultiSelect-row-" + r + "-col-" + c,
											"class":"feUIDMultiSelect",
											// "onchange":"handleSelectedFEUID(" +
											// r + "," + c + ", 1 /*multiSelect*/);",
											"style": "margin-top:6px;",
									});
							str += "</div>";

						}
						str += "</td></tr>"; //end row for FE Class
					} //end FE Class html
					
					{ //Macro Type html
						str += DesktopContent.htmlOpen("tr"); //start row for Macro Type 
						str += DesktopContent.htmlOpen("td",{},"<b>Macro Type:</b>" /*innerHTML*/,true /*doCloseTag*/);
						str += DesktopContent.htmlOpen("td");
						{
							str += DesktopContent.htmlOpen(
									"select",
									{
											"id": "macroTypeSelect-row-" + r + "-col-" + c,
											"class":"macroTypeSelect",
											"onchange":"handleSelectedMacroType(" +
											r + "," + c + ");",
									});
							
							for(var macroType in MACRO_TYPES_) //go through class keys
							{
								console.log(macroType);
								str +=  DesktopContent.htmlOpen(
										"option" + (MACRO_TYPES_[macroType]==
												feMacroTypeSelected?" selected":""),
										{},
										macroType /*innerHTML*/,true /*doCloseTag*/);
							} //end class key loop
							str += "</select>";
						}
						str += "</td></tr>"; //end row for Macro Type 
					} //end Macro Type html

					{ //Macro Name html
						str += DesktopContent.htmlOpen("tr"); //start row for Macro Name
						str += DesktopContent.htmlOpen("td",{},"<b>Macro Name:</b>" /*innerHTML*/,true /*doCloseTag*/);
						str += DesktopContent.htmlOpen("td");
						{
							str += DesktopContent.htmlOpen(
									"select",
									{
											"id": "macroNameSelect-row-" + r + "-col-" + c,
											"class":"macroNameSelect",
											"onchange":"handleSelectedMacroName(" +
											r + "," + c + ");",
									});
							str += "</select>";
						}
						str += "</td></tr>"; //end row for Macro Name
					} //end Macro Name html
					
					{ //Macro Detail html
						str += DesktopContent.htmlOpen("tr"); //start row for Macro Detail
						str += DesktopContent.htmlOpen("td",{
								"colspan":"2",
								"id": "macroDetail-row-" + r + "-col-" + c,
								"class":"macroDetail",
								},"" /*innerHTML*/,true /*doCloseTag*/);
						str += "</tr>"; //end row for Macro Detail
					} //end Macro Detail html

					el = document.getElementById("macroModule-row-" + 
							r + "-col-" + c);
					el.innerHTML = str;

					handleSelectedFEClass(r,c);
			
				} //end macro module loop
			
			// fill the history module
			if (verticalOrientation_)
			{
				loadHistory();
				loadSequnces();
			}
			
		} //end redraw()

		//=====================================================================================
		//checkForAnyFrontends ~~		
		function checkForAnyFrontends()
		{
			if(Object.keys(feClassToFEsMap_).length == 0)
			{
				init();				
			}
		} //end checkForAnyFrontends()

		//=====================================================================================
		//handleSelectedFEClass ~~		
		function handleSelectedFEClass(r,c)
		{
			Debug.log("handleSelectedFEClass(" + r + "," + c + ")");
			
			var feClassSelected = document.getElementById("feClassSelect-row-" + 
					r + "-col-" + c).value;
			console.log("feClassSelected",feClassSelected);

			if(!macroModules_[r])
			{
				Debug.log("Invalid row " + r + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			if(!macroModules_[r][c])
			{
				Debug.log("Invalid column " + c + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			if(feClassSelected != "*" && !feClassToFEsMap_[feClassSelected])
			{
				Debug.log("Invalid FE Class '" + feClassSelected + "' specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("feClassToFEsMap_",feClassToFEsMap_);
				return;
			}
			
			macroModules_[r][c].feClassSelected = feClassSelected;
			var feUIDSelected = macroModules_[r][c].feUIDSelected;
			var feMacroTypeSelected = macroModules_[r][c].feMacroTypeSelected;
			var feMacroNameSelected = macroModules_[r][c].feMacroNameSelected;

			console.log("feUIDSelected",feUIDSelected);
			
			var str = "";
			
			str +=  DesktopContent.htmlOpen(
					"option",
					{},
					"*" /*innerHTML*/,true /*doCloseTag*/);
			
			var multiSelectArr = [];
			var selectedIndex = 0;
			var i = 1;
			var feUIDObject = feClassSelected == "*"?
					feToMacrosMap_:feClassToFEsMap_[feClassSelected];
			for(var feUIDptr in feUIDObject) //go through FE UIDs
			{
				var feUID = feClassSelected == "*"?
						feUIDptr:feClassToFEsMap_[feClassSelected][feUIDptr];
				
				Debug.logv({feUID});
				multiSelectArr.push(feUID);
				str +=  DesktopContent.htmlOpen(
						"option" ,
						{},
						feUID /*innerHTML*/,true /*doCloseTag*/);
				
				if(feUID == feUIDSelected)
					selectedIndex = i;
				++i;
			} //end FE UID loop		
			Debug.logv({multiSelectArr});
			
			// ignore errors now, because of multiselect complication
			// if(feUIDSelected != "*" && selectedIndex == 0)
			// {
			// 	Debug.log("Invalid FE UID '" + feUIDSelected + "' specified for layout module.",
			// 			Debug.WARN_PRIORITY);
			// 	console.log("feUIDObject",feUIDObject);
			// }			
			
			el = document.getElementById("feUIDSelect-row-" + 
					r + "-col-" + c);
			el.innerHTML = str;			

			var el1 = document.getElementById("feUIDMultiSelect-row-" + r + "-col-" + c);  
			MultiSelectBox.createSelectBox(el1,
					"box-" + r + "-" + c,
					"",
					multiSelectArr,multiSelectArr,multiSelectArr,
					multiFESelectionHandler,false /*noMultiSelect*/,
					undefined, undefined, undefined, undefined, /*mouseOverHandler,iconURLs,mouseDownHandler,mouseUpHandler*/
					true /*requireCtrlMultiClick*/,
					/*titles*/
					);

			
			el.selectedIndex =  selectedIndex;
			
			feUIDMultiSelectToggle(r,c, true /*redraw*/); //handle proper hiding
			MultiSelectBox.initMySelectBoxes(false); //setup selections	

			handleSelectedFEUID(r,c);
		} //end handleSelectedFEClass()

		
		//=====================================================================================
		//multiFESelectionHandler ~~
        function multiFESelectionHandler(el)
        {
			Debug.log("multiFESelectionHandler ID",el.id);
            // var i = MultiSelectBox.getSelectedIndex(el); 
            var selArr = MultiSelectBox.getSelectionArray(el);
            // if(selArr[i])
            // 	MultiSelectBox.dbg("box 1 Chosen element index:",i,            		
            // 		" value:",el.textContent,
            // 		" key:",el.getAttribute("key-value"),
            // 		" type:",el.getAttribute("type-value"));
			console.log(selArr);

			var uidSelStr = "";
            for(var s in selArr)
			{
				if(!selArr[s]) continue;

				if(uidSelStr.length) uidSelStr += ",";

                MultiSelectBox.dbg("box 1 selected [" + s + "]: ",
                		selArr[s]);
				uidSelStr += MultiSelectBox.getSelectionElementByIndex(
					el,s).getAttribute("key-value");
				
			}
			Debug.logv({uidSelStr});
			var splitArr = el.id.split('-');
	
			handleSelectedFEUID(splitArr[2]|0 /*r*/,
				splitArr[3]|0 /*c*/,
				uidSelStr);
            	
        } //end multiFESelectionHandler()

		//=====================================================================================
		//feUIDMultiSelectToggle ~~				
		function feUIDMultiSelectToggle(r,c,redraw)
		{
			if(!redraw && 
				(Object.keys(feClassToFEsMap_).length == 0 ||
				Object.keys(feClassToFEsMap_)[0] == "undefined"))				
			{
				init();				
			}

			if(multiSelectToggleSetting_[r] === undefined)
				multiSelectToggleSetting_[r] = {};
			if(multiSelectToggleSetting_[r][c] === undefined)
				multiSelectToggleSetting_[r][c] = redraw?0:1; //first time toggle to multi-select
			
			if(!redraw) //only toggle if not redrawing
				multiSelectToggleSetting_[r][c] = !multiSelectToggleSetting_[r][c];
			Debug.log("feUIDMultiSelectToggle(" + r + "," + c + ")",multiSelectToggleSetting_[r][c]);

			if(multiSelectToggleSetting_[r][c]) //show multiselect
			{
				document.getElementById("feUIDSelect-row-" + 
					r + "-col-" + c).style.display = "none";
				document.getElementById("feUIDMultiSelect-row-" + 
					r + "-col-" + c).style.display = "block";
				
				MultiSelectBox.initMySelectBoxes();
				multiFESelectionHandler(document.getElementById("feUIDMultiSelect-row-" + 
					r + "-col-" + c));
			}
			else //show single select
			{
				document.getElementById("feUIDSelect-row-" + 
					r + "-col-" + c).style.display = "block";
				document.getElementById("feUIDMultiSelect-row-" + 
					r + "-col-" + c).style.display = "none";
				handleSelectedFEUID(r,c);
			}

		} //end feUIDMultiSelectToggle()

		//=====================================================================================
		//handleSelectedFEUID ~~		
		function handleSelectedFEUID(r,c,multiSelectCSV)
		{
			Debug.log("handleSelectedFEUID(" + r + "," + c + 
				")multi",multiSelectCSV);

			Debug.log("feUID target",macroModules_[r][c].feUIDSelected);
			
			
			var feUIDSelected;
			
			if(multiSelectCSV === undefined)
				feUIDSelected = document.getElementById("feUIDSelect-row-" + 
					r + "-col-" + c).value;
			else
				feUIDSelected = multiSelectCSV;
			console.log("feUIDSelected",feUIDSelected);

			if(!macroModules_[r])
			{
				Debug.log("Invalid row " + r + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			if(!macroModules_[r][c])
			{
				Debug.log("Invalid column " + c + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			if(feUIDSelected != "*")
			{
				var feUIDarr = feUIDSelected.split(',');
				for(var i=0;i<feUIDarr.length;++i)
				{
					if(feUIDarr[i].length == 0) continue;

					if(!feToMacrosMap_[feUIDarr[i]])
					{
						Debug.log("Invalid FE UID '" + feUIDSelected + "' specified for layout module.",
								Debug.HIGH_PRIORITY);
						console.log("feToMacrosMap_",feToMacrosMap_);
						return;
					}
				}
			}
			
			macroModules_[r][c].feUIDSelected = feUIDSelected;
			var feMacroTypeSelected = macroModules_[r][c].feMacroTypeSelected;
			var feMacroNameSelected = macroModules_[r][c].feMacroNameSelected;

			Debug.log("feUID target",macroModules_[r][c].feUIDSelected);
			

			console.log("feMacroTypeSelected",feMacroTypeSelected);
			console.log("feMacroNameSelected",feMacroNameSelected);
			
			if(MAP_FROM_LAYOUT_TO_MACRO_TYPES_[feMacroTypeSelected] === undefined)
			{
				Debug.log("Invalid Macro Type '" + feMacroTypeSelected + "' specified for layout module.",
						Debug.WARN_PRIORITY);
				console.log("MAP_FROM_LAYOUT_TO_MACRO_TYPES_",MAP_FROM_LAYOUT_TO_MACRO_TYPES_);
			}	
			
			var selectedIndex = 
					MAP_FROM_LAYOUT_TO_MACRO_TYPES_[feMacroTypeSelected];
					
			selectedIndex = selectedIndex|0; //force to int
			Debug.log("Macro Type selected index: " + selectedIndex);
			
			el = document.getElementById("macroTypeSelect-row-" + 
					r + "-col-" + c);
			el.selectedIndex =  selectedIndex;

			handleSelectedMacroType(r,c);
			Debug.log("feUID target",macroModules_[r][c].feUIDSelected);
			

		} //end handleSelectedFEUID

		//=====================================================================================
		//handleSelectedMacroType ~~		
		function handleSelectedMacroType(r,c)
		{
			Debug.log("handleSelectedMacroType(" + r + "," + c + ")");
			

			if(!macroModules_[r])
			{
				Debug.log("Invalid row " + r + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			if(!macroModules_[r][c])
			{
				Debug.log("Invalid column " + c + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			
			var feMacroTypeSelected = document.getElementById("macroTypeSelect-row-" + 
					r + "-col-" + c).value;			
			feMacroTypeSelected = MACRO_TYPES_[feMacroTypeSelected]; //convert from readable to encoded macro type
			console.log("feMacroTypeSelected",feMacroTypeSelected);
			if(MAP_FROM_LAYOUT_TO_MACRO_TYPES_[feMacroTypeSelected] === undefined)
			{
				Debug.log("Invalid Macro Type '" + feMacroTypeSelected + "' specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("MAP_FROM_LAYOUT_TO_MACRO_TYPES_",MAP_FROM_LAYOUT_TO_MACRO_TYPES_);
				return;
			}

			macroModules_[r][c].feMacroTypeSelected = feMacroTypeSelected;	
			var feClassSelected = macroModules_[r][c].feClassSelected;
			var feUIDSelected = macroModules_[r][c].feUIDSelected;	
			var feMacroNameSelected = macroModules_[r][c].feMacroNameSelected;

			console.log("feMacroNameSelected",feMacroNameSelected);
			
			var str = "";

			var selectedIndex = -1;
			var i = 0;
			var macroNameObject;
			
			if(feMacroTypeSelected == MACRO_TYPE_PUBLIC_)
				macroNameObject = publicMacros_;
			else if(feMacroTypeSelected == MACRO_TYPE_PRIVATE_)
				macroNameObject = privateMacros_;
			else if(feUIDSelected != "*")
			{
				//old way, before multi-select added
				// macroNameObject = feToMacrosMap_[feUIDSelected];

				//do not assume all instances of a class are the same
				//	it may be true.. but instances have control of their registered macros
				//Need to explicitly check for set of common functions
				var macroNameCounter = {};	
				var countToMatch = 0;
				var feUIDarr = feUIDSelected.split(',');
				for(var i=0;i<feUIDarr.length;++i)
				{
					if(feUIDarr[i].length == 0) continue;
					
					for(var macroName in feToMacrosMap_[feUIDarr[i]])
						if(macroNameCounter[macroName])
							macroNameCounter[macroName].count++;
						else //init
							macroNameCounter[macroName] = {  
									"count":1,
									"macroObj":feToMacrosMap_[feUIDarr[i]][macroName]								
							};
					
					console.log("macroNameCounter",macroNameCounter);
					++countToMatch;
				}
				
				macroNameObject = {}; //make obj and set keys if count indicates common macro name

				for(var macroName in macroNameCounter)
				{
					if(macroNameCounter[macroName].count == countToMatch)
						macroNameObject[macroName] = 
								macroNameCounter[macroName].macroObj; //point to macro object
				}				

			}
			else if(feClassSelected != "*" && feClassToFEsMap_[feClassSelected])
			{
				//do not assume all instances of a class are the same
				//	it may be true.. but instances have control of their registered macros
				//Need to explicitly check for set of common functions
				var macroNameCounter = {};	
				var countToMatch = 0;
				for(var fe in feClassToFEsMap_[feClassSelected])
				{
					for(var macroName in feToMacrosMap_[
								feClassToFEsMap_[feClassSelected][fe]])
						if(macroNameCounter[macroName])
							macroNameCounter[macroName].count++;
						else //init
							macroNameCounter[macroName] = {  
									"count":1,
									"macroObj":feToMacrosMap_[
									feClassToFEsMap_[feClassSelected][fe]][macroName]								
							};
					
					console.log("macroNameCounter",macroNameCounter);
					++countToMatch;
				}
				
				macroNameObject = {}; //make obj and set keys if count indicates common macro name

				for(var macroName in macroNameCounter)
				{
					if(macroNameCounter[macroName].count == countToMatch)
						macroNameObject[macroName] = 
								macroNameCounter[macroName].macroObj; //point to macro object
				}				
			}
			else if(feClassSelected == "*")
			{
				//find the global common function set
				var macroNameCounter = {};	
				var countToMatch = 0;
				for(var feClass in feClassToFEsMap_)
					for(var fe in feClassToFEsMap_[feClass])
					{
						for(var macroName in feToMacrosMap_[
							feClassToFEsMap_[feClass][fe]])
							if(macroNameCounter[macroName])
								macroNameCounter[macroName].count++;
							else	//init
								macroNameCounter[macroName] = {
										"count":1,
										"macroObj":feToMacrosMap_[
										feClassToFEsMap_[feClass][fe]][macroName]
								};
	
						console.log("macroNameCounter",macroNameCounter);
						++countToMatch;
					}

				macroNameObject = {}; //make obj and set keys if count indicates common macro name

				for(var macroName in macroNameCounter)
				{
					if(macroNameCounter[macroName].count == countToMatch)
						macroNameObject[macroName] = 
								macroNameCounter[macroName].macroObj; //use this one
				}		
			}
			macroModules_[r][c].feMacroNameObject = macroNameObject;
			
			console.log("macroNameObject",macroNameObject);
			
			var i = 0;
			for(var macroName in macroNameObject) //go through Macro Names
			{
//				var macroName = feMacroTypeSelected == MACRO_TYPE_FE_?
//						feToMacrosMap_[feUIDSelected][macroNamePtr]:
//						(feMacroTypeSelected == MACRO_TYPE_PUBLIC_?
//								macroNamePtr:macroNamePtr);

				console.log(macroName);
				str +=  DesktopContent.htmlOpen(
						"option" ,
						{},
						macroName /*innerHTML*/,true /*doCloseTag*/);

				if(macroName == feMacroNameSelected)
					selectedIndex = i;
				++i;
			} //end Macro Names loop		

			if(feMacroNameSelected != "" && selectedIndex == -1)
			{
				Debug.log("Invalid Macro Name '" + feMacroNameSelected + "' specified for layout module.",
						Debug.WARN_PRIORITY);
				console.log("macroNameObject",macroNameObject);
				selectedIndex = 0;
			}			

			el = document.getElementById("macroNameSelect-row-" + 
					r + "-col-" + c);
			el.innerHTML = str;			

			el.selectedIndex =  selectedIndex;

			handleSelectedMacroName(r,c);
						
		} //end handleSelectedMacroType


		//=====================================================================================
		//handleSelectedMacroName ~~		
		function handleClickInMacroArea(r,c)
		{
			Debug.log("handleClickInMacroArea(" + r + "," + c + ")");
			focusedMacroCell = [r,c];
		} //end handleClickInMacroArea()

		//=====================================================================================
		//handleSelectedMacroName ~~		
		function handleSelectedMacroName(r,c)
		{
			Debug.log("handleSelectedMacroName(" + r + "," + c + ")");
			
			if(!macroModules_[r])
			{
				Debug.log("Invalid row " + r + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			if(!macroModules_[r][c])
			{
				Debug.log("Invalid column " + c + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			
			var feClassSelected = macroModules_[r][c].feClassSelected;
			var feUIDSelected = macroModules_[r][c].feUIDSelected;	
			var feMacroTypeSelected = macroModules_[r][c].feMacroTypeSelected;
			
			var feMacroNameSelected = document.getElementById("macroNameSelect-row-" + 
					r + "-col-" + c).value;		
			macroModules_[r][c].feMacroNameSelected = feMacroNameSelected;
			console.log("feMacroNameSelected",feMacroNameSelected);

			var macroNameObject = macroModules_[r][c].feMacroNameObject;
			
			if(!feMacroNameSelected || feMacroNameSelected == "")
			{
				Debug.log("No macro name selected.");
				return;
			}
			
			if(macroNameObject == undefined ||
					macroNameObject[feMacroNameSelected] === undefined)
			{
				Debug.log("Invalid Macro Name '" + feMacroNameSelected + "' specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroNameObject",macroNameObject);
				return;
			}
			
			//have macro specified now.. so display inputs/outputs/details
			
			var macroName = feMacroNameSelected;
			
			var macroObj = macroNameObject[macroName];
			var requiredPermissions = macroObj.requiredPermissions;			
			var inputsArr 	= macroObj.inputs;
			var outputsArr 	= macroObj.outputs;
			var tooltip 	= macroObj.tooltip;
			if(tooltip != "")
				DesktopContent.tooltip(macroName,tooltip);

			//var supervisor 	= macroObj.supervisor;
			//var lid 		= macroObj.lid;
			
			var str = "";


			//====================== create Inputs
			str += "<br>"
			str += "<b>&quot;" + macroName + "()&quot;</b> RequiredPermissions=" + requiredPermissions;
			if (tooltip != "")
			{
				str += "<span class='macroInfo' title='" + tooltip + "'></span>";
			}
					
			str += "<br>" +
				   "&nbsp;&nbsp;&nbsp; <b>Inputs (count=" + 
				   inputsArr.length + "):</b>" +
				   "<div style='margin-left:60px;'>";
			
			//create input text boxes
			if(inputsArr.length)
			{							
				var inputHistoryMap = inputValueHistory_;
				//if last macroName is the same, use the last inputs form this FE Macro cell as top priority
				if(inputValueHistory_[r + "," + c] && 
					inputValueHistory_[r + "," + c][0] == macroName)
					inputHistoryMap = inputValueHistory_[r + "," + c][1];

				str += "<table>";
				for(var i=0;i<inputsArr.length;++i)
				{													
					str += "<tr><td class='macroInputName'>";
					str += inputsArr[i] + ":";
					str += "</td><td>";
					str += DesktopContent.htmlOpen("input",{
							"type": "text",
							"id": "macroInput-row-" + r + "-col-" + c +
								"-i-" + i,
							"class":"macroInput " + "macroInput-row-" + r + "-col-" + c,
							"value":(inputHistoryMap[inputsArr[i]]?
								inputHistoryMap[inputsArr[i]]:"Default"),
							"onclick":"setCaretPosition(this,0,this.value.length);",
							"autocomplete":"off",
							"autocorrect":"off",
							"autocapitalize":"off",
					},"" /*innerHTML*/,true /*doCloseTag*/);							
					str += "</td></tr>";
				}
				str += "</table>";
			}
			else
				str += " No inputs.";

			str += "</div>";	//end inputs
			

			//====================== create Outputs
			str += "&nbsp;&nbsp;&nbsp; <b>Outputs (count=" + 
					outputsArr.length + "):</b>";

			str += DesktopContent.htmlOpen("div",{
					"id": "macroOutputs-row-" + r + "-col-" + c,
					"class":"macroOutputs",
					"style": "margin-left:60px;",
			});

			//create output representatives
			if(outputsArr.length)
			{			
				for(var i=0;i<outputsArr.length;++i)
				{			
					str += "<label class='macroOutputName'>" +
							outputsArr[i] + "</label><br>";				
				}
			}
			else
				str += " No outputs.<br>";

			str += "</div>"; 		//end outputs
			
			//====================== create Run button
			//create hidden div that will have output args persistently		

			var targetString = "";
			if(feClassSelected == "*" && feUIDSelected == "*")
				targetString = "all front-ends.";
			else if(feUIDSelected == "*")
				targetString = "all front-ends of type &apos;" +
					feClassSelected + ".&apos;";
			else if(feMacroTypeSelected == MACRO_TYPE_FE_)
				targetString = "FE &apos;" + feUIDSelected + "&apos; of type &apos;" +
					macroObj.feClass + ".&apos;";
			else
				targetString = "FE &apos;" + feUIDSelected + ".&apos;";

			str += "<br>";
			str += DesktopContent.htmlOpen("input",{
					"id": "runMacroButton-row-" + r + "-col-" + c,
					"class":"runMacroButton",
					"type":"button",					
					"onclick": "runMacro(" + r + "," + c + ");",
					"value": "Run",
					"title": "Run the " + 
						Object.keys(MACRO_TYPES_)[MAP_FROM_LAYOUT_TO_MACRO_TYPES_[feMacroTypeSelected]] + 
						" &apos;" + macroName + "&apos; on " + targetString,
			},"" /*innerHTML*/,true /*doCloseTag*/);
			
			str += DesktopContent.htmlOpen("input",{
					"id": "outputMacroToFile-row-" + r + "-col-" + c,
					"class":"outputMacroToFile",
					"type":"checkbox",
					"title": "When checked, output from Macro will be saved to file.",
			},"Save output to file" /*innerHTML*/,true /*doCloseTag*/);
			
			//end Run button
			
			str += DesktopContent.htmlOpen("div",{
					"id": "macroResults-row-" + r + "-col-" + c,
					"class":"macroResults",
			},"" /*innerHTML*/,true /*doCloseTag*/);
			
			
			el = document.getElementById("macroDetail-row-" + 
					r + "-col-" + c);
			el.innerHTML = str;
		} //end handleSelectedMacroName
		
		//=====================================================================================				
		//setCaretPosition ~~
		function setCaretPosition(el, caretPos, endPos) 
		{
			el.focus();
			el.setSelectionRange(caretPos, endPos);
		} //end setCaretPosition()

		//=====================================================================================				
		//handleKeyInput ~~
		function handleKeyInput(e) 
		{
			if(e.key == "Enter")
			{
				Debug.log("Enter on ",focusedMacroCell[0],focusedMacroCell[1]);
				runMacro(focusedMacroCell[0],focusedMacroCell[1]);
			}
		} //end handleKeyInput()
		//=====================================================================================				
		//loadHistory ~~
		var numRecords = 0;
		var lastMacro = "";

		function loadHistory()
		{
			var historyModule = document.getElementById("macroModule-history");
			// append the header of the module
			var str = DesktopContent.htmlOpen(
				"div",
				{
					"style": "margin:10px;"
				},
				"<h5>Scroll to see the history of commands. Click to rerun.</h5>",
				true);
			str += DesktopContent.htmlOpen(
				"div",
				{
					"id": "historyContent"
				},
				"",
				true);

			str += DesktopContent.htmlOpen(
				"button",
				{
					"id": "cleanHistoryBtn",
					"onClick": "showPopupClearHistoryConfirm()",
				},
				"Clear",
				true);

			historyModule.innerHTML += str;

			// send request to retrieve the stored history
			DesktopContent.XMLHttpRequest("Request?RequestType=loadFEHistory","",function(req) {
				// request hendler
				Debug.log("loadHistory() was called.");

				var historyString = DesktopContent.getXMLValue(req, "returnHistStr");
				if (!historyString) 
				{
					Debug.log("History is empty!");
					return;
				}
				var historyContent = document.getElementById("historyContent");
				// split the commands
				var commandList = historyString.split("#");
				for (var i = 0; i < commandList.length; i++) 
				{	
					appendHistoryRecord(commandList[i]);
				}
			});
			
			
		}

		function appendHistoryRecord(record) 
		{
			var historyContent = document.getElementById("historyContent");
			var command = JSON.parse(record);
			var counter = document.getElementById(numRecords + "-counter");
			if (counter && lastMacro === record)
			{
				// increment the number
				if (counter.innerText === "") counter.innerText = 1;
				counter.innerText = String(parseInt(counter.innerText) + 1);
				counter.innerText += "x";
				return;
			}
			lastMacro = record;
			// check the i to alternate the colors
			var className = "record ";
			if (numRecords % 2 == 0)
				className += "light";
			else 
				className += "dark";
			numRecords++;

			// create the record name
			var recordName = "";
			var inputArgs = command["inputArgs"].split(";");
			for (var j = 0; j < inputArgs.length; j++)
			{
				var tuple = inputArgs[j].split(",");
				if (j)
					recordName += "<br>&nbsp;&nbsp;&nbsp;&nbsp;"
				if (tuple[0] !== "")
					recordName += decodeURIComponent(tuple[0]) + "=" + decodeURIComponent(tuple[1]) + ";";
			}

			// build the record text
			var recordText = ""
			if (command["feUID"] === "*" && command["feClass"] !== "*")
			{
				recordText = "(all " + command["feClass"] + ") ";
			}
			else
			{
				recordText = "(" + command["feUID"] + ") ";
			}
			recordText += command["macroName"] + ": ";

 			// put the new history in head
			historyContent.innerHTML = DesktopContent.htmlOpen(
					"div",
					{
						"id": "historyRecord" + numRecords,
						"class": className,
						"onClick": "onClickHistoryRecord(" + record + ")"
					},
					"<span><i id='" + numRecords + "-counter'></i> " + recordText + "<br>&nbsp;&nbsp;&nbsp;&nbsp;" + (recordName === "" ? "No arguments": recordName) + "</span>",
					true) + historyContent.innerHTML;
		}

		// call the function when we click on the history
		function onClickHistoryRecord(recordObj)
		{

			// in bulding sequence mode add the macro to the sequence
			if (sequenceBuilding_)
			{
				appendMacroToSequence(JSON.stringify(recordObj));
				return;
			}
			
			var postData = "inputArgs=" + recordObj["inputArgs"] + "&outputArgs=" + recordObj["outputArgs"];
			DesktopContent.XMLHttpRequest("Request?RequestType=runFEMacro" +					
					//"&feSupervisorID=" + feSupervisorID +
					"&feClassSelected=" + recordObj["feClass"] +
					"&feUIDSelected=" + recordObj["feUID"] +
					"&macroType=" + recordObj["macroType"] +
					"&macroName=" + recordObj["macroName"] + 
					"&saveOutputs=" + parseInt(["saveOutputs"])
					, postData, 
					handleMacroResponse,
					0 /*reqParam*/, 0 /*progressHandler*/, 
					true /*callHandlerOnErr*/
					);
			
			if (currentLiveViewTimeout !== null) 
			{
        		clearTimeout(currentLiveViewTimeout);
       		 	currentLiveViewTimeout = null;
   			}

			// show the command in the interface
			appendHistoryRecord(JSON.stringify(recordObj));

			if (liveViewActive) {
				currentLiveViewTimeout = setTimeout(function() { onClickHistoryRecord(recordObj); }, intervalTime); 
    		}
		}

		// ask confirm before clearing the history
		function showPopupClearHistoryConfirm()
		{
			var popupClearAllConfirm = document.getElementById("popupClearHistoryConfirm");
			popupClearAllConfirm.style.display = "block";
		}

		// hide the popup
		function hideSmallPopup(el)
		{
			var sequenceNameInput = document.getElementById("sequenceName");
			sequenceNameInput.value = "";

			var errorMessage = document.getElementById("sequenceName-error");
			errorMessage.innerText = "";

			var wholeDiv = el.parentNode.parentNode.parentNode;
			wholeDiv.style.display = "none";

		}

		// hide the popup for live view
		function hideSmallPopupLiveView(el)
		{
			var wholeDiv = el.parentNode.parentNode.parentNode;
			wholeDiv.style.display = "none";
			liveViewActive = false;
			document.getElementById('intervalTime').value = '2';

		}

		// clear the history
		function clearHistory(el)
		{
			DesktopContent.XMLHttpRequest("Request?RequestType=clearFEHistory","", null);
			var contentEl = document.getElementById('historyContent');
			contentEl.innerHTML = "";
			hideSmallPopup(el);
		}
		//=====================================================================================				
		// live view
		function toggleLiveView()
		{

			liveViewActive = !liveViewActive;

			if (liveViewActive) 
			{
				document.getElementById('popupSetInterval').style.display = 'block';
				var inputField = document.getElementById("intervalTime");
				inputField.focus();
				inputField.select();

			}
			else
			{

				if (currentLiveViewTimeout !== null)
				{
            		clearTimeout(currentLiveViewTimeout);
            		currentLiveViewTimeout = null;
       			}

				liveViewActive = false;
				document.getElementById('intervalTime').value = '2';
			
				var liveViewBtn = document.getElementById('liveViewBtn');
				liveViewBtn.textContent = 'Live View';
				liveViewBtn.style.backgroundColor = '';
				liveViewBtn.style.color = '';			
			}

		}
	
		function setIntervalAndStart() 
		{
			var intervalTimeInput = document.getElementById('intervalTime').value*1000;
			intervalTime = parseInt(intervalTimeInput);

			if (isNaN(intervalTime) || intervalTime <= 0)
			{
				alert("Please enter a valid number greater than 0");
				return;
			}

			document.getElementById('popupSetInterval').style.display = 'none';

			var liveViewBtn = document.getElementById('liveViewBtn');
			liveViewBtn.textContent = 'Stop Live View';
			liveViewBtn.style.backgroundColor = 'red';
			liveViewBtn.style.color = 'white';
			

			if (!liveViewActive)
			{
				liveViewActive = true;
			}
		}

		function handleEnterPress(event) 
		{
        	if (event.key === "Enter" || event.keyCode === 13)
			{
            	event.preventDefault();
            
            	setIntervalAndStart();

           		return false;
        	}
        return true;
    	}    

		//=====================================================================================	
		//loadSequence

		var sequenceBuilding_ = false;
		var selectedSequence_ = {};
		var tempSequence_ = {}

		// UTILS

		function statusActionButtons(status)
		{
			var runBtn = document.getElementById("runSequenceBtn");
			var editBtn = document.getElementById("editSequenceBtn");
			var deleteBtn = document.getElementById("deleteSequenceBtn");
			var newBtn = document.getElementById("newSequenceBtn");
			runBtn.disabled = status;
			editBtn.disabled = status;
			deleteBtn.disabled = status;
			newBtn.disabled = !status;
		}

		function statusEditButtons(status)
		{
			var testBtn = document.getElementById("testSequenceBtn");
			var saveBtn = document.getElementById("saveSequenceBtn");
			var resetBtn = document.getElementById("resetSequenceBtn");
			resetBtn.disabled = status;
			testBtn.disabled = status;
			saveBtn.disabled = status;
		}

		function showSequence(target, seq)
		{
			console.log(target, seq);
			var container = document.getElementById(target);
			container.innerHTML = "";
			var GUIIndex = 0;
			for (const entry of Object.entries(seq))
			{
				var index = entry[0];
				var command = JSON.parse(entry[1]);
				// alternate the color
				var className = "component ";
				if (GUIIndex % 2 == 0)
					className += "light";
				else 
					className += "dark";

				// create the record name
				var recordName = "";
				var inputArgs = command["inputArgs"].split(";");
				for (var j = 0; j < inputArgs.length; j++)
				{
					var tuple = inputArgs[j].split(",");
					if (j)
						recordName += "<br>&nbsp;&nbsp;&nbsp;&nbsp;"
					if (tuple[0] !== "")
						recordName += decodeURIComponent(tuple[0]) + "=" + decodeURIComponent(tuple[1]) + ";";
				}

				// build the record text
				var recordText = ""
				if (command["feUID"] === "*" && command["feClass"] !== "*")
					recordText = "(all " + command["feClass"] + ") ";
				else
					recordText = "(" + command["feUID"] + ") ";

				recordText += command["macroName"] + ": ";

				container.innerHTML += DesktopContent.htmlOpen(
					"div",
					{
						"id": "sequenceComponent-" + index,
						"class": className,
					},
					"<span><i>#" + (GUIIndex + 1) + "</i> " + recordText + "<br>&nbsp;&nbsp;&nbsp;&nbsp;" + (recordName === "" ? "No arguments": recordName) + "</span>",
					true);

				GUIIndex++;
				if (target === "sequence-builder") 
				{
					// append control sequence buttons
					var sequence = document.getElementById("sequenceComponent-" + index);
					var sequenceAction = document.createElement("div");
					sequenceAction.setAttribute("class", "vbox");
					// up button
					var upBtn = document.createElement("button");
					upBtn.innerText = "Up";
					upBtn.setAttribute("onClick", "moveUpSequence(" + index + ")");
					// down button
					var downBtn = document.createElement("button");
					downBtn.innerText = "Down";
					downBtn.setAttribute("onClick", "moveDownSequence(" + index + ")");
					// up button
					const removeBtn = document.createElement("button");
					removeBtn.innerText = "X";
					removeBtn.setAttribute("onClick", "removeFromSequence(" + index + ")");

					sequenceAction.appendChild(upBtn);
					sequenceAction.appendChild(downBtn);
					sequenceAction.appendChild(removeBtn);
					sequence.appendChild(sequenceAction);
				}
			}
		}

		function showPopupSaveSequence()
		{
			var popup = document.getElementById("popupSaveSequence");
			var sequenceNameInput = document.getElementById("sequenceName");
			popup.style.display = "grid";
			popup.style.gridTemplateColumns = "1fr";
			sequenceNameInput.value = "";
			sequenceNameInput.focus();
		}

		function hidePopupSaveSequence()
		{
			var popup = document.getElementById("popupSaveSequence");
			popup.style.display = "none";
		}

		// END UTILS

		function toggleSequenceMode()
		{
			sequenceMode_ = !sequenceMode_;
			var sequenceModule = document.getElementById("macroModule-sequence");
			if (sequenceMode_)
			{
				sequenceModule.style.display = "block";
			}
			else
			{
				sequenceModule.style.display = "none";
			}
		}	

		function loadSequnces()
		{
			var sequenceModule = document.getElementById("macroModule-sequence");
			// dropdown menu to select the stored sequences
			var select = DesktopContent.htmlOpen(
				"select",
				{
					"id": "select-sequence",
					"style": "width: 150px;",
					"onChange": "selectSequence(this.value)"
				},
				"<option value='undefined'>None</option>",
				true,
			)
			var str = DesktopContent.htmlOpen(
				"div",
				{
					"id": "sequnce-selector",
					"style": "margin:10px; display: inline-flex; gap: 15px;"
				},
				"<p><strong>Select sequence: </strong></p>" + select,
				true);
			// space used to show the steps of each sequence
			str += DesktopContent.htmlOpen(
				"div",
				{
					"id": "show-sequence",
				},
				"",
				true);
			// action buttons (8)
			var runButton = DesktopContent.htmlOpen(
				"button",
				{
					"id": "runSequenceBtn",
					"onClick": "runSequence()",
					"disabled": "true",
				},
				"Run",
				true);
			var editButton = DesktopContent.htmlOpen(
				"button",
				{
					"id": "editSequenceBtn",
					"onClick": "editSequence()",
					"disabled": "true",
				},
				"Edit",
				true);
			var deleteButton = DesktopContent.htmlOpen(
				"button",
				{
					"id": "deleteSequenceBtn",
					"style": "background-color: Red; color: white;",
					"onClick": "deleteSequence()",
					"disabled": "true",
				},
				"Delete",
				true);
			var newButton = DesktopContent.htmlOpen(
				"button",
				{
					"id": "newSequenceBtn",
					"style": "background-color: green; color: white;",
					"onClick": "newSequence()",
				},
				"New",
				true);
			var saveButton = DesktopContent.htmlOpen(
				"button",
				{
					"id": "saveSequenceBtn",
					"disabled": true,
					"onClick": "showPopupSaveSequence()",
				},
				"Save",
				true);
			var testButton = DesktopContent.htmlOpen(
				"button",
				{
					"id": "testSequenceBtn",
					"disabled": true,
					"onClick": "testSequence()",
				},
				"Test",
				true);
			var resetButton = DesktopContent.htmlOpen(
				"button",
				{
					"id": "resetSequenceBtn",
					"disabled": true,
					"onClick": "resetSequence()",
				},
				"Reset",
				true);
			var closeButton = DesktopContent.htmlOpen(
				"button",
				{
					"id": "closeSequenceBtn",
					"onClick": "closeSequence()",
				},
				"Close",
				true);
			
			str += DesktopContent.htmlOpen(
				"div",
				{
					"id": "sequence-buttons",
					"style": "margin-top:10px; display: flex; gap: 20px"
				},
				runButton + editButton + deleteButton + newButton,
				true);

			// area to build the sequence
			str += DesktopContent.htmlOpen(
				"div",
				{
					"id": "sequence-builder",
					"style": "margin-top:10px;"
				},
				"",
				true);
			str += DesktopContent.htmlOpen(
				"div",
				{
					"id": "sequence-builder-buttons",
					"style": "margin-top:10px; display: none; gap: 20px"
				},
				testButton + saveButton + resetButton + closeButton,
				true);
			
			
			sequenceModule.innerHTML += str;
			// load saved sequences
			DesktopContent.XMLHttpRequest("Request?RequestType=loadMacroSequences",
				"",
				function(req) {
					// request hendler
					Debug.log("loadMacroSequences() was called.");

					var sequenceString = DesktopContent.getXMLValue(req, "sequences");
					if (!sequenceString) 
					{
						Debug.log("Sequence is empty!");
						return;
					}
					var sequenceSelector = document.getElementById("select-sequence");
					// split the commands
					var sequenceNameList = sequenceString.split(";")
												.filter((seqName) => seqName.includes(".dat"))
												.map((seqName) => seqName.slice(0, -4));

					for (var seq of sequenceNameList)
					{
						var option = document.createElement("option");
						option.text = seq;
						option.value = seq;
						sequenceSelector.add(option);
					}
				}
			);
		}

		// ACTIONS

		// TODO
		function runSequence()
		{
			// call the API
			var selector = document.getElementById("select-sequence");

			DesktopContent.XMLHttpRequest("Request?RequestType=runSequence" +
				"&name=" + selector.value,
				"",
				function() {
					// request hendler
					Debug.log("runFEMacroSequence() was called.");
					// TODO: show the results
				}
			);
			console.log("run", selectedSequence_);
		}

		function newSequence() 
		{
			// disable action buttons
			statusActionButtons(false);
			// clean selected sequence
			selectSequence();
			// allow editing
			sequenceBuilding_ = true;
			// empty builder
			tempSequence_ = {};
			showSequence("sequence-builder", tempSequence_);
			// show edit buttons
			var builderActions = document.getElementById("sequence-builder-buttons");			
			builderActions.style.display = "flex";
		}

		function deleteSequence()
		{
			// call the API
			var selector = document.getElementById("select-sequence");

			DesktopContent.XMLHttpRequest("Request?RequestType=deleteSequence" +
				"&name=" + selector.value,
				"",
				function() {
					// request hendler
					Debug.log("deleteSequences() was called.");
					
					// remove the option
					for (var index = 0; selector.options.length; index++)
					{
						if (selector.options[index].value === selector.value)
						{
							selector.remove(index);
							break;
						}
					}

					// clean the list
					selectedSequence_ = {};
					showSequence("show-sequence", selectedSequence_);
					// deactive buttons
					statusActionButtons(true);
				}
			);
			console.log("delete", selectedSequence_);
		}

		
		function editSequence()
		{
			// disable action buttons
			statusActionButtons(false);
			sequenceBuilding_ = true;
			// close active view
			tempSequence_ = selectedSequence_;
			selectSequence();
			showSequence("sequence-builder", tempSequence_);
			var builderActions = document.getElementById("sequence-builder-buttons");			
			builderActions.style.display = "flex";
			document.getElementById("sequenceName").value = document.getElementById("select-sequence").value;
		}

		function selectSequence(elem = "undefined")
		{
			var container = document.getElementById("show-sequence");
			
			// no sequence selected
			if (elem === "undefined")
			{
				// reset the list
				selectedSequence_ = {};
				showSequence("show-sequence", selectedSequence_)
				statusActionButtons(true);
				return;
			}

			// call the API
			DesktopContent.XMLHttpRequest("Request?RequestType=getSequence" +
				"&name=" + elem,
				"",
				function(req) {
					// request hendler
					Debug.log("loadMacroSequences() was called.");
					var sequenceString = DesktopContent.getXMLValue(req, "sequence");
					if (!sequenceString) 
					{
						Debug.log("Sequence is empty!");
						return;
					}
					selectedSequence_ = JSON.parse(decodeURI(sequenceString));

					// close the building if it is open
					closeSequence();
					// fill the list
					showSequence("show-sequence", selectedSequence_);
					// active buttons
					statusActionButtons(false);
				}
			);
		}
			
		function saveSequence()
		{
			var sequenceSelector = document.getElementById("select-sequence");
			var sequenceName = document.getElementById("sequenceName");
			var errorMessage = document.getElementById("sequenceName-error");

			// check if name is empty
			if (sequenceName.value === "")
			{
				errorMessage.innerText = "Sequence name cannot be empty!";
				return;
			}

			var invalidCharacters = /[<>:"/\\|?*]/;
			if (invalidCharacters.test(sequenceName.value))
			{
				errorMessage.innerText = "Sequence name contains invalid characters!";
				return;
			}

			// check if the name is unique 
			for (var i = 0; i < sequenceSelector.options.length; i++)
			{
				if (sequenceSelector.options[i].value === sequenceName.value)
				{
					errorMessage.innerText = "Name already in use!";
					return;
				}
			}

			// prepare the payload of the API call
			var postData = "sequence=" + encodeURI(JSON.stringify(tempSequence_)) + 
						   "&sequenceName=" + sequenceName.value;

			// API call
			DesktopContent.XMLHttpRequest("Request?RequestType=saveSequence",				
				postData, 
				function () {
					// update the select
					var option = document.createElement("option");
					option.text = sequenceName.value;
					option.value = sequenceName.value;
					sequenceSelector.add(option);
					selectSequence(sequenceName.value);
				},
				0 /*reqParam*/, 
				0 /*progressHandler*/, 
				true /*callHandlerOnErr*/
				
			);
			var sequenceNameInput = document.getElementById("sequenceName");
			sequenceNameInput.value = "";

			var errorMessage = document.getElementById("sequenceName-error");
			errorMessage.innerText = "";
			hidePopupSaveSequence()
			closeSequence();
		}

		function resetSequence()
		{
			// reset the container
			tempSequence_ = {};
			showSequence("sequence-builder", tempSequence_);
			
			// disable edit buttons
			statusEditButtons(false);
			
			console.log("reset", tempSequence_);
		}

		function closeSequence()
		{
			// reset the container
			tempSequence_ = {};
			showSequence("sequence-builder", tempSequence_);
			statusActionButtons(false);
			statusEditButtons(false);
			// hide the edit buttons
			var builderActions = document.getElementById("sequence-builder-buttons");			
			builderActions.style.display = "none";
			// stop building 
			sequenceBuilding_ = false;
			console.log("close", tempSequence_);
		}
		
		// TODO
		function testSequence()
		{
			console.log("test", tempSequence_);
		}
		
		// END ACTIONS

		// SEQUENCE CONTROL
		function appendMacroToSequence(macro)
		{			
			var index = Object.keys(tempSequence_).length;
			// activate buttons
			statusEditButtons(false);
			tempSequence_[index] = macro;
			showSequence("sequence-builder", tempSequence_);
			console.log("add", tempSequence_);
		}

		function moveUpSequence(index)
		{
			if (index === 0)
				return;
			var tempValue = tempSequence_[index];
			tempSequence_[index] = tempSequence_[index-1];
			tempSequence_[index-1] = tempValue;
			showSequence("sequence-builder", tempSequence_);
			console.log("up", tempSequence_);
			return;
		}
		
		function removeFromSequence(index)
		{
			delete tempSequence_[index]
			var i = 0;
			for (var key of Object.keys(tempSequence_))
			{
				if (i != key)
				{
					tempSequence_[i] = tempSequence_[key];
					
					delete tempSequence_[key];
				}
				i++;
			}
			showSequence("sequence-builder", tempSequence_);
			console.log("remove", tempSequence_);
			return
		}

		function moveDownSequence(index)
		{
			if (index === (Object.keys(tempSequence_).length-1))
				return;
			var tempValue = tempSequence_[index];
			tempSequence_[index] = tempSequence_[index+1];
			tempSequence_[index+1] = tempValue;
			showSequence("sequence-builder", tempSequence_);
			console.log("down", tempSequence_);
			return
		}
		
		function handleEnterPressSequence(event) 
		{
        if (event.key === "Enter" || event.keyCode === 13) {
            event.preventDefault();
            
            saveSequence();

            return false;
        }
        return true;
    	}    

		// END SEQUENCE CONTROL
		//=====================================================================================		
	</script>
		
</head>
	

<body onload='//init() called by DesktopContent.js' > <!--</body>onkeydown='handleKeyInput(event);'>	-->
		
	<!-- <center> -->
	
		<a href="#" onclick="toggleView()">Toggle View</a>
		<a href="#" onclick="toggleSequenceMode()">Sequence Mode</a><br>
		<div style='width:550px'></div>		

	<!--<a onclick='init();'>Refresh</a>
		<br>-->

	<div id="popupClearHistoryConfirm" class="smallPopup">
	    <h4>You will be clearing command history. Do you wish to continue?</h4>
	    <div class="buttongroup">
		  <center>
			<button onclick="clearHistory(this)">Yes, please</button>
			<button onclick="hideSmallPopup(this)">Cancel</button>
		  </center>
		</div>
	</div>

	<div id="popupSetInterval" class="smallPopup">
			<center>
		<h4>Please enter the interval time (sec):</h4>
		<input type="number" id="intervalTime" value="2" onkeypress="return handleEnterPress(event)">
		<div class="buttongroup" style="margin-top: 20px;">
				<button onclick="setIntervalAndStart()">Set Interval</button>
				<button onclick="hideSmallPopupLiveView(this)">Cancel</button>
		</div>
	</center>
	</div>

	<div id="popupSaveSequence" class="smallPopup">
		<center>
	    <h4>Type a name for the sequence</h4>
		<input type="text" id="sequenceName" maxlength="30" onkeypress="return handleEnterPressSequence(event)"></input>
		<span id="sequenceName-error" style="color: red; display: block;"></span>
	    <div class="buttongroup" style="margin-top: 20px;">
			<button onclick="saveSequence()">Confirm</button>
			<button onclick="hideSmallPopup(this)">Cancel</button>
		</center>
		</div>
	</div>

	<div id='display'></div>
	<!-- </center> -->
</body>
	
</html>

